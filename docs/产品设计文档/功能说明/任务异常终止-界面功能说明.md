# 任务异常终止 - 界面功能说明

> **参考模板**: 自规划任务执行助手 (template-planning-error)
> **创建时间**: 2025-12-24
> **任务场景**: 任务执行过程中遇到系统异常导致终止的展示

---

## 1. 界面布局概览

```
┌───────────────────────────────────────────────────────────────────────────┐
│                           智能体头部信息                                    │
├────────────┬──────────────────────────────────┬───────────────────────────┤
│            │                                  │                           │
│  左侧边栏   │       中间对话日志区域            │   右侧智能体工作区域       │
│  (220px)   │       (flex: 1)                  │   (320px)                 │
│            │                                  │                           │
│  - 新任务   │  - 任务意图识别                   │   [日志] [文件]           │
│  - 近期任务 │  - 任务执行规划                   │                           │
│  (失败标记) │  - 阶段执行详情                   │   - 异常终止任务清单       │
│            │  - 异常终止提示                   │   - 阶段进度看板(失败标记) │
│            │  - 最终回复(异常说明)             │   - 部分完成的文件         │
│            │                                  │                           │
└────────────┴──────────────────────────────────┴───────────────────────────┘
```

---

## 2. 异常状态标识

### 2.1 任务列表中的异常标记

**左侧近期任务列表：**

| 指标 | 说明 | 示例 |
|------|------|------|
| 状态图标 | 失败标识 | ❌ |
| 任务名称 | 失败任务的名称 | "源代码漏洞挖掘任务" |
| 视觉样式 | active 状态（当前查看） | 红色边框高亮 |

### 2.2 任务头部异常徽章

| 指标 | 说明 | 样式 |
|------|------|------|
| 任务标题 | 异常终止的任务名称 | "源代码漏洞挖掘任务" |
| 状态徽章 | 系统异常标识 | "系统异常" |
| 徽章颜色 | 红色警告样式 | 背景: #fee2e2, 文字: #dc2626 |
| 创建时间 | 任务创建时间 | 2025-12-24 14:30 |
| 重新开始按钮 | 重启任务按钮 | 🔄 重新开始 |

---

## 3. 中间对话日志区域

### 3.1 正常阶段展示（已完成）

**阶段 1: 工程功能模块分析**

| 组件 | 指标 | 说明 |
|------|------|------|
| **阶段头部** | 阶段徽章 | "阶段 1" |
| | 阶段标题 | "工程功能模块分析" |
| | 阶段状态 | ✓ 已完成 |
| | 视觉样式 | 绿色主题 |
| **思考事件** | 图标 | 💭 |
| | 内容 | "开始分析项目结构,识别核心功能模块..." |
| **工具调用** | 工具1 | 列出项目目录结构 (list_directory → src/) |
| | 工具2 | 读取配置文件 (read_file → application.yml) |
| **文档生成** | 图标 | 📄 |
| | 文档标题 | "生成工程功能模块分析总结" |
| | 文件信息 | 模块分析总结.md (8 KB) |

### 3.2 异常阶段展示（异常终止）

**阶段 2: 威胁建模与漏洞分析**

| 组件 | 指标 | 说明 |
|------|------|------|
| **阶段头部** | 阶段徽章 | "阶段 2" (红色背景: #dc2626) |
| | 阶段标题 | "威胁建模与漏洞分析" |
| | 阶段状态 | ❌ 异常终止 (红色文字) |
| | 边框样式 | 左侧红色边框 (3px solid #dc2626) |
| **思考事件** | 内容 | "基于模块分析结果,开始进行威胁建模和漏洞扫描..." |
| **工具调用** | 工具1 | 读取用户认证模块代码 (read_file → UserRepository.java) |
| | 工具2 | 读取安全配置 (read_file → SecurityConfig.java) |
| **漏洞发现** | 漏洞等级 | 高危 (红色徽章) |
| | 漏洞名称 | "SQL注入漏洞" |
| | 漏洞位置 | UserRepository.java:67 |
| | 漏洞描述 | "用户输入未经过滤直接拼接到SQL语句中" |

### 3.3 系统异常提示卡片

**异常提示框样式：**

| 指标 | 说明 | 样式 |
|------|------|------|
| 容器背景 | 浅红色背景 | #fee2e2 |
| 容器边框 | 红色边框 | 1px solid #dc2626 |
| 圆角 | 8px | - |
| 内边距 | 16px | - |

**异常提示内容：**

| 元素 | 内容 | 样式 |
|------|------|------|
| 警告图标 | ⚠️ | 字号: 20px |
| 标题 | "系统异常" | 字号: 14px, 粗体, 颜色: #dc2626 |
| 错误类型 | "内存溢出异常 (OutOfMemoryError)" | 字号: 13px, 颜色: #991b1b |
| 错误信息 | "分析大型代码文件时内存资源不足,任务被迫终止" | 字号: 13px, 颜色: #991b1b |

---

## 4. 最终回复 - 异常终止说明

### 4.1 回复卡片头部

| 指标 | 说明 | 样式 |
|------|------|------|
| 边框 | 左侧红色边框 | 3px solid #dc2626 |
| 标题图标 | ❌ | - |
| 标题文字 | "任务异常终止" | H3 标题 |

### 4.2 异常说明内容

**主要说明：**

| 模块 | 内容 | 格式 |
|------|------|------|
| 异常描述 | "非常抱歉,任务在执行**阶段 2: 威胁建模与漏洞分析**时遇到系统异常,无法继续完成。" | 段落文本 |

**已完成的工作：**

| 项目 | 说明 | 状态 |
|------|------|------|
| 工作项1 | 完成工程功能模块分析,生成分析总结文档 | ✓ |
| 工作项2 | 开始威胁建模,发现 1 个高危漏洞(SQL注入) | ✓ |

**异常原因：**

| 原因 | 说明 |
|------|------|
| 直接原因 | 在分析大型代码文件时发生内存溢出,系统资源不足 |
| 建议措施 | 建议优化代码分析策略或增加系统资源配置 |

### 4.3 部分完成的分析结果

**漏洞统计表：**

| 字段 | 说明 | 示例 |
|------|------|------|
| 漏洞名称 | 已发现的漏洞类型 | SQL注入漏洞 |
| 危险等级 | 漏洞等级徽章 | 高危 (红色) |
| 位置 | 代码文件和行号 | `UserRepository.java:67` |

**危险等级徽章样式：**

| 等级 | 类名 | 颜色方案 |
|------|------|----------|
| 高危 | severity-badge high | 背景: #fee2e2, 文字: #dc2626 |

### 4.4 已生成文档

**文档卡片：**

| 指标 | 说明 | 示例 |
|------|------|------|
| 文档图标 | 📋 | - |
| 文档标题 | "模块分析总结" | - |
| 文档元信息 | "1 个文件 · 8 KB" | 灰色文字 |
| 查看按钮 | "查看" | 主色按钮 |

### 4.5 操作建议提示

**建议提示框：**

| 指标 | 说明 | 样式 |
|------|------|------|
| 容器背景 | 黄色警告背景 | #fef3c7 |
| 容器边框 | 橙色边框 | 1px solid #d97706 |
| 提示图标 | 💡 | - |
| 提示标题 | "建议" (粗体) | - |
| 提示内容 | "您可以点击页面右上角的"重新开始"按钮重新执行此任务,或调整任务参数后再次尝试。" | 字号: 13px, 颜色: #92400e |

---

## 5. 右侧智能体工作区域

### 5.1 日志 Tab - 任务清单（异常状态）

**任务清单内容：**

| 任务项 | 状态 | 视觉样式 |
|--------|------|----------|
| 分析项目目录结构 | ✓ 已完成 | 绿色 |
| 读取项目配置文件 | ✓ 已完成 | 绿色 |
| 生成模块分析总结 | ✓ 已完成 | 绿色 |
| 扫描用户认证模块 | ✓ 已完成 | 绿色 |
| 分析安全配置 | ❌ 异常终止 | 背景: #fee2e2, 边框: #dc2626, 文字: #dc2626 |

**异常任务项样式：**

| 指标 | 说明 | 样式 |
|------|------|------|
| 背景色 | 浅红色 | #fee2e2 |
| 边框色 | 红色 | border-color: #dc2626 |
| 状态图标 | ❌ | - |
| 任务名称颜色 | 红色 | color: #dc2626 |
| 状态说明 | "(异常终止)" | 显示在任务名称后 |

### 5.2 阶段进度看板（异常状态）

**进度时间线：**

| 阶段 | 状态 | 视觉样式 |
|------|------|----------|
| 阶段1: 工程功能模块分析 | ✓ 已完成 | completed 类, 绿色 |
| 阶段2: 威胁建模与漏洞分析 | ❌ 异常终止 | failed + current 类, 红色 |

**失败阶段标记：**

| 指标 | 说明 | 样式 |
|------|------|------|
| CSS类 | failed current | - |
| 状态图标 | ❌ | - |
| 阶段名称 | "威胁建模与漏洞分析" | - |
| 标记颜色 | 红色主题 | - |

### 5.3 文件 Tab - 部分完成的文件

**文件目录树（异常任务）：**

```
📁 vulnex/                          # 项目根目录
└── 📁 项目记忆/                     # 已生成的部分文件
    └── 📄 模块分析总结.md (8 KB)     # 阶段1完成的文档
📁 user/                            # 用户上传文件
└── 📄 project.zip (2.5 MB)         # 原始项目文件
```

**特点说明：**

| 特点 | 说明 |
|------|------|
| 文件数量 | 仅包含异常前已完成的文件 |
| 目录结构 | 简化的目录树,缺少后续阶段应生成的文件 |
| 文件徽章 | 文件 Tab 的徽章数字为 "1" (仅1个已生成文档) |

---

## 6. 异常类型定义

### 6.1 系统异常类型

| 异常类型 | 错误代码 | 典型原因 | 展示示例 |
|----------|----------|----------|----------|
| 内存溢出 | OutOfMemoryError | 分析大型文件,系统资源不足 | "分析大型代码文件时内存资源不足,任务被迫终止" |
| 超时异常 | TimeoutError | 单个阶段执行时间过长 | "任务执行超时,系统自动终止以释放资源" |
| 工具调用失败 | ToolExecutionError | 工具执行异常或返回错误 | "工具调用失败,无法继续执行任务" |
| 文件访问失败 | FileAccessError | 无法读取/写入必要文件 | "无法访问关键文件,任务无法继续" |
| 网络连接失败 | NetworkError | 外部API调用失败 | "网络连接中断,任务被迫终止" |

### 6.2 异常展示规范

**异常卡片必需元素：**

| 元素 | 必需性 | 说明 |
|------|--------|------|
| 警告图标 | 必需 | ⚠️ |
| 异常标题 | 必需 | "系统异常" |
| 错误类型 | 必需 | 异常的技术名称 |
| 错误信息 | 必需 | 用户可理解的错误描述 |
| 建议措施 | 可选 | 针对性的解决建议 |

---

## 7. 交互功能

### 7.1 重新开始按钮

| 指标 | 说明 |
|------|------|
| 位置 | 任务头部右侧 |
| 按钮文字 | "🔄 重新开始" |
| 点击行为 | 清空当前任务状态,重新执行相同任务 |
| 状态保留 | 保留用户上传的文件和初始任务描述 |

### 7.2 部分结果查看

| 操作 | 效果 |
|------|------|
| 点击文档卡片 | 在右侧日志区显示已生成的文档内容 |
| 点击漏洞表格 | 展开漏洞详情(如果有) |
| 下载已生成文件 | 下载阶段1生成的部分文档 |

### 7.3 任务列表标记

| 操作 | 效果 |
|------|------|
| 点击失败任务 | 显示异常终止详情 |
| 悬停失败任务 | 显示失败原因提示 |

---

## 8. 视觉设计规范

### 8.1 异常状态颜色方案

| 元素 | 颜色 | 用途 |
|------|------|------|
| 主要背景 | #fee2e2 | 异常提示框背景 |
| 边框 | #dc2626 | 异常元素边框 |
| 主要文字 | #dc2626 | 异常标题文字 |
| 次要文字 | #991b1b | 异常描述文字 |
| 警告背景 | #fef3c7 | 建议提示框背景 |
| 警告边框 | #d97706 | 建议提示框边框 |
| 警告文字 | #92400e | 建议提示文字 |

### 8.2 状态图标映射

| 状态 | 图标 | 颜色 |
|------|------|------|
| 已完成 | ✓ / ✅ | 绿色 (#10b981) |
| 进行中 | 🔄 / ⏳ | 蓝色 (#3b82f6) |
| 异常终止 | ❌ | 红色 (#dc2626) |
| 系统警告 | ⚠️ | 橙色 (#d97706) |

---

## 9. 数据示例

### 9.1 异常任务完整示例

**任务基本信息：**

| 字段 | 值 |
|------|-----|
| 任务ID | task-001 |
| 任务名称 | 源代码漏洞挖掘任务 |
| 任务类型 | 代码安全审计 |
| 创建时间 | 2025-12-24 14:30 |
| 任务状态 | 异常终止 |
| 异常阶段 | 阶段2: 威胁建模与漏洞分析 |

**执行进度：**

| 阶段 | 状态 | 完成度 |
|------|------|--------|
| 阶段1: 工程功能模块分析 | 已完成 | 100% |
| 阶段2: 威胁建模与漏洞分析 | 异常终止 | 约30% |
| 阶段3: 分析总结报告生成 | 未开始 | 0% |

**部分成果：**

| 成果类型 | 数量 | 说明 |
|----------|------|------|
| 已生成文档 | 1个 | 模块分析总结.md (8 KB) |
| 已发现漏洞 | 1个 | SQL注入漏洞 (高危) |
| 已分析文件 | 3个 | 配置文件、认证模块、部分业务代码 |

---

## 10. 相关文件

| 文件类型 | 路径 |
|----------|------|
| HTML 模板 | `frontend/templates/pages/template-planning-error.html` |
| JavaScript | `frontend/templates/js/template-planning.js` |
| CSS 样式 | `frontend/templates/css/template-planning.css` |
| 详情样式 | `frontend/templates/css/template-detail.css` |

---

## 11. 技术实现要点

### 11.1 异常状态判断逻辑

```javascript
// 任务状态枚举
const TaskStatus = {
  RUNNING: 'running',
  COMPLETED: 'completed',
  FAILED: 'failed'
}

// 异常检测
if (task.status === TaskStatus.FAILED) {
  // 渲染异常UI
  renderErrorState(task.errorInfo)
}
```

### 11.2 异常数据结构

```javascript
{
  taskId: 'task-001',
  status: 'failed',
  errorInfo: {
    errorType: 'OutOfMemoryError',
    errorMessage: '分析大型代码文件时内存资源不足,任务被迫终止',
    failedPhase: 2,
    phaseName: '威胁建模与漏洞分析'
  },
  completedPhases: [1],
  partialResults: {
    documents: ['模块分析总结.md'],
    vulnerabilities: [
      {
        name: 'SQL注入漏洞',
        severity: 'high',
        location: 'UserRepository.java:67'
      }
    ]
  }
}
```

---

*文档版本: v1.0*
*最后更新: 2025-12-24*
