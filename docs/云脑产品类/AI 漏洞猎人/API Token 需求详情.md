# API Token 功能需求详情

## 1. 需求背景
- 平台需要为自动化脚本、CI/CD 流水线及本地 CLI 工具提供无需账户密码的鉴权方式。
- 通过 API Token 机制，支持用户自助创建、管理、吊销凭证，降低凭证泄露风险并满足合规要求。

## 2. 目标与范围
- **目标**：为已登录的合法用户提供 API Token 生命周期管理能力，并与 VulNex CLI、无极登录流程集成。
- **范围**：
  - 无极平台提供 Token 记录、创建、吊销能力。
  - 提供 API 供 CLI 执行鉴权。
  - 记录 Token 最近使用时间，便于审计与凭证清理。
  - 支持按 Token 粒度撤销权限，立即生效。

## 3. 用户角色与核心场景
- **安全工程师/测试工程师**：需要在自动化流水线中触发 VulNex 扫描，使用长期有效 Token。
- **本地 CLI 使用者**：通过 `vulnex login --token` 登录后运行 `vulnex run`、`vulnex download` 等命令。
- **管理员**：需要追踪 Token 使用情况，在凭证泄露时快速吊销。

## 4. 功能需求
### 4.1 Token 记录
- 无极展示当前用户所有 Token，包含 `创建时间`、`最近访问时间`、`状态（有效/已吊销）`。
- 显示 `最后访问时间` 默认为 Token 创建时刻，首次使用后更新。

### 4.2 新建 Token
- 用户点击“创建 Token”按钮。
- Token 创建成功后，仅在弹窗中一次性显示 Token 值，用户需手动复制保存。
- 创建成功时同步写入：
  - Token ID（系统唯一 UUID）
  - Token 哈希值（只存储哈希，使用 HMAC-SHA256）
  - 绑定用户 ID
  - 创建时间、更新时间

### 4.3 Token 删除

- 提供“删除”操作，用户确认后，该 Token 从系统中彻底作废，相关鉴权能力完全失效，等同于用户未创建 Token 的初始状态。
- 删除操作主要用于用户主动停用该 Token 功能（如不再需要使用 CLI/自动化等），与“重新生成”Token 不同，删除后不会生成新 Token，仅恢复为无 Token 状态。
- 删除后 UI 中不再展示该 Token 记录，且该 Token 不可被恢复；如需再次启用 Token 功能，用户需重新手动创建新的 Token。

### 4.4 Token 使用审计与重新生成

- 最近一次使用时间回写到 Token 列表，供用户判断是否仍在使用。
- 支持“Token 重新生成”功能，用户可对已存在的有效 Token 发起重新生成操作。重新生成时会使旧 Token 失效并生成一个新的 Token，仅在本次操作弹窗中一次性展示新 Token 值，需用户妥善保存。重新生成后的 Token 保持原有的属性（如备注、绑定的用户等），但 Token 哈希、创建时间、Token 明文会被更新。

### 4.5 CLI 集成要求
- CLI `vulnex login --token` 时，需要校验 Token
- CLI 在本地缓存 Token，需提示用户 Token 将明文保存在本地配置中，建议妥善保管。
- CLI 在命令请求时携带 Token，平台需支持基于 Token 的鉴权链路。


## 6. 权限与安全要求
- Token 仅绑定单一用户，具备与用户相同的资源权限。
- Token 在传输中防止明文传输

## 7. 异常与边界场景
- 创建 Token 时名称重复：提示更改。
- Token 已吊销仍被使用：返回 `401` 并提示凭证失效，同时写审计日志。
- 用户账号删除时需自动吊销所有 Token。


## 9. 验收标准
- 无极平台可成功创建、列出、吊销 Token，状态实时更新。
- 创建成功后仅一次性返回 Token 明文，刷新页面后不可见。
- CLI 可使用新 Token 登录并完成 VulNex 扫描、下载流程。
- 吊销 Token 后 CLI 再次调用时返回 `401` 并提示重新登录。


