# AI漏洞猎人任务重新发起功能设计

**关联Linear Issue**: [PDT-628](https://linear.app/clouditera2025/issue/PDT-628/ai-漏洞猎人异常终止的任务可以重新发起任务)
**创建日期**: 2025-12-24
**设计版本**: v1.0

---

## 一、功能概述

### 1.1 需求背景
AI漏洞猎人任务执行过程中可能因系统异常或人工干预而终止，当前缺乏任务重新发起机制，用户需要重新配置参数才能再次执行，体验不佳且容易出错。

### 1.2 功能目标
为异常终止的任务提供一键重新发起能力，支持从头执行或从中断点继续，提升任务执行的容错性和用户体验。

### 1.3 适用场景
- **系统异常导致任务终止**：网络故障、服务崩溃、资源不足等
- **人工手动终止**：用户主动取消任务

---

## 二、核心设计要素

### 2.1 可重新发起的任务状态

根据现有状态模型，以下状态的任务支持重新发起：

| 任务状态 | 终止原因 | 重新发起策略 |
|---------|---------|------------|
| **Failed（异常终止）** | 系统异常、执行错误、超时 | 支持从头执行或从中断阶段重试 |
| **Cancelled（人工终止）** | 用户主动取消 | 支持从头执行或从中断阶段继续 |

**不支持重新发起的状态：**
- **Completed（已完成）**：已成功完成，无需重新发起
- **Running（执行中）**：正在执行，不能重新发起（需先终止）

### 2.2 AI漏洞猎人执行阶段说明

AI漏洞猎人任务包含以下三个执行阶段：

1. **阶段1：项目结构分析**
   - 扫描项目目录结构
   - 识别编程语言和框架
   - 统计代码规模和入口点

2. **阶段2：风险分析与漏洞研判**
   - 执行安全风险扫描
   - 分析潜在漏洞点
   - 进行数据流分析和污点追踪

3. **阶段3：整理项目风险分析报告**
   - 汇总所有发现的风险
   - 生成结构化报告
   - 提供修复建议

### 2.3 重新发起模式设计

基于上述三阶段执行流程，设计两种重新发起模式：

#### 模式1：重新开始

**功能名称：** 重新开始
**提示文案：** 清空之前的执行结果，从项目结构分析阶段重新开始扫描

**适用场景：**
- 任务配置需要调整
- 目标代码已更新
- 用户希望清空之前的中间结果

**执行方式：**
- 在原任务上重新执行
- 保留原任务ID和配置参数
- 清空Checkpoint和中间产物
- 从阶段1（项目结构分析）重新开始

#### 模式2：继续执行

**功能名称：** 继续执行
**提示文案：** 保留已完成阶段的结果，从中断位置继续执行剩余阶段

**适用场景：**
- 临时性系统故障恢复
- 资源不足问题解决后继续

**执行方式：**
- 加载原任务的Checkpoint
- 保留已完成阶段的结果
- 从中断的阶段继续执行

**前置条件：**
- 原任务必须已保存Checkpoint
- Checkpoint数据完整且未过期（建议保留7天）

---

## 三、功能流程设计

### 3.1 重新发起触发入口

**唯一入口：任务详情页**

- **位置**：任务详情页顶部操作区
- **显示条件**：仅在Failed/Cancelled状态显示重新发起操作
- **交互方式**：根据是否有可用Checkpoint，提供不同的交互形式

#### 场景1：无可用Checkpoint
- 显示单个按钮：**[重新开始]**
- 按钮提示：鼠标悬停显示"清空之前的执行结果，从项目结构分析阶段重新开始扫描"
- 点击直接发起"重新开始"模式
- 后台检查配额，不足时toast提示

#### 场景2：有可用Checkpoint
- 显示带下拉菜单的按钮组：
  - 主按钮：**[继续执行]**（推荐，默认操作）
    - 按钮提示：鼠标悬停显示"保留已完成阶段的结果，从中断位置继续执行剩余阶段"
  - 下拉选项：**[重新开始]**
    - 选项提示：显示"清空之前的执行结果，从项目结构分析阶段重新开始扫描"
- 点击任一选项直接发起对应模式
- 后台检查配额，不足时toast提示

### 3.2 重新发起执行流程

简化的一键发起流程：

```
[用户操作] 点击重新发起按钮（或选择对应模式）
    ↓
[后台处理] 配额与授权检查
    ├─ 检查进阶智能体使用次数配额
    ├─ 检查每日Token使用量配额
    └─ 不足 → Toast提示配额不足，中止流程
    ↓
[后台处理] 任务重启处理
    ├─ 更新任务状态：Failed/Cancelled → Running
    ├─ 根据模式处理Checkpoint
    │   ├─ 从头执行：清空Checkpoint和中间结果
    │   └─ 从中断点继续：加载已保存的Checkpoint
    ├─ 记录重启次数（restart_count + 1）
    └─ 提交到任务队列重新执行
    ↓
[前端反馈] Toast提示任务已重新发起
    └─ 页面刷新，显示Running状态
```

**说明：**
- 在原任务上操作，不创建新任务
- 保留原任务ID和基本信息
- 现阶段不支持调整配置参数

### 3.3 执行状态同步

两种模式都在原任务上操作，不创建新任务：

#### 从头执行模式：
- **任务ID**：复用原任务ID
- **状态流转**：Failed/Cancelled → Running → Completed/Failed/Cancelled
- **数据处理**：清空Checkpoint和中间结果
- **执行起点**：从阶段1（项目结构分析）重新开始

#### 从中断点继续模式：
- **任务ID**：复用原任务ID
- **状态流转**：Failed/Cancelled → Running → Completed/Failed/Cancelled
- **数据处理**：加载已保存的Checkpoint
- **执行起点**：从中断的阶段继续执行，跳过已完成的阶段

---

## 四、Checkpoint机制设计

为支持"从中断点继续"，需要设计任务Checkpoint保存机制。

### 4.1 Checkpoint保存时机

**保存时机**：阶段完成时

每个阶段（项目结构分析、风险分析与漏洞研判）执行成功后，自动保存当前阶段的输出结果作为Checkpoint，用于后续从中断点继续执行。

---

## 五、用户交互设计

### 5.1 任务详情页按钮交互

#### 方案A：无可用Checkpoint（仅支持重新开始）

```
┌─────────────────────────────────────────────────────────────┐
│  任务详情                                                    │
│  ├─ 任务ID: TASK-20251224-001                              │
│  ├─ 状态: 异常终止                                          │
│  └─ 终止时间: 2025-12-24 10:30                             │
│                                                             │
│  [ 重新开始 ] ← 悬停提示：清空之前的执行结果，从项目         │
│                结构分析阶段重新开始扫描                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**交互说明：**
- 点击按钮 → 后台检查配额 → 直接发起"重新开始"模式
- 成功：Toast提示"任务已重新开始"，页面刷新显示Running状态
- 失败：Toast提示配额不足或其他错误信息

#### 方案B：有可用Checkpoint（支持两种模式）

```
┌─────────────────────────────────────────────────────────────┐
│  任务详情                                                    │
│  ├─ 任务ID: TASK-20251224-001                              │
│  ├─ 状态: 异常终止                                          │
│  ├─ 执行进度: 阶段2 已完成 45%                              │
│  └─ 终止时间: 2025-12-24 10:30                             │
│                                                             │
│  [ 继续执行 ▼ ] ← 悬停提示：保留已完成阶段的结果，从中断     │
│    └─ 下拉菜单：       位置继续执行剩余阶段                  │
│       ├─ 继续执行（推荐）                                    │
│       └─ 重新开始 ← 清空之前的执行结果，从项目结构分析       │
│                     阶段重新开始扫描                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**交互说明：**
- 主按钮默认操作：继续执行（推荐）
- 鼠标悬停主按钮/下拉选项时，显示对应的提示文案
- 点击任一选项 → 后台检查配额 → 直接发起对应模式
- 成功：Toast提示"任务已继续执行"或"任务已重新开始"
- 失败：Toast提示配额不足或其他错误信息

### 5.2 任务状态标识

| 任务状态 | 图标 | 说明 |
|---------|-----|------|
| **Failed（异常终止）** | ⚠️ | 显示异常原因tooltip |
| **Cancelled（人工终止）** | 🚫 | 显示终止原因和时间 |
| **Restarted** | 🔄 | 标注"第N次重试"标签 |

---

## 六、异常处理与边界情况

### 6.1 配额不足处理

#### 情况1：进阶智能体使用次数耗尽
- **检查时机**：用户点击重新发起，后台检查配额
- **提示方式**：Toast提示
- **提示文案**："本周使用次数已用完（10/10），下周一0点重置"
- **引导动作**：可提示联系管理员增加配额

#### 情况2：每日Token使用量不足
- **检查时机**：用户点击重新发起，后台检查配额
- **提示方式**：Toast提示
- **提示文案**："今日Token额度不足，预计需要500K，剩余200K"
- **引导动作**：建议明日再试或联系管理员

---

## 七、与现有功能的集成点

### 7.1 与授权系统集成
- 重新发起计入使用次数配额

---

## 附录：参考文档

### 相关需求文档
- `/云脑产品类/需求设计/AI漏洞猎人需求规划`
- `/云脑产品类/需求设计/本地命令行任务工具需求.md`
- `/云脑产品类/需求设计/AI漏洞猎人自然语言对话功能需求设计.md`
- `/云脑产品类/需求设计/使用次数与Token使用量授权.md`

### 相关技术文档
- `/云脑技术类/CortexFlow源代码漏洞挖掘技术实现.md`
- `/云脑产品类/漏洞验证执行智能体.md`
- `/云脑产品类/漏洞验证执行智能体-功能需求池.md`

---

**文档变更历史**

| 版本 | 日期 | 修改人 | 修改内容 |
|-----|------|--------|---------|
| v1.0 | 2025-12-24 | Claude Code | 初始版本创建 |
