<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PcapåŒ…åˆ†ææ™ºèƒ½ä½“ - æ™ºèƒ½ç½‘ç»œæ•°æ®åŒ…åˆ†ææœåŠ¡">
    <title>PcapåŒ…åˆ†æ | äº‘è„‘</title>
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/dashboard.css">
    <link rel="stylesheet" href="../../templates/css/template-detail.css">
    <link rel="stylesheet" href="../../components/agent-sidebar.css">
    <link rel="stylesheet" href="../../components/chat-input.css">
    <style>
        /* ==========================================
           æ–‡ä»¶ä¸Šä¼ ç»„ä»¶æ ·å¼
           ========================================== */
        
        .file-upload-container {
            width: 100%;
            margin: 0 auto;
            padding: 16px 24px 24px 24px;
            height: 280px;
            box-sizing: border-box;
        }
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .file-upload-area {
            border: 2px dashed var(--clouditera-neutral-border-primary);
            border-radius: 12px;
            padding: 48px 24px;
            text-align: center;
            background: var(--clouditera-neutral-background-white);
            cursor: pointer;
            transition: all 0.3s ease;
            height: 240px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        
        .file-upload-area:hover {
            border-color: var(--clouditera-brand-primary);
            background: var(--clouditera-neutral-background-secondary);
        }
        
        .file-upload-area.drag-over {
            border-color: var(--clouditera-brand-primary);
            background: var(--clouditera-brand-primary-light);
            border-style: solid;
        }
        
        .file-upload-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }
        
        .file-upload-text {
            color: var(--clouditera-neutral-text-primary);
        }
        
        .file-upload-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--clouditera-neutral-text-title);
            margin-bottom: 8px;
        }
        
        .file-upload-hint {
            font-size: 14px;
            color: var(--clouditera-neutral-text-secondary);
            margin-bottom: 8px;
        }
        
        .file-upload-action {
            font-size: 13px;
            color: var(--clouditera-brand-primary);
            margin-top: 8px;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .file-upload-action:hover {
            color: var(--clouditera-brand-primary-hover);
        }
        
        .file-upload-action:active {
            color: var(--clouditera-brand-primary-active);
        }
        
        /* æ–‡ä»¶ä¿¡æ¯å®¹å™¨ */
        .file-info-container {
            border: 2px solid var(--clouditera-neutral-border-primary);
            border-radius: 12px;
            padding: 20px;
            background: var(--clouditera-neutral-background-white);
            height: 240px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        
        .file-info-header {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }
        
        .file-info-icon {
            font-size: 40px;
            flex-shrink: 0;
        }
        
        .file-info-details {
            flex: 1;
            min-width: 0;
        }
        
        .file-info-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--clouditera-neutral-text-title);
            margin-bottom: 4px;
            word-break: break-all;
        }
        
        .file-info-size {
            font-size: 13px;
            color: var(--clouditera-neutral-text-secondary);
        }
        
        .file-remove-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--clouditera-neutral-background-tertiary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            color: var(--clouditera-neutral-text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .file-remove-btn:hover {
            background: var(--clouditera-neutral-background-quaternary);
            color: var(--clouditera-neutral-text-primary);
        }
        
        .file-info-actions {
            display: flex;
            justify-content: center;
            margin-top: 100px;
            flex-shrink: 0;
        }
        
        .btn-analyze {
            min-width: 160px;
            height: 40px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-analyze span {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* é”™è¯¯æç¤º */
        .file-upload-error {
            margin-top: 16px;
            padding: 12px 16px;
            background: #FEE2E2;
            border: 1px solid #FCA5A5;
            border-radius: 8px;
            color: #DC2626;
            font-size: 14px;
            text-align: center;
        }
        
        /* ==========================================
           åˆ†æç»“æœé¡µé¢æ ·å¼
           ========================================== */
        
        .analysis-view-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: var(--clouditera-neutral-background-white);
            overflow: hidden;
        }
        
        /* é¡¶éƒ¨å·¥å…·æ  */
        .analysis-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--clouditera-neutral-border-secondary);
            background: var(--clouditera-neutral-background-white);
            flex-shrink: 0;
            gap: 16px;
        }
        
        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }
        
        .toolbar-center {
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 0 0 auto;
        }
        
        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 0 0 auto;
        }
        
        .toolbar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border: 1px solid var(--clouditera-neutral-border-primary);
            background: var(--clouditera-neutral-background-white);
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            color: var(--clouditera-neutral-text-primary);
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover {
            border-color: var(--clouditera-brand-primary);
            color: var(--clouditera-brand-primary);
            background: var(--clouditera-palette-blue-0);
        }
        
        .toolbar-btn:active {
            background: var(--clouditera-neutral-background-tertiary);
        }
        
        .download-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .download-btn-primary {
            background: var(--clouditera-brand-primary);
            color: white;
        }
        
        .download-btn-primary:hover {
            background: var(--clouditera-brand-primary-hover);
        }
        
        .download-btn-secondary {
            background: var(--clouditera-neutral-background-secondary);
            color: var(--clouditera-neutral-text-primary);
            border: 1px solid var(--clouditera-neutral-border-primary);
        }
        
        .download-btn-secondary:hover {
            background: var(--clouditera-neutral-background-tertiary);
            border-color: var(--clouditera-brand-primary);
            color: var(--clouditera-brand-primary);
        }
        
        /* åˆ†æå†…å®¹åŒºåŸŸ */
        .analysis-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 32px 48px;
            background: var(--clouditera-neutral-background-white);
            line-height: 1.8;
            font-size: 14px;
            color: var(--clouditera-neutral-text-primary);
        }
        
        .analysis-content h1,
        .analysis-content h2,
        .analysis-content h3 {
            color: var(--clouditera-neutral-text-title);
            font-weight: 600;
            margin-top: 24px;
            margin-bottom: 16px;
        }
        
        .analysis-content h1 {
            font-size: 24px;
        }
        
        .analysis-content h2 {
            font-size: 20px;
        }
        
        .analysis-content h3 {
            font-size: 18px;
        }
        
        .analysis-content p {
            margin-bottom: 16px;
        }
        
        .analysis-content ul,
        .analysis-content ol {
            margin: 16px 0;
            padding-left: 32px;
        }
        
        .analysis-content li {
            margin-bottom: 8px;
        }
        
        .analysis-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }
        
        .stat-card {
            background: var(--clouditera-neutral-background-secondary);
            border: 1px solid var(--clouditera-neutral-border-primary);
            border-radius: 8px;
            padding: 16px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--clouditera-neutral-text-secondary);
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--clouditera-neutral-text-title);
        }
        
        /* å“åº”å¼ */
        @media (max-width: 992px) {
            .toolbar-left,
            .toolbar-center,
            .toolbar-right {
                gap: 8px;
            }
            
            .download-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .analysis-content {
                padding: 24px 32px;
            }
        }

        /* ==========================================
           å‘½ä»¤é€‰æ‹©æ‚¬æµ®é¢æ¿æ ·å¼
           ========================================== */
        
        /* å‘½ä»¤é¢æ¿å®¹å™¨ */
        .command-panel {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            background: var(--clouditera-neutral-background-white);
            border: 1px solid var(--clouditera-neutral-border-primary);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.1);
            width: 100%;
            max-width: 480px;
            max-height: 320px;
            overflow: hidden;
            display: none;
            flex-direction: column;
            z-index: 1000;
            animation: slideDown 0.2s ease;
        }

        .command-panel.show {
            display: flex;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* é¢æ¿æ ‡é¢˜ */
        .command-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--clouditera-neutral-border-secondary);
            font-size: 14px;
            font-weight: 600;
            color: var(--clouditera-neutral-text-title);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        /* é¢æ¿å…³é—­æŒ‰é’® */
        .command-panel-close {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--clouditera-neutral-text-secondary);
            font-size: 16px;
            padding: 0;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-left: auto;
        }

        .command-panel-close:hover {
            background: var(--clouditera-neutral-background-secondary);
            color: var(--clouditera-neutral-text-primary);
        }

        /* å‘½ä»¤åˆ—è¡¨å®¹å™¨ */
        .command-panel-content {
            padding: 8px;
            overflow-y: auto;
            flex: 1;
        }

        /* è¯¦æƒ…è§†å›¾å®¹å™¨ */
        .command-panel-detail {
            display: none;
            flex-direction: column;
        }

        .command-panel.detail-mode .command-panel-content {
            display: none;
        }

        .command-panel.detail-mode .command-panel-detail {
            display: flex;
        }

        /* è¯¦æƒ…è§†å›¾å¤´éƒ¨ */
        .command-detail-header {
            padding: 12px 16px 0 16px;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-shrink: 0;
        }

        .command-detail-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .command-detail-label {
            font-size: 13px;
            color: var(--clouditera-neutral-text-secondary);
        }

        .command-detail-name {
            display: inline-block;
            padding: 4px 10px;
            background: var(--clouditera-brand-primary);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .command-detail-category {
            font-size: 13px;
            color: var(--clouditera-neutral-text-secondary);
        }

        /* è¯¦æƒ…è§†å›¾å†…å®¹ */
        .command-detail-content {
            padding: 16px;
            font-size: 13px;
            color: var(--clouditera-neutral-text-primary);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* å‘½ä»¤è¯¦æƒ…è¾“å…¥æ¡† */
        .command-detail-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--clouditera-neutral-border-primary);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            color: var(--clouditera-neutral-text-primary);
            background: var(--clouditera-neutral-background-white);
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .command-detail-input:focus {
            outline: none;
            border-color: var(--clouditera-brand-primary);
            box-shadow: 0 0 0 2px var(--clouditera-palette-blue-0);
        }

        .command-detail-input::placeholder {
            color: var(--clouditera-neutral-text-secondary);
        }

        .command-detail-input:disabled {
            background: var(--clouditera-neutral-background-secondary);
            cursor: not-allowed;
        }

        /* éšè—è¾“å…¥æ¡†ï¼ˆé»˜è®¤ä¸æ˜¾ç¤ºï¼‰ */
        .command-detail-input.hidden {
            display: none;
        }

        /* å‘½ä»¤è¯¦æƒ…ä¸‹æ‹‰é€‰æ‹©æ¡† */
        .command-detail-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--clouditera-neutral-border-primary);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            color: var(--clouditera-neutral-text-primary);
            background: var(--clouditera-neutral-background-white);
            transition: all 0.2s;
            box-sizing: border-box;
            cursor: pointer;
        }

        .command-detail-select:focus {
            outline: none;
            border-color: var(--clouditera-brand-primary);
            box-shadow: 0 0 0 2px var(--clouditera-palette-blue-0);
        }

        .command-detail-select:disabled {
            background: var(--clouditera-neutral-background-secondary);
            cursor: not-allowed;
        }

        /* éšè—ä¸‹æ‹‰é€‰æ‹©æ¡†ï¼ˆé»˜è®¤ä¸æ˜¾ç¤ºï¼‰ */
        .command-detail-select.hidden {
            display: none;
        }

        /* å‘½ä»¤è¯¦æƒ…å¤é€‰æ¡† */
        .command-detail-checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .command-detail-checkbox {
            width: 16px;
            height: 16px;
            border: 1px solid var(--clouditera-neutral-border-primary);
            border-radius: 4px;
            background: var(--clouditera-neutral-background-white);
            cursor: pointer;
            position: relative;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .command-detail-checkbox:hover {
            border-color: var(--clouditera-brand-primary);
        }
        
        .command-detail-checkbox:has(input[type="checkbox"]:checked),
        .command-detail-checkbox.checked {
            border-color: var(--clouditera-brand-primary);
            background: var(--clouditera-brand-primary);
        }

        .command-detail-checkbox input[type="checkbox"] {
            width: 100%;
            height: 100%;
            margin: 0;
            opacity: 0;
            cursor: pointer;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        .command-detail-checkbox:has(input[type="checkbox"]:checked) .command-detail-checkbox-icon,
        .command-detail-checkbox.checked .command-detail-checkbox-icon {
            display: block;
        }

        .command-detail-checkbox-icon {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            line-height: 1;
            pointer-events: none;
        }

        .command-detail-checkbox-label {
            font-size: 14px;
            color: var(--clouditera-neutral-text-primary);
            user-select: none;
        }

        /* éšè—å¤é€‰æ¡†ï¼ˆé»˜è®¤ä¸æ˜¾ç¤ºï¼‰ */
        .command-detail-checkbox-wrapper.hidden {
            display: none;
        }

        /* å‘½ä»¤åˆ—è¡¨ */
        .command-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* å‘½ä»¤é¡¹ */
        .command-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            background: var(--clouditera-neutral-background-white);
            border: 1px solid transparent;
        }

        .command-item:hover {
            background: var(--clouditera-neutral-background-secondary);
            border-color: var(--clouditera-neutral-border-primary);
        }

        .command-item:active {
            background: var(--clouditera-neutral-background-tertiary);
        }

        .command-item.selected {
            background: var(--clouditera-palette-blue-0);
            border-color: var(--clouditera-brand-primary);
        }

        /* é€‰ä¸­æ—¶æ˜¾ç¤ºè¯¦æƒ…è§†å›¾ */
        .command-panel.detail-mode {
            max-height: 220px;
        }

        /* å‘½ä»¤åç§° */
        .command-name {
            display: inline-block;
            padding: 3px 8px;
            background: var(--clouditera-palette-blue-0);
            color: var(--clouditera-brand-primary);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            width: fit-content;
        }

        /* å‘½ä»¤æè¿° */
        .command-description {
            font-size: 12px;
            color: var(--clouditera-neutral-text-secondary);
            line-height: 1.5;
            margin: 0;
        }

        /* è¾“å…¥æ¡†åŒ…è£…å™¨éœ€è¦ç›¸å¯¹å®šä½ */
        .chat-input-wrapper {
            position: relative;
        }
    </style>
</head>
<body class="agent-detail-page">
    <!-- å·¦ä¾§ä¸»å¯¼èˆªæ  - æ™ºèƒ½ä½“è¯¦æƒ…é¡µæ¨¡å¼ï¼ˆæ”¶èµ·ï¼‰ -->
    <aside class="sidebar collapsed" id="sidebar">
        <!-- Logo åŒº -->
        <div class="sidebar-logo">
            <a href="../../dashboard.html" class="logo-link" title="äº‘è„‘">
                <div class="logo-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="6" fill="#2563EB"/>
                        <path d="M16 8L20 14H12L16 8Z" fill="white"/>
                        <path d="M10 18L14 24H6L10 18Z" fill="white" opacity="0.8"/>
                        <path d="M22 18L26 24H18L22 18Z" fill="white" opacity="0.8"/>
                    </svg>
                </div>
                <h1 class="logo-text">äº‘è„‘</h1>
            </a>
        </div>

        <!-- ä¸»å¯¼èˆªèœå• -->
        <div class="sidebar-content">
            <nav class="sidebar-nav">
                <!-- é¦–é¡µ - å¸¦æ”¶è—å¿«æ·å…¥å£ -->
                <div class="nav-item-home-wrapper">
                    <a href="../../dashboard.html" class="nav-item nav-item-home" title="é¦–é¡µ">
                        <span class="nav-icon">ğŸ </span>
                        <span class="nav-text">é¦–é¡µ</span>
                    </a>
                    <div class="home-menu" id="homeMenu">
                        <a href="../../dashboard.html" class="home-menu-favorite-item">
                            <span class="home-menu-favorite-icon">ğŸ </span>
                            <span class="home-menu-favorite-name">é¦–é¡µ</span>
                        </a>
                        <div class="home-menu-favorites" id="homeMenuFavorites">
                            <div class="home-menu-favorites-empty" id="homeMenuFavoritesEmpty" style="display: none;">
                                <p class="home-menu-empty-text">æš‚æ— æ”¶è—</p>
                            </div>
                            <div class="home-menu-favorites-list" id="homeMenuFavoritesList"></div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- åº•éƒ¨å¯¼èˆª -->
            <nav class="sidebar-nav-bottom">
                <a href="../../templates.html" class="nav-item" title="UIæ¨¡æ¿">
                    <span class="nav-icon">ğŸ“</span>
                    <span class="nav-text">UIæ¨¡æ¿</span>
                </a>

                <a href="#" class="nav-item" title="å¸®åŠ©ä¸­å¿ƒ">
                    <span class="nav-icon">â“</span>
                    <span class="nav-text">å¸®åŠ©ä¸­å¿ƒ</span>
                </a>

                <a href="#" class="nav-item" title="ç”¨æˆ·åé¦ˆ">
                    <span class="nav-icon">ğŸ’¬</span>
                    <span class="nav-text">ç”¨æˆ·åé¦ˆ</span>
                </a>

                <div class="nav-item-user-wrapper">
                    <a href="#" class="nav-item nav-item-user" id="userNavItem" title="ä¸ªäººä¸­å¿ƒ">
                        <div class="user-avatar" id="userAvatar">T</div>
                        <span class="user-name" id="userName">æµ‹è¯•ç”¨æˆ·</span>
                    </a>
                    <div class="user-menu" id="userMenu">
                        <a href="../../pages/user-management.html" class="user-menu-item">
                            <span class="nav-icon">ğŸ‘¤</span>
                            <span class="nav-text">ä¸ªäººä¸­å¿ƒ</span>
                        </a>
                        <button class="user-menu-item nav-item-logout" id="logoutBtn">
                            <span class="nav-icon">ğŸšª</span>
                            <span class="nav-text">é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content-area">
        <!-- æ™ºèƒ½ä½“å¤´éƒ¨ä¿¡æ¯ -->
        <div class="agent-header">
            <div class="agent-header-main">
                <div class="agent-icon">ğŸ“¦</div>
                <div class="agent-info">
                    <div class="agent-title-wrapper">
                        <h2 class="agent-title">PcapåŒ…åˆ†æ</h2>
                        <span class="agent-type">åŸºç¡€ç±»</span>
                        <span class="agent-version">v1.1.0</span>
                    </div>
                    <p class="agent-description">æ™ºèƒ½åˆ†æç½‘ç»œæ•°æ®åŒ…ï¼Œè¯†åˆ«å¼‚å¸¸æµé‡å’Œæ½œåœ¨å¨èƒï¼Œæä¾›è¯¦ç»†çš„ç½‘ç»œè¡Œä¸ºåˆ†æå’Œå®‰å…¨è¯„ä¼°æŠ¥å‘Š</p>
                </div>
            </div>
            <!-- ç®¡ç†åŠŸèƒ½æŒ‰é’®ç»„ -->
            <div class="agent-header-actions">
                <button class="btn-agent-action" title="çŸ¥è¯†åº“">
                    <span class="action-icon">ğŸ“š</span>
                    <span class="action-text">çŸ¥è¯†åº“</span>
                    <span class="action-count">(12)</span>
                </button>
                <button class="btn-agent-action" title="å·¥å…·æ’ä»¶">
                    <span class="action-icon">ğŸ”§</span>
                    <span class="action-text">å·¥å…·æ’ä»¶</span>
                    <span class="action-count">(3)</span>
                </button>
                <button class="btn-agent-action" title="æ™ºèƒ½ä½“è®¾ç½®">
                    <span class="action-icon">âš™ï¸</span>
                    <span class="action-text">è®¾ç½®</span>
                </button>
                <button class="btn btn-primary btn-sm">
                    <span>ğŸ”—</span>
                    <span>åˆ†äº«</span>
                </button>
            </div>
        </div>

        <!-- å†…å®¹å®¹å™¨ -->
        <div class="content-container">
            <!-- æ™ºèƒ½ä½“è¯¦æƒ…ä¾§å¯¼èˆª -->
            <aside class="agent-sidebar">
                <nav class="agent-nav">
                    <!-- æ–°ä»»åŠ¡æŒ‰é’® -->
                    <button class="btn-new-chat">
                        <span class="btn-icon">âœ¨</span>
                        <span class="btn-text">æ–°ä»»åŠ¡</span>
                    </button>

                    <!-- è¿‘æœŸä»»åŠ¡ -->
                    <div class="nav-group">
                        <div class="nav-group-title">è¿‘æœŸä»»åŠ¡</div>

                        <!-- è¿‘æœŸä»»åŠ¡åˆ—è¡¨ -->
                        <div class="recent-tasks-list">
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon running">â³</span>
                                <div class="task-name">ç½‘ç»œæµé‡åˆ†æ</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon running">â³</span>
                                <div class="task-name">å¼‚å¸¸æµé‡æ£€æµ‹</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">DDoSæ”»å‡»åˆ†æ</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">æ¶æ„è½¯ä»¶é€šä¿¡åˆ†æ</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">ç½‘ç»œåè®®åˆ†æ</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">æ•°æ®æ³„éœ²æ£€æµ‹</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">ç«¯å£æ‰«ææ£€æµ‹</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">ç½‘ç»œå…¥ä¾µåˆ†æ</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">æµé‡ç‰¹å¾æå–</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">å®‰å…¨äº‹ä»¶å…³è”åˆ†æ</div>
                            </a>
                        </div>

                        <!-- æŸ¥çœ‹å…¨éƒ¨å…¥å£ -->
                        <a href="#" class="view-all-tasks">
                            æŸ¥çœ‹å…¨éƒ¨ä»»åŠ¡è®°å½• â†’
                        </a>
                    </div>
                </nav>
            </aside>

            <!-- ä¸»å†…å®¹åŒºåŸŸ - ç©ºçŠ¶æ€ -->
            <div class="agent-main-content">
                <div class="empty-state-container">
                    <!-- æ™ºèƒ½ä½“åç§° - ä¼˜å…ˆçº§æœ€é«˜ -->
                    <div class="empty-agent-name">
                        <span class="agent-name-text">PcapåŒ…åˆ†æ</span>
                    </div>

                    <!-- å¼•å¯¼æ–‡æ¡ˆ - æ¬¡è¦ä¼˜å…ˆçº§ -->
                    <div class="empty-state-guide">
                        <p class="empty-state-guide-text">ä¸Šä¼ Pcapæ–‡ä»¶ï¼Œå¼€å§‹æ™ºèƒ½åˆ†æ</p>
                    </div>

                    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                    <div class="file-upload-container" id="fileUploadContainer">
                        <!-- ä¸Šä¼ åŒºåŸŸ -->
                        <div class="file-upload-area" id="fileUploadArea">
                            <input type="file" id="fileInput" accept=".pcap,.pcapng,.cap" style="display: none;">
                            <div class="file-upload-icon">ğŸ“¦</div>
                            <div class="file-upload-text">
                                <p class="file-upload-title">ä¸Šä¼ Pcapæ–‡ä»¶</p>
                                <p class="file-upload-hint">æ”¯æŒå•ä¸ª.pcapå’Œ.pcapngå’Œ.capæ–‡ä»¶ï¼Œå¤§å°ä¸è¶…è¿‡100M</p>
                                <p class="file-upload-action">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>
                            </div>
                        </div>
                        
                        <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸï¼ˆä¸Šä¼ åæ˜¾ç¤ºï¼‰ -->
                        <div class="file-info-container" id="fileInfoContainer" style="display: none;">
                            <div class="file-info-header">
                                <div class="file-info-icon">ğŸ“¦</div>
                                <div class="file-info-details">
                                    <div class="file-info-name" id="fileName"></div>
                                    <div class="file-info-size" id="fileSize"></div>
                                </div>
                                <button class="file-remove-btn" id="fileRemoveBtn" title="ç§»é™¤æ–‡ä»¶">âœ•</button>
                            </div>
                            <div class="file-info-actions">
                                <button class="btn btn-primary btn-analyze" id="btnAnalyze">
                                    <span>å¼€å§‹åˆ†æ</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- é”™è¯¯æç¤º -->
                        <div class="file-upload-error" id="fileUploadError" style="display: none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../../js/dashboard.js"></script>
    <script src="../../components/agent-sidebar.js"></script>
    <script src="../../components/chat-input.js"></script>
    <script>
        // ==========================================
        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        // ==========================================
        
        const MAX_FILE_SIZE = 100 * 1024 * 1024; // 100MB
        let selectedFile = null;
        
        // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function initFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInfoContainer = document.getElementById('fileInfoContainer');
            const fileRemoveBtn = document.getElementById('fileRemoveBtn');
            const btnAnalyze = document.getElementById('btnAnalyze');
            const fileUploadError = document.getElementById('fileUploadError');
            
            // ç‚¹å‡»ä¸Šä¼ åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
            fileUploadArea.addEventListener('click', function() {
                fileInput.click();
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', function(e) {
                handleFileSelect(e.target.files[0]);
            });
            
            // æ‹–æ‹½ä¸Šä¼ 
            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.add('drag-over');
            });
            
            fileUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.remove('drag-over');
            });
            
            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                fileUploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
            
            // ç§»é™¤æ–‡ä»¶
            fileRemoveBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                resetFileUpload();
            });
            
            // å¼€å§‹åˆ†ææŒ‰é’®
            btnAnalyze.addEventListener('click', function() {
                if (selectedFile) {
                    startAnalysis(selectedFile);
                }
            });
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(file) {
            if (!file) return;
            
            // éšè—é”™è¯¯æç¤º
            const fileUploadError = document.getElementById('fileUploadError');
            fileUploadError.style.display = 'none';
            
            // éªŒè¯æ–‡ä»¶æ ¼å¼
            const validExtensions = ['.pcap', '.pcapng', '.cap'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!validExtensions.includes(fileExtension)) {
                showError('åªæ”¯æŒ .pcapã€.pcapng å’Œ .cap æ ¼å¼çš„æ–‡ä»¶');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶å¤§å°
            if (file.size > MAX_FILE_SIZE) {
                showError('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 100M');
                return;
            }
            
            // ä¿å­˜æ–‡ä»¶å¹¶æ˜¾ç¤ºä¿¡æ¯
            selectedFile = file;
            displayFileInfo(file);
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        function displayFileInfo(file) {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInfoContainer = document.getElementById('fileInfoContainer');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            
            // éšè—ä¸Šä¼ åŒºåŸŸï¼Œæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            fileUploadArea.style.display = 'none';
            fileInfoContainer.style.display = 'block';
            
            // æ˜¾ç¤ºæ–‡ä»¶åå’Œå¤§å°
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // æ˜¾ç¤ºé”™è¯¯æç¤º
        function showError(message) {
            const fileUploadError = document.getElementById('fileUploadError');
            fileUploadError.textContent = message;
            fileUploadError.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(function() {
                fileUploadError.style.display = 'none';
            }, 3000);
        }
        
        // é‡ç½®æ–‡ä»¶ä¸Šä¼ 
        function resetFileUpload() {
            selectedFile = null;
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInfoContainer = document.getElementById('fileInfoContainer');
            const fileUploadError = document.getElementById('fileUploadError');
            
            fileInput.value = '';
            // ç§»é™¤å¯èƒ½å½±å“æ ·å¼çš„ç±»
            fileUploadArea.classList.remove('drag-over');
            // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
            fileUploadArea.style.display = 'flex';
            fileInfoContainer.style.display = 'none';
            fileUploadError.style.display = 'none';
        }
        
        // å¼€å§‹åˆ†æ
        function startAnalysis(file) {
            console.log('å¼€å§‹åˆ†ææ–‡ä»¶:', file.name);
            
            // ç”Ÿæˆä»»åŠ¡IDå’Œåç§°
            const taskId = 'task-' + Date.now();
            const taskName = file.name.replace(/\.(pcap|pcapng|cap)$/i, '') + ' - PcapåŒ…åˆ†æ';
            
            // åˆ›å»ºæ–°ä»»åŠ¡æ•°æ®
            const newTask = {
                id: taskId,
                name: taskName,
                status: 'running',
                active: true,
                fileName: file.name,
                fileSize: file.size
            };
            
            // å°†æ–°ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡åˆ—è¡¨å¼€å¤´
            mockTasks.unshift(newTask);
            
            // å¦‚æœä¾§è¾¹æ å®ä¾‹å­˜åœ¨ï¼Œæ›´æ–°ä»»åŠ¡åˆ—è¡¨
            if (window.agentSidebarInstance) {
                if (typeof window.agentSidebarInstance.updateTasks === 'function') {
                    window.agentSidebarInstance.updateTasks(mockTasks);
                } else if (typeof window.agentSidebarInstance.addTask === 'function') {
                    window.agentSidebarInstance.addTask(newTask);
                }
                // è®¾ç½®æ–°ä»»åŠ¡ä¸ºæ´»åŠ¨ä»»åŠ¡
                if (typeof window.agentSidebarInstance.setActiveTask === 'function') {
                    window.agentSidebarInstance.setActiveTask(newTask.id);
                }
            }
            
            // æ˜¾ç¤ºåˆ†æç»“æœé¡µé¢
            showAnalysisView(newTask, file);
        }
        
        // æ˜¾ç¤ºåˆ†æç»“æœé¡µé¢
        function showAnalysisView(task, file) {
            const chatArea = document.querySelector('.agent-main-content');
            if (!chatArea) return;
            
            // æ¨¡æ‹Ÿåˆ†æç»“æœ
            const analysisResult = getMockAnalysisResult();
            
            // åˆ›å»ºåˆ†æç»“æœé¡µé¢HTML
            const analysisHTML = `
                <div class="analysis-view-container">
                    <!-- é¡¶éƒ¨å·¥å…·æ  -->
                    <div class="analysis-toolbar">
                        <div class="toolbar-left">
                            <button class="toolbar-btn" title="å¯¼å‡º">ğŸ“¥</button>
                            <button class="toolbar-btn" title="æœç´¢">ğŸ”</button>
                        </div>
                        <div class="toolbar-center">
                            <span style="font-size: 14px; color: var(--clouditera-neutral-text-secondary);">åˆ†æå®Œæˆ</span>
                        </div>
                        <div class="toolbar-right">
                            <button class="download-btn download-btn-primary" id="btnDownloadReport">
                                <span>ä¸‹è½½åˆ†ææŠ¥å‘Š</span>
                            </button>
                            <button class="download-btn download-btn-secondary" id="btnDownloadRaw">
                                <span>å¯¼å‡ºåŸå§‹æ•°æ®</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- åˆ†æå†…å®¹åŒºåŸŸ -->
                    <div class="analysis-content" id="analysisContent">
                        ${analysisResult}
                    </div>
                </div>
            `;
            
            // æ›¿æ¢å†…å®¹
            chatArea.innerHTML = analysisHTML;
            
            // åˆå§‹åŒ–åˆ†æé¡µé¢åŠŸèƒ½
            initAnalysisView();
        }
        
        // åˆå§‹åŒ–åˆ†æé¡µé¢åŠŸèƒ½
        function initAnalysisView() {
            // ä¸‹è½½æŒ‰é’®
            const btnDownloadReport = document.getElementById('btnDownloadReport');
            const btnDownloadRaw = document.getElementById('btnDownloadRaw');
            
            if (btnDownloadReport) {
                btnDownloadReport.addEventListener('click', function() {
                    alert('ä¸‹è½½åˆ†ææŠ¥å‘ŠåŠŸèƒ½å¼€å‘ä¸­...');
                    // TODO: å®ç°ä¸‹è½½åˆ†ææŠ¥å‘Š
                });
            }
            
            if (btnDownloadRaw) {
                btnDownloadRaw.addEventListener('click', function() {
                    alert('å¯¼å‡ºåŸå§‹æ•°æ®åŠŸèƒ½å¼€å‘ä¸­...');
                    // TODO: å®ç°å¯¼å‡ºåŸå§‹æ•°æ®
                });
            }
        }
        
        // æ¨¡æ‹Ÿåˆ†æç»“æœ
        function getMockAnalysisResult() {
            return `
                <h1>ç½‘ç»œæ•°æ®åŒ…åˆ†ææŠ¥å‘Š</h1>
                
                <div class="analysis-stats">
                    <div class="stat-card">
                        <div class="stat-label">æ€»æ•°æ®åŒ…æ•°</div>
                        <div class="stat-value">12,458</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æ€»æµé‡</div>
                        <div class="stat-value">45.2 MB</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">åè®®ç±»å‹</div>
                        <div class="stat-value">8 ç§</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">å¼‚å¸¸æµé‡</div>
                        <div class="stat-value">23 ä¸ª</div>
                    </div>
                </div>
                
                <h2>1. æµé‡æ¦‚è§ˆ</h2>
                <p>æœ¬æ¬¡åˆ†æå…±æ•è· 12,458 ä¸ªæ•°æ®åŒ…ï¼Œæ€»æµé‡ä¸º 45.2 MBã€‚æ•°æ®åŒ…æ—¶é—´è·¨åº¦ä» 2025-01-15 10:23:15 åˆ° 2025-01-15 10:45:32ï¼ŒæŒç»­æ—¶é—´ä¸º 22 åˆ† 17 ç§’ã€‚</p>
                
                <h2>2. åè®®åˆ†å¸ƒ</h2>
                <ul>
                    <li><strong>TCP</strong>: 8,234 ä¸ªæ•°æ®åŒ… (66.1%)</li>
                    <li><strong>UDP</strong>: 3,156 ä¸ªæ•°æ®åŒ… (25.3%)</li>
                    <li><strong>HTTP</strong>: 892 ä¸ªæ•°æ®åŒ… (7.2%)</li>
                    <li><strong>HTTPS</strong>: 156 ä¸ªæ•°æ®åŒ… (1.3%)</li>
                    <li><strong>DNS</strong>: 1,020 ä¸ªæ•°æ®åŒ… (8.2%)</li>
                </ul>
                
                <h2>3. å¼‚å¸¸æµé‡æ£€æµ‹</h2>
                <p>æ£€æµ‹åˆ° 23 ä¸ªå¼‚å¸¸æµé‡äº‹ä»¶ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
                <ul>
                    <li><strong>ç«¯å£æ‰«ææ´»åŠ¨</strong>: æ£€æµ‹åˆ°æ¥è‡ª 192.168.1.100 çš„ç«¯å£æ‰«æè¡Œä¸ºï¼Œæ‰«æäº† 1,234 ä¸ªç«¯å£</li>
                    <li><strong>å¼‚å¸¸DNSæŸ¥è¯¢</strong>: å‘ç° 15 ä¸ªå¯ç–‘çš„DNSæŸ¥è¯¢ï¼Œæ¶‰åŠæ¶æ„åŸŸå</li>
                    <li><strong>å¤§æµé‡ä¼ è¾“</strong>: æ£€æµ‹åˆ°å¼‚å¸¸çš„å¤§æ–‡ä»¶ä¼ è¾“ï¼Œä» 10.0.0.5 åˆ°å¤–éƒ¨æœåŠ¡å™¨</li>
                    <li><strong>åè®®å¼‚å¸¸</strong>: å‘ç° 3 ä¸ªéæ ‡å‡†åè®®æ•°æ®åŒ…</li>
                </ul>
                
                <h2>4. å®‰å…¨å¨èƒè¯„ä¼°</h2>
                <p><strong>å¨èƒç­‰çº§</strong>: ä¸­ç­‰</p>
                <p>åˆ†æå‘ç°ä»¥ä¸‹æ½œåœ¨å®‰å…¨å¨èƒï¼š</p>
                <ul>
                    <li>ç–‘ä¼¼ç«¯å£æ‰«ææ”»å‡»ï¼Œå»ºè®®æ£€æŸ¥ 192.168.1.100 ä¸»æœº</li>
                    <li>å­˜åœ¨å¯ç–‘DNSæŸ¥è¯¢ï¼Œå»ºè®®æ£€æŸ¥DNSæœåŠ¡å™¨é…ç½®</li>
                    <li>æ£€æµ‹åˆ°å¼‚å¸¸æ•°æ®ä¼ è¾“ï¼Œå»ºè®®å®¡æŸ¥ 10.0.0.5 ä¸»æœºçš„ç½‘ç»œæ´»åŠ¨</li>
                </ul>
                
                <h2>5. ç½‘ç»œè¡Œä¸ºåˆ†æ</h2>
                <p>ç½‘ç»œæµé‡æ˜¾ç¤ºæ­£å¸¸çš„ä¸šåŠ¡é€šä¿¡å ä¸»å¯¼åœ°ä½ï¼Œä½†å­˜åœ¨å°‘é‡å¼‚å¸¸æ´»åŠ¨ã€‚ä¸»è¦é€šä¿¡æ¨¡å¼åŒ…æ‹¬ï¼š</p>
                <ul>
                    <li>HTTP/HTTPS ç½‘é¡µæµè§ˆæ´»åŠ¨</li>
                    <li>DNS åŸŸåè§£æè¯·æ±‚</li>
                    <li>TCP è¿æ¥å»ºç«‹å’Œç»´æŠ¤</li>
                    <li>å°‘é‡ UDP æ•°æ®ä¼ è¾“</li>
                </ul>
                
                <h2>6. å»ºè®®æªæ–½</h2>
                <ol>
                    <li>ç«‹å³æ£€æŸ¥ 192.168.1.100 ä¸»æœºçš„å®‰å…¨çŠ¶æ€ï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨æ¶æ„è½¯ä»¶</li>
                    <li>å®¡æŸ¥ DNS æŸ¥è¯¢æ—¥å¿—ï¼Œè¯†åˆ«å¯ç–‘åŸŸåè®¿é—®</li>
                    <li>ç›‘æ§ 10.0.0.5 ä¸»æœºçš„ç½‘ç»œæ´»åŠ¨ï¼Œç¡®è®¤æ•°æ®ä¼ è¾“çš„åˆæ³•æ€§</li>
                    <li>åŠ å¼ºç½‘ç»œè¾¹ç•Œé˜²æŠ¤ï¼Œé™åˆ¶ä¸å¿…è¦çš„ç«¯å£è®¿é—®</li>
                    <li>å®šæœŸè¿›è¡Œç½‘ç»œæµé‡åˆ†æï¼ŒåŠæ—¶å‘ç°å¼‚å¸¸è¡Œä¸º</li>
                </ol>
            `;
        }
        
        // ==========================================
        // åŸæœ‰ä»£ç 
        // ==========================================
        // æ¨¡æ‹Ÿä»»åŠ¡æ•°æ®
        const mockTasks = [
            { id: '1', name: 'ç½‘ç»œæµé‡åˆ†æ', status: 'running', active: false },
            { id: '2', name: 'å¼‚å¸¸æµé‡æ£€æµ‹', status: 'running', active: false },
            { id: '3', name: 'DDoSæ”»å‡»åˆ†æ', status: 'completed', active: false },
            { id: '4', name: 'æ¶æ„è½¯ä»¶é€šä¿¡åˆ†æ', status: 'completed', active: false },
            { id: '5', name: 'ç½‘ç»œåè®®åˆ†æ', status: 'completed', active: false },
            { id: '6', name: 'æ•°æ®æ³„éœ²æ£€æµ‹', status: 'completed', active: false },
            { id: '7', name: 'ç«¯å£æ‰«ææ£€æµ‹', status: 'completed', active: false },
            { id: '8', name: 'ç½‘ç»œå…¥ä¾µåˆ†æ', status: 'completed', active: false },
            { id: '9', name: 'æµé‡ç‰¹å¾æå–', status: 'completed', active: false },
            { id: '10', name: 'å®‰å…¨äº‹ä»¶å…³è”åˆ†æ', status: 'completed', active: false }
        ];

        // å¤„ç†ä»»åŠ¡ç‚¹å‡»çš„é€šç”¨å‡½æ•°
        function handleTaskClick(taskId, taskData) {
            console.log('[DEBUG] handleTaskClick è¢«è°ƒç”¨:', taskId, taskData);

            try {
                // æ›´æ–°ä»»åŠ¡é¡¹çš„ active çŠ¶æ€
                var recentTaskItems = document.querySelectorAll('.recent-task-item');
                recentTaskItems.forEach(function(item) {
                    var taskName = item.querySelector('.task-name');
                    if (taskName && taskName.textContent.trim() === taskData.name) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                var chatArea = document.querySelector('.agent-main-content');
                if (!chatArea) {
                    console.error('[DEBUG] æœªæ‰¾åˆ°chatArea');
                    return;
                }

                console.log('[DEBUG] æ‰¾åˆ°chatArea');

                // æ¸…ç©ºchatAreaå†…å®¹ï¼Œé‡æ–°åˆ›å»ºä»»åŠ¡è¯¦æƒ…
                var taskName = (taskData && taskData.name) ? taskData.name : 'æœªçŸ¥ä»»åŠ¡';

                // æ¸…ç©ºchatAreaå¹¶é‡æ–°åˆ›å»ºä»»åŠ¡è¯¦æƒ…
                chatArea.innerHTML = '';

                var taskContent = document.createElement('div');
                taskContent.className = 'task-detail-content';

                taskContent.innerHTML = '<div class="chat-header">' +
                    '<div class="chat-title">' + taskName + '</div>' +
                    '<div class="chat-time">åˆšåˆš</div>' +
                '</div>' +
                '<div class="chat-messages">' +
                    '<div class="message message-user">' +
                        '<div class="message-avatar">ğŸ‘¤</div>' +
                        '<div class="message-content">' +
                            '<div class="message-time">åˆšåˆš</div>' +
                            '<div class="message-text">è¯·å¸®æˆ‘åˆ†æè¿™ä¸ªPcapæ–‡ä»¶ä¸­çš„å¼‚å¸¸æµé‡ã€‚</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="message message-ai">' +
                        '<div class="message-avatar">ğŸ¤–</div>' +
                        '<div class="message-content">' +
                            '<div class="message-time">åˆšåˆš</div>' +
                            '<div class="message-text">å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ†æPcapæ–‡ä»¶ã€‚æˆ‘ä¼šæ£€æµ‹å¼‚å¸¸æµé‡ã€è¯†åˆ«æ½œåœ¨å¨èƒï¼Œå¹¶æä¾›è¯¦ç»†çš„å®‰å…¨è¯„ä¼°æŠ¥å‘Šã€‚</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="message message-user">' +
                        '<div class="message-avatar">ğŸ‘¤</div>' +
                        '<div class="message-content">' +
                            '<div class="message-time">åˆšåˆš</div>' +
                            '<div class="message-text">æ”¯æŒå“ªäº›åˆ†æåŠŸèƒ½ï¼Ÿ</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="message message-ai">' +
                        '<div class="message-avatar">ğŸ¤–</div>' +
                        '<div class="message-content">' +
                            '<div class="message-time">åˆšåˆš</div>' +
                            '<div class="message-text">æˆ‘æ”¯æŒä»¥ä¸‹åˆ†æåŠŸèƒ½ï¼š<br>1. å¼‚å¸¸æµé‡æ£€æµ‹<br>2. åè®®åˆ†æ<br>3. å®‰å…¨å¨èƒè¯†åˆ«<br>4. ç½‘ç»œè¡Œä¸ºåˆ†æ<br>5. æ•°æ®åŒ…ç»Ÿè®¡</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="chat-input-container" data-container-mode="fixed">' +
                    '<div class="chat-input-wrapper">' +
                        '<textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥&quot;/&quot;è°ƒç”¨é«˜çº§å‘½ä»¤" rows="3"></textarea>' +
                        '<div class="command-panel" id="commandPanel">' +
                            '<div class="command-panel-header">' +
                                '<span>é€‰æ‹©è°ƒç”¨å‘½ä»¤</span>' +
                                '<button class="command-panel-close" id="commandPanelClose" title="å…³é—­">âœ•</button>' +
                            '</div>' +
                            '<div class="command-panel-content">' +
                                '<div class="command-list" id="commandList"></div>' +
                            '</div>' +
                            '<div class="command-panel-detail">' +
                                '<div class="command-detail-header">' +
                                    '<div class="command-detail-header-left">' +
                                        '<span class="command-detail-label">è°ƒç”¨</span>' +
                                        '<span class="command-detail-name" id="commandDetailName"></span>' +
                                        '<span class="command-detail-category">é«˜çº§å‘½ä»¤</span>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="command-detail-content" id="commandDetailContent">' +
                                    '<input type="text" class="command-detail-input hidden" id="commandDetailInput" placeholder="è¾“å…¥å…³é”®è¯">' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="chat-input-toolbar">' +
                            '<div class="chat-input-actions">' +
                                '<button class="btn-icon" title="ä¸Šä¼ æ–‡ä»¶" data-action="upload">ğŸ“</button>' +
                                '<button class="btn-icon" title="æ’å…¥å›¾ç‰‡" data-action="image">ğŸ–¼ï¸</button>' +
                                '<button class="btn-icon" title="æ’å…¥ä»£ç " data-action="code">ğŸ’»</button>' +
                                '<button class="btn-icon" title="æ’å…¥è¡¨æ ¼" data-action="table">ğŸ“Š</button>' +
                            '</div>' +
                            '<button class="btn btn-primary chat-send" id="chatSend">' +
                                '<span>å‘é€</span>' +
                                '<span class="send-shortcut">Shift+Enter</span>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';

                chatArea.appendChild(taskContent);
                taskContent.style.display = 'flex';

                console.log('[DEBUG] ä»»åŠ¡è¯¦æƒ…å·²åˆ›å»ºå¹¶æ˜¾ç¤º');

                // åˆå§‹åŒ–èŠå¤©è¾“å…¥ç»„ä»¶
                setTimeout(function() {
                    var chatInputContainer = taskContent.querySelector('.chat-input-container');
                    if (chatInputContainer && typeof initChatInput === 'function') {
                        // ä¸ºè¿™ä¸ªç‰¹å®šçš„å®¹å™¨åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é€‰æ‹©å™¨
                        chatInputContainer.setAttribute('data-chat-instance', 'task-chat-' + Date.now());
                        var instanceSelector = '[data-chat-instance="' + chatInputContainer.getAttribute('data-chat-instance') + '"]';
                        
                        initChatInput({
                            selector: instanceSelector,
                            onSend: function(message) {
                                console.log('å‘é€æ¶ˆæ¯:', message);
                                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸ
                                addMessageToChat('user', message, taskContent);
                                // æ¨¡æ‹ŸAIå›å¤
                                setTimeout(function() {
                                    var aiResponse = generateAIResponse(message);
                                    addMessageToChat('ai', aiResponse, taskContent);
                                }, 500);
                            },
                            autoFocus: true
                        });
                        
                        // åˆå§‹åŒ–å‘½ä»¤é¢æ¿
                        initCommandPanel(chatInputContainer);
                        
                        console.log('[DEBUG] èŠå¤©è¾“å…¥ç»„ä»¶å·²åˆå§‹åŒ–');
                    }
                }, 100);

                // æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(function() {
                    var chatMessages = taskContent.querySelector('.chat-messages');
                    if (chatMessages) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }, 200);
            } catch (error) {
                console.error('[DEBUG] é”™è¯¯:', error);
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            initFileUpload();
            
            // ä¸ºé™æ€ä»»åŠ¡é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆå¦‚æœagent-sidebar.jsä¸å­˜åœ¨ï¼‰
            var recentTaskItems = document.querySelectorAll('.recent-task-item');
            console.log('[DEBUG] æ‰¾åˆ°é™æ€ä»»åŠ¡é¡¹æ•°é‡:', recentTaskItems.length);
            recentTaskItems.forEach(function(item, index) {
                item.style.cursor = 'pointer'; // ç¡®ä¿é¼ æ ‡æŒ‡é’ˆæ˜¾ç¤ºä¸ºæ‰‹å‹
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[DEBUG] é™æ€ä»»åŠ¡é¡¹è¢«ç‚¹å‡»ï¼Œç´¢å¼•:', index);
                    
                    // ç§»é™¤æ‰€æœ‰ä»»åŠ¡çš„ active çŠ¶æ€
                    recentTaskItems.forEach(function(taskItem) {
                        taskItem.classList.remove('active');
                    });
                    
                    // ä¸ºå½“å‰ç‚¹å‡»çš„ä»»åŠ¡æ·»åŠ  active çŠ¶æ€
                    this.classList.add('active');
                    
                    var taskName = this.querySelector('.task-name');
                    if (!taskName) {
                        console.error('[DEBUG] æœªæ‰¾åˆ°ä»»åŠ¡åç§°å…ƒç´ ');
                        return;
                    }
                    var taskNameText = taskName.textContent.trim();
                    console.log('[DEBUG] ä»»åŠ¡åç§°:', taskNameText);
                    // ä»mockTasksä¸­æ‰¾åˆ°å¯¹åº”çš„ä»»åŠ¡æ•°æ®
                    var taskData = mockTasks.find(function(task) {
                        return task.name === taskNameText;
                    });
                    if (taskData) {
                        console.log('[DEBUG] æ‰¾åˆ°ä»»åŠ¡æ•°æ®:', taskData);
                        // è°ƒç”¨ä»»åŠ¡ç‚¹å‡»å¤„ç†å‡½æ•°
                        handleTaskClick(taskData.id, taskData);
                    } else {
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶ä»»åŠ¡æ•°æ®
                        var statusIcon = this.querySelector('.task-status-icon');
                        var status = statusIcon && statusIcon.classList.contains('running') ? 'running' : 'completed';
                        var tempTask = {
                            id: 'task-' + (index + 1),
                            name: taskNameText,
                            status: status,
                            active: false
                        };
                        console.log('[DEBUG] ä½¿ç”¨ä¸´æ—¶ä»»åŠ¡æ•°æ®:', tempTask);
                        handleTaskClick(tempTask.id, tempTask);
                    }
                });
                console.log('[DEBUG] å·²ä¸ºä»»åŠ¡é¡¹ç»‘å®šç‚¹å‡»äº‹ä»¶:', index);
            });
            
            // åˆå§‹åŒ–ä¾§å¯¼èˆªç»„ä»¶ï¼ˆå¦‚æœå‡½æ•°å­˜åœ¨ï¼‰
            if (typeof initAgentSidebar === 'function') {
                window.agentSidebarInstance = initAgentSidebar({
                    tasks: mockTasks,
                    maxTasks: 10,
                    onNewTask: function() {
                    console.log('åˆ›å»ºæ–°åˆ†æä»»åŠ¡');
                    // ç‚¹å‡»æ–°ä»»åŠ¡æŒ‰é’®æ—¶ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€é¡µé¢
                    var chatArea = document.querySelector('.agent-main-content');
                    if (!chatArea) return;

                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç©ºçŠ¶æ€å®¹å™¨
                    var emptyStateContainer = document.querySelector('.empty-state-container');
                    var taskContent = document.querySelector('.task-detail-content');
                    var tasksList = document.querySelector('.tasks-list-container');

                    // å¦‚æœå·²æœ‰ç©ºçŠ¶æ€å®¹å™¨ï¼Œç›´æ¥æ˜¾ç¤º
                    if (emptyStateContainer) {
                        emptyStateContainer.style.display = 'flex';
                        if (taskContent) taskContent.style.display = 'none';
                        if (tasksList) tasksList.style.display = 'none';
                        // é‡æ–°åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
                        setTimeout(function() {
                            initFileUpload();
                            resetFileUpload();
                        }, 100);
                        return;
                    }

                    // å¦åˆ™é‡æ–°åˆ›å»ºç©ºçŠ¶æ€é¡µé¢
                    chatArea.innerHTML = '<div class="empty-state-container">' +
                        '<div class="empty-agent-name">' +
                            '<span class="agent-name-text">PcapåŒ…åˆ†æ</span>' +
                        '</div>' +
                        '<div class="empty-state-guide">' +
                            '<p class="empty-state-guide-text">ä¸Šä¼ Pcapæ–‡ä»¶ï¼Œå¼€å§‹æ™ºèƒ½åˆ†æ</p>' +
                        '</div>' +
                        '<div class="file-upload-container" id="fileUploadContainer">' +
                            '<div class="file-upload-area" id="fileUploadArea">' +
                                '<input type="file" id="fileInput" accept=".pcap,.pcapng,.cap" style="display: none;">' +
                                '<div class="file-upload-icon">ğŸ“¦</div>' +
                                '<div class="file-upload-text">' +
                                    '<p class="file-upload-title">ä¸Šä¼ Pcapæ–‡ä»¶</p>' +
                                    '<p class="file-upload-hint">æ”¯æŒå•ä¸ª.pcapå’Œ.pcapngå’Œ.capæ–‡ä»¶ï¼Œå¤§å°ä¸è¶…è¿‡100M</p>' +
                                    '<p class="file-upload-action">ç‚¹å‡»ä¸Šä¼ æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</p>' +
                                '</div>' +
                            '</div>' +
                            '<div class="file-info-container" id="fileInfoContainer" style="display: none;">' +
                                '<div class="file-info-header">' +
                                    '<div class="file-info-icon">ğŸ“¦</div>' +
                                    '<div class="file-info-details">' +
                                        '<div class="file-info-name" id="fileName"></div>' +
                                        '<div class="file-info-size" id="fileSize"></div>' +
                                    '</div>' +
                                    '<button class="file-remove-btn" id="fileRemoveBtn" title="ç§»é™¤æ–‡ä»¶">âœ•</button>' +
                                '</div>' +
                                '<div class="file-info-actions">' +
                                    '<button class="btn btn-primary btn-analyze" id="btnAnalyze">' +
                                        '<span>å¼€å§‹åˆ†æ</span>' +
                                    '</button>' +
                                '</div>' +
                            '</div>' +
                            '<div class="file-upload-error" id="fileUploadError" style="display: none;"></div>' +
                        '</div>' +
                    '</div>';
                    
                    // é‡æ–°åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
                    setTimeout(function() {
                        initFileUpload();
                    }, 100);
                },
                onTaskClick: function(taskId, taskData) {
                    console.log('[DEBUG] ç‚¹å‡»ä»»åŠ¡ï¼ˆé€šè¿‡initAgentSidebarï¼‰:', taskId, taskData);
                    handleTaskClick(taskId, taskData);
                },
                onViewAll: function() {
                    console.log('æŸ¥çœ‹å…¨éƒ¨ä»»åŠ¡');
                    showAllTasks();
                }
                });
            } else {
                console.log('[DEBUG] initAgentSidebar å‡½æ•°ä¸å­˜åœ¨ï¼Œä½¿ç”¨é™æ€ä»»åŠ¡é¡¹ç»‘å®š');
            }

        });

        // æ˜¾ç¤ºå…¨éƒ¨ä»»åŠ¡åˆ—è¡¨
        function showAllTasks() {
            var chatArea = document.querySelector('.agent-main-content');
            if (!chatArea) return;

            // ç”Ÿæˆä»»åŠ¡åˆ—è¡¨HTML
            var tasksHtml = '';
            for (var i = 0; i < mockTasks.length; i++) {
                var task = mockTasks[i];
                var statusIcon = task.status === 'running' ? 'â³' :
                                task.status === 'completed' ? 'âœ…' : 'âŒ';
                var statusClass = task.status;

                tasksHtml += '<div class="task-record-card" data-task-id="' + task.id + '">' +
                    '<div class="task-record-left">' +
                        '<div class="task-record-header">' +
                            '<div class="task-record-status">' +
                                '<span class="task-status-badge ' + statusClass + '">' + statusIcon + '</span>' +
                            '</div>' +
                            '<div class="task-record-name">' + task.name + '</div>' +
                        '</div>' +
                        '<div class="task-record-statistics">' +
                            '<span class="statistics-label">æ¶ˆæ¯æ•°</span>' +
                            '<span class="statistics-value">' + (4 + Math.floor(Math.random() * 6)) + ' æ¡</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="task-record-right">' +
                        '<div class="task-record-time">2025-12-19 14:30</div>' +
                        '<div class="task-record-actions">' +
                            '<button class="task-action-btn">æŸ¥çœ‹</button>' +
                            '<button class="task-action-btn">åˆ é™¤</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }

            if (mockTasks.length === 0) {
                tasksHtml = '<div class="tasks-empty">æš‚æ— ä»»åŠ¡è®°å½•</div>';
            }

            // æ›¿æ¢å†…å®¹
            chatArea.innerHTML = '<div class="tasks-list-container">' +
                '<div class="tasks-list-header">' +
                    '<h2 class="tasks-list-title">å…¨éƒ¨ä»»åŠ¡è®°å½•</h2>' +
                '</div>' +
                '<div class="tasks-list-content">' +
                    tasksHtml +
                '</div>' +
            '</div>';

            // ç»‘å®šä»»åŠ¡å¡ç‰‡ç‚¹å‡»äº‹ä»¶
            var taskCards = chatArea.querySelectorAll('.task-record-card');
            for (var i = 0; i < taskCards.length; i++) {
                taskCards[i].addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘å¡ç‰‡ç‚¹å‡»
                    if (e.target.classList.contains('task-action-btn')) {
                        e.stopPropagation();
                        var btnText = e.target.textContent;
                        var taskId = this.getAttribute('data-task-id');

                        if (btnText === 'æŸ¥çœ‹') {
                            // æŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡å¹¶æ˜¾ç¤ºè¯¦æƒ…
                            var selectedTask = null;
                            for (var j = 0; j < mockTasks.length; j++) {
                                if (mockTasks[j].id === taskId) {
                                    selectedTask = mockTasks[j];
                                    break;
                                }
                            }

                            if (selectedTask) {
                                // è°ƒç”¨ç°æœ‰çš„ä»»åŠ¡ç‚¹å‡»å›è°ƒ
                                var sidebarInstance = window.agentSidebarInstance;
                                if (sidebarInstance && sidebarInstance.setActiveTask) {
                                    sidebarInstance.setActiveTask(taskId);
                                }

                                // æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…ï¼ˆå¤ç”¨ä¹‹å‰çš„ä»£ç ï¼‰
                                showTaskDetailById(taskId, selectedTask);
                            }
                        } else if (btnText === 'åˆ é™¤') {
                            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ')) {
                                console.log('åˆ é™¤ä»»åŠ¡:', taskId);
                            }
                        }
                        return;
                    }

                    // ç‚¹å‡»å¡ç‰‡å…¶ä»–åŒºåŸŸï¼Œæ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
                    var taskId = this.getAttribute('data-task-id');
                    var selectedTask = null;
                    for (var j = 0; j < mockTasks.length; j++) {
                        if (mockTasks[j].id === taskId) {
                            selectedTask = mockTasks[j];
                            break;
                        }
                    }

                    if (selectedTask) {
                        showTaskDetailById(taskId, selectedTask);
                    }
                });
            }
        }

        // æ ¹æ®ä»»åŠ¡IDæ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
        function showTaskDetailById(taskId, taskData) {
            var chatArea = document.querySelector('.agent-main-content');
            if (!chatArea) return;

            var taskName = taskData ? taskData.name : 'æœªçŸ¥ä»»åŠ¡';

            var taskContent = document.createElement('div');
            taskContent.className = 'task-detail-content';

            taskContent.innerHTML = '<div class="chat-header">' +
                '<div class="chat-title">' + taskName + '</div>' +
                '<div class="chat-time">åˆšåˆš</div>' +
            '</div>' +
            '<div class="chat-messages">' +
                '<div class="message message-user">' +
                    '<div class="message-avatar">ğŸ‘¤</div>' +
                    '<div class="message-content">' +
                        '<div class="message-time">åˆšåˆš</div>' +
                        '<div class="message-text">è¯·å¸®æˆ‘åˆ†æè¿™ä¸ªPcapæ–‡ä»¶ä¸­çš„å¼‚å¸¸æµé‡ã€‚</div>' +
                    '</div>' +
                '</div>' +
                '<div class="message message-ai">' +
                    '<div class="message-avatar">ğŸ¤–</div>' +
                    '<div class="message-content">' +
                        '<div class="message-time">åˆšåˆš</div>' +
                        '<div class="message-text">å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨åˆ†æPcapæ–‡ä»¶ã€‚æˆ‘ä¼šæ£€æµ‹å¼‚å¸¸æµé‡ã€è¯†åˆ«æ½œåœ¨å¨èƒï¼Œå¹¶æä¾›è¯¦ç»†çš„å®‰å…¨è¯„ä¼°æŠ¥å‘Šã€‚</div>' +
                    '</div>' +
                '</div>' +
                '<div class="message message-user">' +
                    '<div class="message-avatar">ğŸ‘¤</div>' +
                    '<div class="message-content">' +
                        '<div class="message-time">åˆšåˆš</div>' +
                        '<div class="message-text">æ”¯æŒå“ªäº›åˆ†æåŠŸèƒ½ï¼Ÿ</div>' +
                    '</div>' +
                '</div>' +
                '<div class="message message-ai">' +
                    '<div class="message-avatar">ğŸ¤–</div>' +
                    '<div class="message-content">' +
                        '<div class="message-time">åˆšåˆš</div>' +
                        '<div class="message-text">æˆ‘æ”¯æŒä»¥ä¸‹åˆ†æåŠŸèƒ½ï¼š<br>1. å¼‚å¸¸æµé‡æ£€æµ‹<br>2. åè®®åˆ†æ<br>3. å®‰å…¨å¨èƒè¯†åˆ«<br>4. ç½‘ç»œè¡Œä¸ºåˆ†æ<br>5. æ•°æ®åŒ…ç»Ÿè®¡</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<div class="chat-input-container" data-container-mode="fixed">' +
                '<div class="chat-input-wrapper">' +
                    '<textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥&quot;/&quot;è°ƒç”¨é«˜çº§å‘½ä»¤" rows="3"></textarea>' +
                    '<div class="command-panel" id="commandPanel">' +
                        '<div class="command-panel-header">' +
                            '<span>é€‰æ‹©è°ƒç”¨å‘½ä»¤</span>' +
                            '<button class="command-panel-close" id="commandPanelClose" title="å…³é—­">âœ•</button>' +
                        '</div>' +
                        '<div class="command-panel-content">' +
                            '<div class="command-list" id="commandList"></div>' +
                        '</div>' +
                        '<div class="command-panel-detail">' +
                            '<div class="command-detail-header">' +
                                '<div class="command-detail-header-left">' +
                                    '<span class="command-detail-label">è°ƒç”¨</span>' +
                                    '<span class="command-detail-name" id="commandDetailName"></span>' +
                                    '<span class="command-detail-category">é«˜çº§å‘½ä»¤</span>' +
                                '</div>' +
                            '</div>' +
                            '<div class="command-detail-content" id="commandDetailContent"></div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="chat-input-toolbar">' +
                        '<div class="chat-input-actions">' +
                            '<button class="btn-icon" title="ä¸Šä¼ æ–‡ä»¶" data-action="upload">ğŸ“</button>' +
                            '<button class="btn-icon" title="æ’å…¥å›¾ç‰‡" data-action="image">ğŸ–¼ï¸</button>' +
                            '<button class="btn-icon" title="æ’å…¥ä»£ç " data-action="code">ğŸ’»</button>' +
                            '<button class="btn-icon" title="æ’å…¥è¡¨æ ¼" data-action="table">ğŸ“Š</button>' +
                        '</div>' +
                        '<button class="btn btn-primary chat-send" id="chatSend">' +
                            '<span>å‘é€</span>' +
                            '<span class="send-shortcut">Shift+Enter</span>' +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>';

            chatArea.innerHTML = '';
            chatArea.appendChild(taskContent);
            taskContent.style.display = 'flex';

            // åˆå§‹åŒ–èŠå¤©è¾“å…¥ç»„ä»¶
            setTimeout(function() {
                var chatInputContainer = taskContent.querySelector('.chat-input-container');
                if (chatInputContainer && typeof initChatInput === 'function') {
                    // ä¸ºè¿™ä¸ªç‰¹å®šçš„å®¹å™¨åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„é€‰æ‹©å™¨
                    chatInputContainer.setAttribute('data-chat-instance', 'task-chat-' + Date.now());
                    var instanceSelector = '[data-chat-instance="' + chatInputContainer.getAttribute('data-chat-instance') + '"]';
                    
                    initChatInput({
                        selector: instanceSelector,
                        onSend: function(message) {
                            console.log('å‘é€æ¶ˆæ¯:', message);
                            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸ
                            addMessageToChat('user', message, taskContent);
                            // æ¨¡æ‹ŸAIå›å¤
                            setTimeout(function() {
                                var aiResponse = generateAIResponse(message);
                                addMessageToChat('ai', aiResponse, taskContent);
                            }, 500);
                        },
                        autoFocus: true
                    });
                    
                    // åˆå§‹åŒ–å‘½ä»¤é¢æ¿
                    initCommandPanel(chatInputContainer);
                    
                    console.log('[DEBUG] èŠå¤©è¾“å…¥ç»„ä»¶å·²åˆå§‹åŒ–');
                }
            }, 100);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(function() {
                var chatMessages = taskContent.querySelector('.chat-messages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }, 200);
        }

        // å¿«é€Ÿæç¤ºå¡«å……åŠŸèƒ½
        function fillPrompt(text) {
            const input = document.getElementById('chatInput');
            if (input) {
                input.value = text;
                input.focus();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åŒºåŸŸ
        function addMessageToChat(type, text, taskContent) {
            var chatMessages = taskContent.querySelector('.chat-messages');
            if (!chatMessages) return;

            var messageDiv = document.createElement('div');
            messageDiv.className = 'message message-' + type;
            
            var avatar = type === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            var now = new Date();
            var timeStr = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
            
            messageDiv.innerHTML = '<div class="message-avatar">' + avatar + '</div>' +
                '<div class="message-content">' +
                    '<div class="message-time">' + timeStr + '</div>' +
                    '<div class="message-text">' + text.replace(/\n/g, '<br>') + '</div>' +
                '</div>';

            chatMessages.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(function() {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 50);
        }

        // ==========================================
        // å‘½ä»¤é€‰æ‹©é¢æ¿åŠŸèƒ½
        // ==========================================
        
        // å‘½ä»¤åˆ—è¡¨æ•°æ®
        const commandList = [
            {
                name: 'uri',
                description: 'æå–HTTPè¯·æ±‚ä¸­çš„uriä¿¡æ¯'
            },
            {
                name: 'keyword',
                description: 'æå–æŒ‡å®šå…³é”®è¯ä¿¡æ¯'
            },
            {
                name: 'ip',
                description: 'æå–æŒ‡å®šIPå¼€æ”¾Portä¿¡æ¯'
            },
            {
                name: 'filetype',
                description: 'æå–HTTPå¯¹è±¡ä¸­æŒ‡å®šæ ¼å¼çš„æ–‡ä»¶ä¿¡æ¯'
            },
            {
                name: 'ip_connect',
                description: 'æå–IPé—´å…³è”ä¿¡æ¯'
            },
            {
                name: 'http',
                description: 'æå–HTTPæŠ¥æ–‡'
            },
            {
                name: 'ftp',
                description: 'æå–FTPå‘½ä»¤åŠå…¶å‚æ•°'
            },
            {
                name: 'telnet',
                description: 'æå–Telnetåè®®æ•°æ®'
            }
        ];

        // åˆå§‹åŒ–å‘½ä»¤é¢æ¿
        function initCommandPanel(container) {
            if (!container) return;
            
            const commandPanel = container.querySelector('.command-panel');
            const commandListEl = container.querySelector('.command-list');
            const chatInput = container.querySelector('.chat-input');
            
            if (!commandPanel || !commandListEl || !chatInput) {
                console.warn('å‘½ä»¤é¢æ¿å…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

                    // è·å–è¯¦æƒ…è§†å›¾å…ƒç´ 
            const commandDetailName = commandPanel.querySelector('#commandDetailName');
            const commandDetailContent = commandPanel.querySelector('#commandDetailContent');
            const commandDetailInput = commandPanel.querySelector('#commandDetailInput');
            const commandPanelClose = commandPanel.querySelector('#commandPanelClose');

            // æ˜¾ç¤ºå‘½ä»¤è¯¦æƒ…ï¼ˆå±€éƒ¨å‡½æ•°ï¼‰
            function showCommandDetailLocal(command) {
                if (commandDetailName && commandDetailContent) {
                    commandDetailName.textContent = command.name;
                    // æ‰€æœ‰å‘½ä»¤çš„æè¿°æ–‡å­—éƒ½æ”¾åœ¨å¯¹è¯æ¡†(è¾“å…¥æ¡†)å†…,ä¸åœ¨è™šæµ®å±‚æ˜¾ç¤º
                    // è·å–è¾“å…¥æ¡†å…ƒç´ ï¼ˆåº”è¯¥å·²ç»åœ¨HTMLä¸­ï¼‰
                    let inputElement = commandDetailContent.querySelector('#commandDetailInput');
                    // è·å–ä¸‹æ‹‰é€‰æ‹©æ¡†å…ƒç´ 
                    let selectElement = commandDetailContent.querySelector('#commandDetailSelect');
                    // è·å–å¤é€‰æ¡†å…ƒç´ 
                    let checkboxWrapper = commandDetailContent.querySelector('#commandDetailCheckboxWrapper');
                    
                    // å¦‚æœæ˜¯keywordæˆ–ipå‘½ä»¤ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
                    if (command.name === 'keyword' || command.name === 'ip') {
                        // éšè—ä¸‹æ‹‰é€‰æ‹©æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (selectElement) {
                            selectElement.classList.add('hidden');
                        }
                        if (!inputElement) {
                            // å¦‚æœè¾“å…¥æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                            inputElement = document.createElement('input');
                            inputElement.type = 'text';
                            inputElement.className = 'command-detail-input';
                            inputElement.id = 'commandDetailInput';
                            // æ ¹æ®å‘½ä»¤ç±»å‹è®¾ç½®ä¸åŒçš„placeholder
                            if (command.name === 'keyword') {
                                inputElement.placeholder = 'è¾“å…¥å…³é”®è¯';
                            } else if (command.name === 'ip') {
                                inputElement.placeholder = 'è¾“å…¥å®Œæ•´IPä¿¡æ¯';
                            }
                            commandDetailContent.appendChild(inputElement);
                            
                            // æ·»åŠ å›è½¦é”®äº‹ä»¶å¤„ç†
                            inputElement.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    // è·å–è¾“å…¥çš„å†…å®¹
                                    const inputValue = inputElement.value.trim();
                                    // å¦‚æœæœ‰è¾“å…¥å†…å®¹ï¼Œæ’å…¥åˆ°ä¸»è¾“å…¥æ¡†
                                    if (inputValue) {
                                        if (command.name === 'keyword') {
                                            insertKeywordCommandToInput(chatInput, command, inputValue);
                                        } else if (command.name === 'ip') {
                                            insertIpCommandToInput(chatInput, command, inputValue);
                                        }
                                    } else {
                                        insertCommandToInput(chatInput, command.name, command);
                                    }
                                    hideCommandPanel(commandPanel);
                                    hideCommandDetailLocal();
                                }
                            });
                            
                            // é˜»æ­¢è¾“å…¥æ¡†çš„äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¯¦æƒ…åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶
                            inputElement.addEventListener('click', function(e) {
                                e.stopPropagation();
                            });
                        } else {
                            // å¦‚æœè¾“å…¥æ¡†å·²å­˜åœ¨ï¼Œæ›´æ–°placeholder
                            if (command.name === 'keyword') {
                                inputElement.placeholder = 'è¾“å…¥å…³é”®è¯';
                            } else if (command.name === 'ip') {
                                inputElement.placeholder = 'è¾“å…¥å®Œæ•´IPä¿¡æ¯';
                            }
                        }
                        inputElement.value = ''; // æ¸…ç©ºä¹‹å‰çš„å€¼
                        inputElement.classList.remove('hidden');
                        // èšç„¦åˆ°è¾“å…¥æ¡†
                        setTimeout(function() {
                            inputElement.focus();
                        }, 10);
                    } else if (command.name === 'filetype') {
                        // å¦‚æœæ˜¯filetypeå‘½ä»¤ï¼Œæ˜¾ç¤ºä¸‹æ‹‰é€‰æ‹©æ¡†
                        // éšè—è¾“å…¥æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (inputElement) {
                            inputElement.classList.add('hidden');
                        }
                        if (!selectElement) {
                            // å¦‚æœä¸‹æ‹‰é€‰æ‹©æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                            selectElement = document.createElement('select');
                            selectElement.className = 'command-detail-select';
                            selectElement.id = 'commandDetailSelect';
                            // æ·»åŠ æ–‡ä»¶ç±»å‹é€‰é¡¹
                            const fileTypes = [
                                { value: '', text: 'è¯·é€‰æ‹©æ–‡ä»¶ç±»å‹' },
                                { value: 'pdf', text: 'PDF' },
                                { value: 'doc', text: 'DOC' },
                                { value: 'docx', text: 'DOCX' },
                                { value: 'xls', text: 'XLS' },
                                { value: 'xlsx', text: 'XLSX' },
                                { value: 'jpg', text: 'JPG' },
                                { value: 'jpeg', text: 'JPEG' },
                                { value: 'png', text: 'PNG' },
                                { value: 'gif', text: 'GIF' },
                                { value: 'zip', text: 'ZIP' },
                                { value: 'rar', text: 'RAR' },
                                { value: 'txt', text: 'TXT' },
                                { value: 'exe', text: 'EXE' },
                                { value: 'dll', text: 'DLL' }
                            ];
                            fileTypes.forEach(function(option) {
                                const optionElement = document.createElement('option');
                                optionElement.value = option.value;
                                optionElement.textContent = option.text;
                                selectElement.appendChild(optionElement);
                            });
                            commandDetailContent.appendChild(selectElement);
                            
                            // æ·»åŠ é€‰æ‹©å˜åŒ–äº‹ä»¶å¤„ç†
                            selectElement.addEventListener('change', function(e) {
                                e.stopPropagation();
                                const selectedValue = selectElement.value;
                                if (selectedValue) {
                                    insertFiletypeCommandToInput(chatInput, command, selectedValue);
                                    // é€‰æ‹©åä¸å…³é—­æ‚¬æµ®å±‚ï¼Œåœç•™åœ¨å½“å‰æ“ä½œ
                                }
                            });
                            
                            // é˜»æ­¢ä¸‹æ‹‰é€‰æ‹©æ¡†çš„äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¯¦æƒ…åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶
                            selectElement.addEventListener('click', function(e) {
                                e.stopPropagation();
                            });
                        } else {
                            // å¦‚æœä¸‹æ‹‰é€‰æ‹©æ¡†å·²å­˜åœ¨ï¼Œé‡ç½®é€‰æ‹©
                            selectElement.value = '';
                        }
                        selectElement.classList.remove('hidden');
                        // èšç„¦åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†
                        setTimeout(function() {
                            selectElement.focus();
                        }, 10);
                    } else if (command.name === 'ip_connect') {
                        // å¦‚æœæ˜¯ip_connectå‘½ä»¤ï¼Œæ˜¾ç¤ºå¤é€‰æ¡†
                        // éšè—è¾“å…¥æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (inputElement) {
                            inputElement.classList.add('hidden');
                        }
                        // éšè—ä¸‹æ‹‰é€‰æ‹©æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        if (selectElement) {
                            selectElement.classList.add('hidden');
                        }
                        if (!checkboxWrapper) {
                            // å¦‚æœå¤é€‰æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                            checkboxWrapper = document.createElement('div');
                            checkboxWrapper.className = 'command-detail-checkbox-wrapper';
                            checkboxWrapper.id = 'commandDetailCheckboxWrapper';
                            
                            const checkbox = document.createElement('div');
                            checkbox.className = 'command-detail-checkbox';
                            
                            const checkboxInput = document.createElement('input');
                            checkboxInput.type = 'checkbox';
                            checkboxInput.id = 'commandDetailCheckbox';
                            
                            const checkboxIcon = document.createElement('span');
                            checkboxIcon.className = 'command-detail-checkbox-icon';
                            checkboxIcon.textContent = 'âœ“';
                            
                            checkbox.appendChild(checkboxInput);
                            checkbox.appendChild(checkboxIcon);
                            
                            const checkboxLabel = document.createElement('label');
                            checkboxLabel.className = 'command-detail-checkbox-label';
                            checkboxLabel.setAttribute('for', 'commandDetailCheckbox');
                            checkboxLabel.textContent = 'å›¾è°±å±•ç¤º';
                            
                            checkboxWrapper.appendChild(checkbox);
                            checkboxWrapper.appendChild(checkboxLabel);
                            
                            commandDetailContent.appendChild(checkboxWrapper);
                            
                            // é˜»æ­¢å¤é€‰æ¡†çš„äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¯¦æƒ…åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶
                            checkboxWrapper.addEventListener('click', function(e) {
                                e.stopPropagation();
                            });
                            
                            // ç›‘å¬å¤é€‰æ¡†çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°æ ·å¼ï¼ˆç”¨äºä¸æ”¯æŒ:has()çš„æµè§ˆå™¨ï¼‰
                            checkboxInput.addEventListener('change', function() {
                                if (this.checked) {
                                    checkbox.classList.add('checked');
                                } else {
                                    checkbox.classList.remove('checked');
                                }
                            });
                        }
                        checkboxWrapper.classList.remove('hidden');
                    } else {
                        // å…¶ä»–å‘½ä»¤éšè—è¾“å…¥æ¡†ã€ä¸‹æ‹‰é€‰æ‹©æ¡†å’Œå¤é€‰æ¡†
                        if (inputElement) {
                            inputElement.classList.add('hidden');
                        }
                        if (selectElement) {
                            selectElement.classList.add('hidden');
                        }
                        if (checkboxWrapper) {
                            checkboxWrapper.classList.add('hidden');
                        }
                    }
                    commandPanel.classList.add('detail-mode');
                }
            }

            // éšè—å‘½ä»¤è¯¦æƒ…ï¼Œè¿”å›åˆ—è¡¨è§†å›¾ï¼ˆå±€éƒ¨å‡½æ•°ï¼‰
            function hideCommandDetailLocal() {
                commandPanel.classList.remove('detail-mode');
                // æ¸…é™¤é€‰ä¸­çŠ¶æ€
                const selectedItem = commandListEl.querySelector('.command-item.selected');
                if (selectedItem) {
                    selectedItem.classList.remove('selected');
                }
            }

            // é¢æ¿å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - å…³é—­æ•´ä¸ªå‘½ä»¤é¢æ¿
            if (commandPanelClose) {
                commandPanelClose.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    hideCommandPanel(commandPanel);
                });
            }

            // è¯¦æƒ…å†…å®¹åŒºåŸŸç‚¹å‡»äº‹ä»¶ - ç‚¹å‡»åæ’å…¥å‘½ä»¤åˆ°è¾“å…¥æ¡†
            if (commandDetailContent) {
                commandDetailContent.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯å…³é—­æŒ‰é’®ï¼Œä¸å¤„ç†
                    if (e.target.closest('.command-panel-close')) {
                        return;
                    }
                    
                    // å¦‚æœç‚¹å‡»çš„æ˜¯è¾“å…¥æ¡†ï¼Œä¸å¤„ç†ï¼ˆè®©ç”¨æˆ·å¯ä»¥æ­£å¸¸è¾“å…¥ï¼‰
                    if (e.target.classList.contains('command-detail-input')) {
                        return;
                    }
                    
                    // å¦‚æœç‚¹å‡»çš„æ˜¯ä¸‹æ‹‰é€‰æ‹©æ¡†ï¼Œä¸å¤„ç†ï¼ˆè®©ç”¨æˆ·å¯ä»¥æ­£å¸¸é€‰æ‹©ï¼‰
                    if (e.target.classList.contains('command-detail-select')) {
                        return;
                    }
                    
                    // å¦‚æœç‚¹å‡»çš„æ˜¯å¤é€‰æ¡†æˆ–å¤é€‰æ¡†æ ‡ç­¾ï¼Œä¸å¤„ç†ï¼ˆè®©ç”¨æˆ·å¯ä»¥æ­£å¸¸é€‰æ‹©ï¼‰
                    if (e.target.closest('.command-detail-checkbox-wrapper') || 
                        e.target.classList.contains('command-detail-checkbox') ||
                        e.target.classList.contains('command-detail-checkbox-label') ||
                        e.target.id === 'commandDetailCheckbox') {
                        return;
                    }
                    
                    // è·å–å½“å‰é€‰ä¸­çš„å‘½ä»¤åç§°
                    const currentCommandName = commandDetailName ? commandDetailName.textContent : '';
                    // ä»å‘½ä»¤åˆ—è¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„å‘½ä»¤å¯¹è±¡
                    const currentCommand = commandList.find(function(cmd) {
                        return cmd.name === currentCommandName;
                    });
                    
                    // æ’å…¥å‘½ä»¤åˆ°è¾“å…¥æ¡†ï¼ˆå¦‚æœæ˜¯ uri å‘½ä»¤ï¼Œä¼šåŒ…å«æè¿°æ–‡å­—ï¼‰
                    if (currentCommand) {
                        insertCommandToInput(chatInput, currentCommandName, currentCommand);
                        hideCommandPanel(commandPanel);
                    hideCommandDetailLocal();
                    }
                });
                
                // åªæœ‰å½“æ²¡æœ‰è¾“å…¥æ¡†å’Œä¸‹æ‹‰é€‰æ‹©æ¡†æ—¶æ‰æ·»åŠ æ ·å¼æç¤ºå¯ç‚¹å‡»
                // å¦‚æœæœ‰è¾“å…¥æ¡†ï¼ˆkeywordå‘½ä»¤ï¼‰æˆ–ä¸‹æ‹‰é€‰æ‹©æ¡†ï¼ˆfiletypeå‘½ä»¤ï¼‰ï¼Œä¸è®¾ç½®cursorä¸ºpointerï¼Œè®©è¾“å…¥æ¡†/ä¸‹æ‹‰é€‰æ‹©æ¡†å¯æ­£å¸¸ä½¿ç”¨
            }

            // ç”Ÿæˆå‘½ä»¤åˆ—è¡¨
            commandListEl.innerHTML = '';
            commandList.forEach(function(command, index) {
                const commandItem = document.createElement('div');
                commandItem.className = 'command-item';
                commandItem.setAttribute('data-command-index', index);
                commandItem.innerHTML = 
                    '<span class="command-name">' + command.name + '</span>' +
                    '<p class="command-description">/' + command.description + '</p>';
                
                // ç‚¹å‡»å‘½ä»¤é¡¹æ—¶ï¼Œå°†æè¿°æ–‡å­—æ’å…¥åˆ°è¾“å…¥æ¡†å†…
                commandItem.addEventListener('click', function() {
                    // ç§»é™¤å…¶ä»–é¡¹çš„é€‰ä¸­çŠ¶æ€
                    commandListEl.querySelectorAll('.command-item').forEach(function(item) {
                        item.classList.remove('selected');
                    });
                    // æ·»åŠ å½“å‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                    this.classList.add('selected');
                    // æ˜¾ç¤ºè¯¦æƒ…è§†å›¾ï¼ˆåªæ˜¾ç¤ºå‘½ä»¤åç§°ï¼Œä¸æ˜¾ç¤ºæè¿°æ–‡å­—ï¼‰
                    showCommandDetailLocal(command);
                    
                    // æ‰€æœ‰å‘½ä»¤çš„æè¿°æ–‡å­—éƒ½æ’å…¥åˆ°è¾“å…¥æ¡†å†…
                    if (command.description) {
                        insertCommandToInput(chatInput, command.name, command);
                    }
                });

                commandListEl.appendChild(commandItem);
            });

            // ç›‘å¬è¾“å…¥æ¡†çš„è¾“å…¥äº‹ä»¶
            chatInput.addEventListener('input', function(e) {
                const input = e.target;
                const value = input.value;
                const cursorPos = input.selectionStart;

                // æ£€æŸ¥æ˜¯å¦è¾“å…¥äº†"/"
                if (value[cursorPos - 1] === '/') {
                    // æ£€æŸ¥"/"æ˜¯å¦åœ¨è¡Œé¦–æˆ–ç©ºæ ¼å
                    const valueBeforeCursor = value.substring(0, cursorPos - 1);
                    if (cursorPos === 1 || valueBeforeCursor.endsWith(' ') || valueBeforeCursor.endsWith('\n')) {
                        showCommandPanel(commandPanel, chatInput);
                    } else {
                        hideCommandPanel(commandPanel);
                    }
                } else {
                    // å¦‚æœè¾“å…¥çš„ä¸æ˜¯"/"ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦éšè—é¢æ¿
                    const valueBeforeCursor = value.substring(0, cursorPos);
                    const lastSlashIndex = valueBeforeCursor.lastIndexOf('/');
                    if (lastSlashIndex === -1 || 
                        (lastSlashIndex > 0 && valueBeforeCursor[lastSlashIndex - 1] !== ' ' && valueBeforeCursor[lastSlashIndex - 1] !== '\n')) {
                        hideCommandPanel(commandPanel);
                    }
                }
            });

            // ç›‘å¬é”®ç›˜äº‹ä»¶
            chatInput.addEventListener('keydown', function(e) {
                if (commandPanel.classList.contains('show')) {
                    // å¦‚æœé¢æ¿æ˜¾ç¤ºï¼Œå¤„ç†ä¸Šä¸‹ç®­å¤´å’Œå›è½¦
                    if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'Enter') {
                        e.preventDefault();
                        handleCommandPanelKeyboard(e, commandPanel, chatInput, commandList);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        // å¦‚æœåœ¨è¯¦æƒ…è§†å›¾ï¼Œè¿”å›åˆ—è¡¨è§†å›¾ï¼›å¦åˆ™å…³é—­é¢æ¿
                        if (commandPanel.classList.contains('detail-mode')) {
                            hideCommandDetailLocal();
                        } else {
                            hideCommandPanel(commandPanel);
                        }
                    }
                } else if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                    // å¦‚æœæŒ‰ä¸‹"/"é”®ï¼Œæ£€æŸ¥æ˜¯å¦åº”è¯¥æ˜¾ç¤ºé¢æ¿
                    const cursorPos = chatInput.selectionStart;
                    const valueBeforeCursor = chatInput.value.substring(0, cursorPos);
                    if (cursorPos === 0 || valueBeforeCursor.endsWith(' ') || valueBeforeCursor.endsWith('\n')) {
                        // å…è®¸"/"è¾“å…¥ï¼Œç„¶åæ˜¾ç¤ºé¢æ¿
                        setTimeout(function() {
                            if (chatInput.value[chatInput.selectionStart - 1] === '/') {
                                showCommandPanel(commandPanel, chatInput);
                            }
                        }, 10);
                    }
                }
            });

            // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­é¢æ¿
            document.addEventListener('click', function(e) {
                if (commandPanel.classList.contains('show') && 
                    !commandPanel.contains(e.target) && 
                    !chatInput.contains(e.target)) {
                    hideCommandPanel(commandPanel);
                }
            });
        }

        // æ˜¾ç¤ºå‘½ä»¤é¢æ¿
        function showCommandPanel(panel, input) {
            if (!panel || !input) return;
            // é‡ç½®é¢æ¿çŠ¶æ€ï¼Œç¡®ä¿æ˜¾ç¤ºå‘½ä»¤åˆ—è¡¨è§†å›¾
            panel.classList.remove('detail-mode');
            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            const commandListEl = panel.querySelector('.command-list');
            if (commandListEl) {
                const selectedItems = commandListEl.querySelectorAll('.command-item.selected');
                selectedItems.forEach(function(item) {
                    item.classList.remove('selected');
                });
            }
            panel.classList.add('show');
        }

        // éšè—å‘½ä»¤é¢æ¿
        function hideCommandPanel(panel) {
            if (!panel) return;
            panel.classList.remove('show');
        }

        // æ’å…¥å‘½ä»¤åˆ°è¾“å…¥æ¡†
        function insertCommandToInput(input, commandName, command) {
            if (!input) return;
            
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            const before = value.substring(0, start);
            const after = value.substring(end);

            // æ‰€æœ‰å‘½ä»¤éƒ½æ’å…¥æè¿°æ–‡å­—åˆ°è¾“å…¥æ¡†å†…ï¼ˆæ ¼å¼ï¼š/æè¿°æ–‡å­—ï¼‰
            let textToInsert;
            if (command && command.description) {
                textToInsert = '/' + command.description + ' ';
            } else {
                textToInsert = '/' + commandName + ' ';
            }

            // æŸ¥æ‰¾æœ€åä¸€ä¸ª"/"çš„ä½ç½®
            const lastSlashIndex = before.lastIndexOf('/');
            if (lastSlashIndex !== -1) {
                // æ›¿æ¢"/"åŠå…¶åé¢çš„å†…å®¹ä¸ºå‘½ä»¤
                const beforeSlash = value.substring(0, lastSlashIndex);
                const newValue = beforeSlash + textToInsert + after;
                input.value = newValue;
                
                // è®¾ç½®å…‰æ ‡ä½ç½®
                const newCursorPos = beforeSlash.length + textToInsert.length;
                input.setSelectionRange(newCursorPos, newCursorPos);
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°"/"ï¼Œåœ¨å…‰æ ‡ä½ç½®æ’å…¥
                const newValue = before + textToInsert + after;
                input.value = newValue;
                const newCursorPos = start + textToInsert.length;
                input.setSelectionRange(newCursorPos, newCursorPos);
            }

            // è§¦å‘ input äº‹ä»¶ä»¥æ›´æ–°é«˜åº¦
            input.dispatchEvent(new Event('input'));
            input.focus();
        }

        // æ’å…¥keywordå‘½ä»¤åˆ°è¾“å…¥æ¡†ï¼ˆå¸¦å…³é”®è¯å‚æ•°ï¼‰
        function insertKeywordCommandToInput(input, command, keyword) {
            if (!input) return;
            
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            const before = value.substring(0, start);
            const after = value.substring(end);

            // keywordå‘½ä»¤æ’å…¥æ ¼å¼ï¼š/æå–æŒ‡å®šå…³é”®è¯ä¿¡æ¯ å…³é”®è¯å†…å®¹
            let textToInsert;
            if (command && command.description) {
                textToInsert = '/' + command.description + ' ' + keyword + ' ';
            } else {
                textToInsert = '/keyword ' + keyword + ' ';
            }

            // æŸ¥æ‰¾æœ€åä¸€ä¸ª"/"çš„ä½ç½®
            const lastSlashIndex = before.lastIndexOf('/');
            if (lastSlashIndex !== -1) {
                // æ›¿æ¢"/"åŠå…¶åé¢çš„å†…å®¹ä¸ºå‘½ä»¤
                const beforeSlash = value.substring(0, lastSlashIndex);
                const newValue = beforeSlash + textToInsert + after;
                input.value = newValue;
                
                // è®¾ç½®å…‰æ ‡ä½ç½®
                const newCursorPos = beforeSlash.length + textToInsert.length;
                input.setSelectionRange(newCursorPos, newCursorPos);
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°"/"ï¼Œåœ¨å…‰æ ‡ä½ç½®æ’å…¥
                const newValue = before + textToInsert + after;
                input.value = newValue;
                const newCursorPos = start + textToInsert.length;
                input.setSelectionRange(newCursorPos, newCursorPos);
            }

            // è§¦å‘ input äº‹ä»¶ä»¥æ›´æ–°é«˜åº¦
            input.dispatchEvent(new Event('input'));
            input.focus();
        }

        // æ’å…¥ipå‘½ä»¤åˆ°è¾“å…¥æ¡†ï¼ˆå¸¦IPå‚æ•°ï¼‰
        function insertIpCommandToInput(input, command, ip) {
            if (!input) return;
            
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            const before = value.substring(0, start);
            const after = value.substring(end);

            // ipå‘½ä»¤æ’å…¥æ ¼å¼ï¼š/æå–æŒ‡å®šIPå¼€æ”¾Portä¿¡æ¯ IPå†…å®¹
            let textToInsert;
            if (command && command.description) {
                textToInsert = '/' + command.description + ' ' + ip + ' ';
            } else {
                textToInsert = '/ip ' + ip + ' ';
            }

            // æŸ¥æ‰¾æœ€åä¸€ä¸ª"/"çš„ä½ç½®
            const lastSlashIndex = before.lastIndexOf('/');
            if (lastSlashIndex !== -1) {
                // æ›¿æ¢"/"åŠå…¶åé¢çš„å†…å®¹ä¸ºå‘½ä»¤
                const beforeSlash = value.substring(0, lastSlashIndex);
                const newValue = beforeSlash + textToInsert + after;
                input.value = newValue;
                
                // è®¾ç½®å…‰æ ‡ä½ç½®
                const newCursorPos = beforeSlash.length + textToInsert.length;
                input.setSelectionRange(newCursorPos, newCursorPos);
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°"/"ï¼Œåœ¨å…‰æ ‡ä½ç½®æ’å…¥
                const newValue = before + textToInsert + after;
                input.value = newValue;
                const newCursorPos = start + textToInsert.length;
                input.setSelectionRange(newCursorPos, newCursorPos);
            }

            // è§¦å‘ input äº‹ä»¶ä»¥æ›´æ–°é«˜åº¦
            input.dispatchEvent(new Event('input'));
            input.focus();
        }

        // æ’å…¥filetypeå‘½ä»¤åˆ°è¾“å…¥æ¡†ï¼ˆå¸¦æ–‡ä»¶ç±»å‹å‚æ•°ï¼‰
        function insertFiletypeCommandToInput(input, command, filetype) {
            if (!input) return;
            
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const value = input.value;
            const before = value.substring(0, start);
            const after = value.substring(end);

            // filetypeå‘½ä»¤æ’å…¥æ ¼å¼ï¼š/æå–HTTPå¯¹è±¡ä¸­æŒ‡å®šæ ¼å¼çš„æ–‡ä»¶ä¿¡æ¯ æ–‡ä»¶ç±»å‹
            let textToInsert;
            if (command && command.description) {
                textToInsert = '/' + command.description + ' ' + filetype + ' ';
            } else {
                textToInsert = '/filetype ' + filetype + ' ';
            }

            // æŸ¥æ‰¾æœ€åä¸€ä¸ª"/"çš„ä½ç½®
            const lastSlashIndex = before.lastIndexOf('/');
            if (lastSlashIndex !== -1) {
                // æ›¿æ¢"/"åŠå…¶åé¢çš„å†…å®¹ä¸ºå‘½ä»¤
                const beforeSlash = value.substring(0, lastSlashIndex);
                const newValue = beforeSlash + textToInsert + after;
                input.value = newValue;
                
                // è®¾ç½®å…‰æ ‡ä½ç½®
                const newCursorPos = beforeSlash.length + textToInsert.length;
                input.setSelectionRange(newCursorPos, newCursorPos);
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°"/"ï¼Œåœ¨å…‰æ ‡ä½ç½®æ’å…¥
                const newValue = before + textToInsert + after;
                input.value = newValue;
                const newCursorPos = start + textToInsert.length;
                input.setSelectionRange(newCursorPos, newCursorPos);
            }

            // è§¦å‘ input äº‹ä»¶ä»¥æ›´æ–°é«˜åº¦
            input.dispatchEvent(new Event('input'));
            input.focus();
        }

        // å¤„ç†å‘½ä»¤é¢æ¿çš„é”®ç›˜æ“ä½œ
        function handleCommandPanelKeyboard(e, panel, input, commandList) {
            // å¦‚æœåœ¨è¯¦æƒ…è§†å›¾
            if (panel.classList.contains('detail-mode')) {
                const commandDetailName = panel.querySelector('#commandDetailName');
                const commandDetailInput = panel.querySelector('#commandDetailInput');
                const commandDetailSelect = panel.querySelector('#commandDetailSelect');
                
                // æ£€æŸ¥æ˜¯å¦ç„¦ç‚¹åœ¨è¾“å…¥æ¡†ä¸Š
                if (commandDetailInput && document.activeElement === commandDetailInput) {
                    // å¦‚æœç„¦ç‚¹åœ¨è¾“å…¥æ¡†ä¸Šï¼Œè®©è¾“å…¥æ¡†è‡ªå·±å¤„ç†å›è½¦äº‹ä»¶
                    // ä¸åœ¨è¿™é‡Œå¤„ç†ï¼Œé¿å…å†²çª
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦ç„¦ç‚¹åœ¨ä¸‹æ‹‰é€‰æ‹©æ¡†ä¸Š
                if (commandDetailSelect && document.activeElement === commandDetailSelect) {
                    // å¦‚æœç„¦ç‚¹åœ¨ä¸‹æ‹‰é€‰æ‹©æ¡†ä¸Šï¼Œè®©ä¸‹æ‹‰é€‰æ‹©æ¡†è‡ªå·±å¤„ç†äº‹ä»¶
                    // ä¸åœ¨è¿™é‡Œå¤„ç†ï¼Œé¿å…å†²çª
                    return;
                }
                
                if (e.key === 'Enter') {
                    if (commandDetailName) {
                        const commandName = commandDetailName.textContent;
                        // ä» commandList ä¸­æŸ¥æ‰¾å¯¹åº”çš„ command å¯¹è±¡
                        const command = commandList.find(cmd => cmd.name === commandName);
                        // å¦‚æœæ˜¯keywordæˆ–ipå‘½ä»¤ä¸”æœ‰è¾“å…¥å†…å®¹ï¼Œä½¿ç”¨è¾“å…¥çš„å†…å®¹
                        if (command && (command.name === 'keyword' || command.name === 'ip') && commandDetailInput) {
                            const inputValue = commandDetailInput.value.trim();
                            if (inputValue) {
                                if (command.name === 'keyword') {
                                    insertKeywordCommandToInput(input, command, inputValue);
                                } else if (command.name === 'ip') {
                                    insertIpCommandToInput(input, command, inputValue);
                                }
                            } else {
                                insertCommandToInput(input, commandName, command);
                            }
                        } else if (command && command.name === 'filetype' && commandDetailSelect) {
                            // å¦‚æœæ˜¯filetypeå‘½ä»¤ä¸”æœ‰é€‰æ‹©çš„å€¼ï¼Œä½¿ç”¨é€‰æ‹©çš„å€¼
                            const selectedValue = commandDetailSelect.value;
                            if (selectedValue) {
                                insertFiletypeCommandToInput(input, command, selectedValue);
                            } else {
                                insertCommandToInput(input, commandName, command);
                            }
                        } else {
                            insertCommandToInput(input, commandName, command);
                        }
                        hideCommandPanel(panel);
                    }
                    return;
                } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    // åœ¨è¯¦æƒ…è§†å›¾ä¸­ï¼Œä¸Šä¸‹ç®­å¤´è¿”å›åˆ—è¡¨è§†å›¾
                    panel.classList.remove('detail-mode');
                    const selectedItem = panel.querySelector('.command-item.selected');
                    if (selectedItem) {
                        selectedItem.classList.remove('selected');
                    }
                    // ç»§ç»­å¤„ç†ç®­å¤´é”®
                }
            }

            const commandItems = panel.querySelectorAll('.command-item');
            if (commandItems.length === 0) return;

            let currentIndex = -1;
            commandItems.forEach(function(item, index) {
                if (item.classList.contains('selected')) {
                    currentIndex = index;
                    item.classList.remove('selected');
                }
            });

            if (e.key === 'ArrowDown') {
                currentIndex = (currentIndex + 1) % commandItems.length;
            } else if (e.key === 'ArrowUp') {
                currentIndex = (currentIndex - 1 + commandItems.length) % commandItems.length;
            } else if (e.key === 'Enter') {
                // åœ¨åˆ—è¡¨è§†å›¾ä¸­ï¼Œå›è½¦é”®æ˜¾ç¤ºè¯¦æƒ…
                if (currentIndex >= 0 && commandList && commandList[currentIndex]) {
                    const command = commandList[currentIndex];
                    const commandItem = commandItems[currentIndex];
                    commandItem.classList.add('selected');
                    showCommandDetail(panel, command);
                    return;
                }
            }

            if (currentIndex >= 0) {
                commandItems[currentIndex].classList.add('selected');
                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                commandItems[currentIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        // æ˜¾ç¤ºå‘½ä»¤è¯¦æƒ…ï¼ˆå…¨å±€å‡½æ•°ï¼‰
        function showCommandDetail(panel, command) {
            const commandDetailName = panel.querySelector('#commandDetailName');
            const commandDetailContent = panel.querySelector('#commandDetailContent');
            const chatInput = panel.closest('.chat-input-wrapper') ? panel.closest('.chat-input-wrapper').querySelector('.chat-input') : null;
            
            if (commandDetailName && commandDetailContent) {
                commandDetailName.textContent = command.name;
                // æ‰€æœ‰å‘½ä»¤çš„æè¿°æ–‡å­—éƒ½æ”¾åœ¨å¯¹è¯æ¡†(è¾“å…¥æ¡†)å†…,ä¸åœ¨è™šæµ®å±‚æ˜¾ç¤º
                // è·å–è¾“å…¥æ¡†å…ƒç´ 
                let inputElement = commandDetailContent.querySelector('#commandDetailInput');
                // è·å–ä¸‹æ‹‰é€‰æ‹©æ¡†å…ƒç´ 
                let selectElement = commandDetailContent.querySelector('#commandDetailSelect');
                // è·å–å¤é€‰æ¡†å…ƒç´ 
                let checkboxWrapper = commandDetailContent.querySelector('#commandDetailCheckboxWrapper');
                
                // å¦‚æœæ˜¯keywordæˆ–ipå‘½ä»¤ï¼Œæ˜¾ç¤ºè¾“å…¥æ¡†
                if (command.name === 'keyword' || command.name === 'ip') {
                    // éšè—ä¸‹æ‹‰é€‰æ‹©æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (selectElement) {
                        selectElement.classList.add('hidden');
                    }
                    if (!inputElement) {
                        // å¦‚æœè¾“å…¥æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                        inputElement = document.createElement('input');
                        inputElement.type = 'text';
                        inputElement.className = 'command-detail-input';
                        inputElement.id = 'commandDetailInput';
                        // æ ¹æ®å‘½ä»¤ç±»å‹è®¾ç½®ä¸åŒçš„placeholder
                        if (command.name === 'keyword') {
                            inputElement.placeholder = 'è¾“å…¥å…³é”®è¯';
                        } else if (command.name === 'ip') {
                            inputElement.placeholder = 'è¾“å…¥å®Œæ•´IPä¿¡æ¯';
                        }
                        commandDetailContent.appendChild(inputElement);
                        
                        // æ·»åŠ å›è½¦é”®äº‹ä»¶å¤„ç†
                        if (chatInput) {
                            inputElement.addEventListener('keydown', function(e) {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    // è·å–è¾“å…¥çš„å†…å®¹
                                    const inputValue = inputElement.value.trim();
                                    // å¦‚æœæœ‰è¾“å…¥å†…å®¹ï¼Œæ’å…¥åˆ°ä¸»è¾“å…¥æ¡†
                                    if (inputValue) {
                                        if (command.name === 'keyword') {
                                            insertKeywordCommandToInput(chatInput, command, inputValue);
                                        } else if (command.name === 'ip') {
                                            insertIpCommandToInput(chatInput, command, inputValue);
                                        }
                                    } else {
                                        insertCommandToInput(chatInput, command.name, command);
                                    }
                                    hideCommandPanel(panel);
                                }
                            });
                        }
                        
                        // é˜»æ­¢è¾“å…¥æ¡†çš„äº‹ä»¶å†’æ³¡
                        inputElement.addEventListener('click', function(e) {
                            e.stopPropagation();
                        });
                    } else {
                        // å¦‚æœè¾“å…¥æ¡†å·²å­˜åœ¨ï¼Œæ›´æ–°placeholder
                        if (command.name === 'keyword') {
                            inputElement.placeholder = 'è¾“å…¥å…³é”®è¯';
                        } else if (command.name === 'ip') {
                            inputElement.placeholder = 'è¾“å…¥å®Œæ•´IPä¿¡æ¯';
                        }
                    }
                    inputElement.value = ''; // æ¸…ç©ºä¹‹å‰çš„å€¼
                    inputElement.classList.remove('hidden');
                    // èšç„¦åˆ°è¾“å…¥æ¡†
                    setTimeout(function() {
                        inputElement.focus();
                    }, 10);
                } else if (command.name === 'filetype') {
                    // å¦‚æœæ˜¯filetypeå‘½ä»¤ï¼Œæ˜¾ç¤ºä¸‹æ‹‰é€‰æ‹©æ¡†
                    // éšè—è¾“å…¥æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (inputElement) {
                        inputElement.classList.add('hidden');
                    }
                    if (!selectElement) {
                        // å¦‚æœä¸‹æ‹‰é€‰æ‹©æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                        selectElement = document.createElement('select');
                        selectElement.className = 'command-detail-select';
                        selectElement.id = 'commandDetailSelect';
                        // æ·»åŠ æ–‡ä»¶ç±»å‹é€‰é¡¹
                        const fileTypes = [
                            { value: '', text: 'è¯·é€‰æ‹©æ–‡ä»¶ç±»å‹' },
                            { value: 'pdf', text: 'PDF' },
                            { value: 'doc', text: 'DOC' },
                            { value: 'docx', text: 'DOCX' },
                            { value: 'xls', text: 'XLS' },
                            { value: 'xlsx', text: 'XLSX' },
                            { value: 'jpg', text: 'JPG' },
                            { value: 'jpeg', text: 'JPEG' },
                            { value: 'png', text: 'PNG' },
                            { value: 'gif', text: 'GIF' },
                            { value: 'zip', text: 'ZIP' },
                            { value: 'rar', text: 'RAR' },
                            { value: 'txt', text: 'TXT' },
                            { value: 'exe', text: 'EXE' },
                            { value: 'dll', text: 'DLL' }
                        ];
                        fileTypes.forEach(function(option) {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.value;
                            optionElement.textContent = option.text;
                            selectElement.appendChild(optionElement);
                        });
                        commandDetailContent.appendChild(selectElement);
                        
                        // æ·»åŠ é€‰æ‹©å˜åŒ–äº‹ä»¶å¤„ç†
                        if (chatInput) {
                            selectElement.addEventListener('change', function(e) {
                                e.stopPropagation();
                                const selectedValue = selectElement.value;
                                if (selectedValue) {
                                    insertFiletypeCommandToInput(chatInput, command, selectedValue);
                                    // é€‰æ‹©åä¸å…³é—­æ‚¬æµ®å±‚ï¼Œåœç•™åœ¨å½“å‰æ“ä½œ
                                }
                            });
                        }
                        
                        // é˜»æ­¢ä¸‹æ‹‰é€‰æ‹©æ¡†çš„äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¯¦æƒ…åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶
                        selectElement.addEventListener('click', function(e) {
                            e.stopPropagation();
                        });
                    } else {
                        // å¦‚æœä¸‹æ‹‰é€‰æ‹©æ¡†å·²å­˜åœ¨ï¼Œé‡ç½®é€‰æ‹©
                        selectElement.value = '';
                    }
                    selectElement.classList.remove('hidden');
                    // èšç„¦åˆ°ä¸‹æ‹‰é€‰æ‹©æ¡†
                    setTimeout(function() {
                        selectElement.focus();
                    }, 10);
                } else if (command.name === 'ip_connect') {
                    // å¦‚æœæ˜¯ip_connectå‘½ä»¤ï¼Œæ˜¾ç¤ºå¤é€‰æ¡†
                    // éšè—è¾“å…¥æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (inputElement) {
                        inputElement.classList.add('hidden');
                    }
                    // éšè—ä¸‹æ‹‰é€‰æ‹©æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (selectElement) {
                        selectElement.classList.add('hidden');
                    }
                    if (!checkboxWrapper) {
                        // å¦‚æœå¤é€‰æ¡†ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
                        checkboxWrapper = document.createElement('div');
                        checkboxWrapper.className = 'command-detail-checkbox-wrapper';
                        checkboxWrapper.id = 'commandDetailCheckboxWrapper';
                        
                        const checkbox = document.createElement('div');
                        checkbox.className = 'command-detail-checkbox';
                        
                        const checkboxInput = document.createElement('input');
                        checkboxInput.type = 'checkbox';
                        checkboxInput.id = 'commandDetailCheckbox';
                        
                        const checkboxIcon = document.createElement('span');
                        checkboxIcon.className = 'command-detail-checkbox-icon';
                        checkboxIcon.textContent = 'âœ“';
                        
                        checkbox.appendChild(checkboxInput);
                        checkbox.appendChild(checkboxIcon);
                        
                        const checkboxLabel = document.createElement('label');
                        checkboxLabel.className = 'command-detail-checkbox-label';
                        checkboxLabel.setAttribute('for', 'commandDetailCheckbox');
                        checkboxLabel.textContent = 'å›¾è°±å±•ç¤º';
                        
                        checkboxWrapper.appendChild(checkbox);
                        checkboxWrapper.appendChild(checkboxLabel);
                        
                        commandDetailContent.appendChild(checkboxWrapper);
                        
                        // é˜»æ­¢å¤é€‰æ¡†çš„äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¯¦æƒ…åŒºåŸŸçš„ç‚¹å‡»äº‹ä»¶
                        checkboxWrapper.addEventListener('click', function(e) {
                            e.stopPropagation();
                        });
                        
                        // ç›‘å¬å¤é€‰æ¡†çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°æ ·å¼ï¼ˆç”¨äºä¸æ”¯æŒ:has()çš„æµè§ˆå™¨ï¼‰
                        checkboxInput.addEventListener('change', function() {
                            if (this.checked) {
                                checkbox.classList.add('checked');
                            } else {
                                checkbox.classList.remove('checked');
                            }
                        });
                    }
                    checkboxWrapper.classList.remove('hidden');
                } else {
                    // å…¶ä»–å‘½ä»¤éšè—è¾“å…¥æ¡†ã€ä¸‹æ‹‰é€‰æ‹©æ¡†å’Œå¤é€‰æ¡†
                    if (inputElement) {
                        inputElement.classList.add('hidden');
                    }
                    if (selectElement) {
                        selectElement.classList.add('hidden');
                    }
                    if (checkboxWrapper) {
                        checkboxWrapper.classList.add('hidden');
                    }
                }
                panel.classList.add('detail-mode');
            }
        }

        // éšè—å‘½ä»¤è¯¦æƒ…ï¼ˆå…¨å±€å‡½æ•°ï¼‰
        function hideCommandDetail(panel) {
            if (!panel) {
                // å¦‚æœæ²¡æœ‰ä¼ å…¥panelï¼ŒæŸ¥æ‰¾æ‰€æœ‰é¢æ¿
                const panels = document.querySelectorAll('.command-panel.detail-mode');
                panels.forEach(function(p) {
                    p.classList.remove('detail-mode');
                });
            } else {
                panel.classList.remove('detail-mode');
            }
            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            const selectedItems = document.querySelectorAll('.command-item.selected');
            selectedItems.forEach(function(item) {
                item.classList.remove('selected');
            });
        }

        // ç”ŸæˆAIå›å¤ï¼ˆæ¨¡æ‹Ÿï¼‰
        function generateAIResponse(userMessage) {
            var message = userMessage.toLowerCase();
            
            // æ ¹æ®ç”¨æˆ·æ¶ˆæ¯å†…å®¹ç”Ÿæˆç›¸åº”çš„å›å¤
            if (message.includes('å¼‚å¸¸') || message.includes('æµé‡')) {
                return 'æˆ‘å·²ç»åˆ†æäº†ç½‘ç»œæµé‡æ•°æ®ã€‚æ£€æµ‹åˆ°ä»¥ä¸‹å¼‚å¸¸æƒ…å†µï¼š\n\n1. ç«¯å£æ‰«ææ´»åŠ¨ï¼šå‘ç°æ¥è‡ª 192.168.1.100 çš„ç«¯å£æ‰«æè¡Œä¸º\n2. å¼‚å¸¸DNSæŸ¥è¯¢ï¼šæ£€æµ‹åˆ° 15 ä¸ªå¯ç–‘çš„DNSæŸ¥è¯¢\n3. å¤§æµé‡ä¼ è¾“ï¼šå‘ç°å¼‚å¸¸çš„å¤§æ–‡ä»¶ä¼ è¾“æ´»åŠ¨\n\nå»ºè®®ç«‹å³æ£€æŸ¥ç›¸å…³ä¸»æœºçš„å®‰å…¨çŠ¶æ€ã€‚';
            } else if (message.includes('åè®®') || message.includes('åˆ†æ')) {
                return 'åè®®åˆ†æç»“æœæ˜¾ç¤ºï¼š\n\n- TCPåè®®ï¼šå ä¸»å¯¼åœ°ä½ï¼Œä¸»è¦ç”¨äºHTTP/HTTPSé€šä¿¡\n- UDPåè®®ï¼šä¸»è¦ç”¨äºDNSæŸ¥è¯¢\n- æ£€æµ‹åˆ°å°‘é‡éæ ‡å‡†åè®®æ•°æ®åŒ…ï¼Œéœ€è¦è¿›ä¸€æ­¥å®¡æŸ¥\n\néœ€è¦æˆ‘è¯¦ç»†åˆ†ææŸä¸ªç‰¹å®šåè®®å—ï¼Ÿ';
            } else if (message.includes('å¨èƒ') || message.includes('å®‰å…¨')) {
                return 'å®‰å…¨å¨èƒè¯„ä¼°ç»“æœï¼š\n\nå¨èƒç­‰çº§ï¼šä¸­ç­‰\n\nä¸»è¦å¨èƒï¼š\n1. ç–‘ä¼¼ç«¯å£æ‰«ææ”»å‡»\n2. å¯ç–‘DNSæŸ¥è¯¢æ´»åŠ¨\n3. å¼‚å¸¸æ•°æ®ä¼ è¾“\n\nå»ºè®®æªæ–½ï¼š\n- æ£€æŸ¥ç›¸å…³ä¸»æœºçš„å®‰å…¨çŠ¶æ€\n- å®¡æŸ¥DNSæŸ¥è¯¢æ—¥å¿—\n- åŠ å¼ºç½‘ç»œè¾¹ç•Œé˜²æŠ¤';
            } else if (message.includes('å¸®åŠ©') || message.includes('åŠŸèƒ½')) {
                return 'æˆ‘æ”¯æŒä»¥ä¸‹åˆ†æåŠŸèƒ½ï¼š\n\n1. å¼‚å¸¸æµé‡æ£€æµ‹ - è¯†åˆ«å¯ç–‘çš„ç½‘ç»œæ´»åŠ¨\n2. åè®®åˆ†æ - åˆ†æç½‘ç»œåè®®åˆ†å¸ƒå’Œç‰¹å¾\n3. å®‰å…¨å¨èƒè¯†åˆ« - è¯„ä¼°æ½œåœ¨çš„å®‰å…¨å¨èƒ\n4. ç½‘ç»œè¡Œä¸ºåˆ†æ - åˆ†æç½‘ç»œé€šä¿¡æ¨¡å¼\n5. æ•°æ®åŒ…ç»Ÿè®¡ - æä¾›è¯¦ç»†çš„æµé‡ç»Ÿè®¡ä¿¡æ¯\n\nè¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦åˆ†æçš„å…·ä½“å†…å®¹ã€‚';
            } else {
                return 'æˆ‘ç†è§£æ‚¨çš„éœ€æ±‚ã€‚ä½œä¸ºPcapåŒ…åˆ†ææ™ºèƒ½ä½“ï¼Œæˆ‘å¯ä»¥å¸®åŠ©æ‚¨ï¼š\n\n- åˆ†æç½‘ç»œæ•°æ®åŒ…\n- æ£€æµ‹å¼‚å¸¸æµé‡\n- è¯†åˆ«å®‰å…¨å¨èƒ\n- æä¾›è¯¦ç»†çš„åˆ†ææŠ¥å‘Š\n\nè¯·ä¸Šä¼ Pcapæ–‡ä»¶æˆ–æè¿°æ‚¨çš„å…·ä½“åˆ†æéœ€æ±‚ã€‚';
            }
        }
    </script>
</body>
</html>

