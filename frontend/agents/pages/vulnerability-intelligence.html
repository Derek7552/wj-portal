<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="æ¼æ´æƒ…æŠ¥æ™ºèƒ½ä½“ - æ¼æ´ä¿¡æ¯èšåˆã€å…³è”åˆ†æä¸é£é™©è¯„ä¼°">
    <title>æ¼æ´æƒ…æŠ¥ - äº‘è„‘</title>
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/dashboard.css">
    <link rel="stylesheet" href="../../templates/css/template-detail.css">
    <link rel="stylesheet" href="../../templates/css/template-planning.css">
    <link rel="stylesheet" href="../../components/agent-sidebar.css">
    <link rel="stylesheet" href="../../components/chat-input.css">
    <link rel="stylesheet" href="../css/vulnerability-intelligence.css">
</head>
<body class="agent-detail-page">
    <!-- å·¦ä¾§ä¸»å¯¼èˆªæ  - æ™ºèƒ½ä½“è¯¦æƒ…é¡µæ¨¡å¼ï¼ˆæ”¶èµ·ï¼‰ -->
    <aside class="sidebar collapsed" id="sidebar">
        <!-- Logo åŒº -->
        <div class="sidebar-logo">
            <a href="../../dashboard.html" class="logo-link" title="äº‘è„‘">
                <div class="logo-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="6" fill="#2563EB"/>
                        <path d="M16 8L20 14H12L16 8Z" fill="white"/>
                        <path d="M10 18L14 24H6L10 18Z" fill="white" opacity="0.8"/>
                        <path d="M22 18L26 24H18L22 18Z" fill="white" opacity="0.8"/>
                    </svg>
                </div>
                <h1 class="logo-text">äº‘è„‘</h1>
            </a>
        </div>

        <!-- ä¸»å¯¼èˆªèœå• -->
        <div class="sidebar-content">
            <nav class="sidebar-nav">
                <!-- é¦–é¡µ - å¸¦æ”¶è—å¿«æ·å…¥å£ -->
                <div class="nav-item-home-wrapper">
                    <a href="../../dashboard.html" class="nav-item nav-item-home" title="é¦–é¡µ">
                        <span class="nav-icon">ğŸ </span>
                        <span class="nav-text">é¦–é¡µ</span>
                    </a>
                    <div class="home-menu" id="homeMenu">
                        <a href="../../dashboard.html" class="home-menu-favorite-item">
                            <span class="home-menu-favorite-icon">ğŸ </span>
                            <span class="home-menu-favorite-name">é¦–é¡µ</span>
                        </a>
                        <div class="home-menu-favorites" id="homeMenuFavorites">
                            <div class="home-menu-favorites-empty" id="homeMenuFavoritesEmpty" style="display: none;">
                                <p class="home-menu-empty-text">æš‚æ— æ”¶è—</p>
                            </div>
                            <div class="home-menu-favorites-list" id="homeMenuFavoritesList"></div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- åº•éƒ¨å¯¼èˆª -->
            <nav class="sidebar-nav-bottom">
                <a href="../../templates.html" class="nav-item" title="UIæ¨¡æ¿">
                    <span class="nav-icon">ğŸ“</span>
                    <span class="nav-text">UIæ¨¡æ¿</span>
                </a>

                <a href="#" class="nav-item" title="å¸®åŠ©ä¸­å¿ƒ">
                    <span class="nav-icon">â“</span>
                    <span class="nav-text">å¸®åŠ©ä¸­å¿ƒ</span>
                </a>

                <a href="#" class="nav-item" title="ç”¨æˆ·åé¦ˆ">
                    <span class="nav-icon">ğŸ’¬</span>
                    <span class="nav-text">ç”¨æˆ·åé¦ˆ</span>
                </a>

                <div class="nav-item-user-wrapper">
                    <a href="#" class="nav-item nav-item-user" id="userNavItem" title="ä¸ªäººä¸­å¿ƒ">
                        <div class="user-avatar" id="userAvatar">T</div>
                        <span class="user-name" id="userName">æµ‹è¯•ç”¨æˆ·</span>
                    </a>
                    <div class="user-menu" id="userMenu">
                        <a href="../../pages/user-management.html" class="user-menu-item">
                            <span class="nav-icon">ğŸ‘¤</span>
                            <span class="nav-text">ä¸ªäººä¸­å¿ƒ</span>
                        </a>
                        <button class="user-menu-item nav-item-logout" id="logoutBtn">
                            <span class="nav-icon">ğŸšª</span>
                            <span class="nav-text">é€€å‡ºç™»å½•</span>
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content-area">
        <!-- æ™ºèƒ½ä½“å¤´éƒ¨ä¿¡æ¯ -->
        <div class="agent-header">
            <div class="agent-header-main">
                <div class="agent-icon">ğŸ”</div>
                <div class="agent-info">
                    <div class="agent-title-wrapper">
                        <h2 class="agent-title">æ¼æ´æƒ…æŠ¥</h2>
                        <span class="agent-type">åŸºç¡€ç±»</span>
                        <span class="agent-version">v1.1.0</span>
                    </div>
                    <p class="agent-description">æ¼æ´ä¿¡æ¯èšåˆã€å…³è”åˆ†æä¸é£é™©è¯„ä¼°ï¼Œå¿«é€Ÿè¯„ä¼°æ–°æ¼æ´çš„å½±å“å’Œå¯åˆ©ç”¨æ€§ï¼Œæä¾›ä¸“ä¸šçš„æ¼æ´æƒ…æŠ¥åˆ†æå’Œé˜²æŠ¤å»ºè®®</p>
                </div>
            </div>
            <!-- ç®¡ç†åŠŸèƒ½æŒ‰é’®ç»„ -->
            <div class="agent-header-actions">
                <button class="btn-agent-action" title="æ¼æ´æŠ«éœ²">
                    <span class="action-icon">ğŸ“¢</span>
                    <span class="action-text">æ¼æ´æŠ«éœ²</span>
                    <span class="action-count">(10)</span>
                </button>
                <button class="btn-agent-action" title="æ¼æ´æ›´æ–°">
                    <span class="action-icon">ğŸ”„</span>
                    <span class="action-text">æ¼æ´æ›´æ–°</span>
                    <span class="action-count">(10)</span>
                </button>
                <button class="btn-agent-action" title="çŸ¥è¯†åº“">
                    <span class="action-icon">ğŸ“š</span>
                    <span class="action-text">çŸ¥è¯†åº“</span>
                    <span class="action-count">(25)</span>
                </button>
                <button class="btn-agent-action" title="å·¥å…·æ’ä»¶">
                    <span class="action-icon">ğŸ”§</span>
                    <span class="action-text">å·¥å…·æ’ä»¶</span>
                    <span class="action-count">(8)</span>
                </button>
                <button class="btn-agent-action" title="æ™ºèƒ½ä½“è®¾ç½®">
                    <span class="action-icon">âš™ï¸</span>
                    <span class="action-text">è®¾ç½®</span>
                </button>
                <button class="btn btn-primary btn-sm">
                    <span>ğŸ”—</span>
                    <span>åˆ†äº«</span>
                </button>
            </div>
        </div>

        <!-- å†…å®¹å®¹å™¨ -->
        <div class="content-container">
            <!-- æ™ºèƒ½ä½“è¯¦æƒ…ä¾§å¯¼èˆª -->
            <aside class="agent-sidebar">
                <nav class="agent-nav">
                    <!-- æ–°ä»»åŠ¡æŒ‰é’® -->
                    <button class="btn-new-chat">
                        <span class="btn-icon">âœ¨</span>
                        <span class="btn-text">æ–°ä»»åŠ¡</span>
                    </button>

                    <!-- è¿‘æœŸä»»åŠ¡ -->
                    <div class="nav-group">
                        <div class="nav-group-title">è¿‘æœŸä»»åŠ¡</div>

                        <!-- è¿‘æœŸä»»åŠ¡åˆ—è¡¨ -->
                        <div class="recent-tasks-list">
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon running">â³</span>
                                <div class="task-name">CVE-2024-1234æ¼æ´åˆ†æ</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon running">â³</span>
                                <div class="task-name">Log4jæ¼æ´å½±å“è¯„ä¼°</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">Springæ¡†æ¶æ¼æ´åˆ†æ</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">Apacheæ¼æ´æƒ…æŠ¥æŸ¥è¯¢</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">é›¶æ—¥æ¼æ´é£é™©è¯„ä¼°</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">OpenSSLæ¼æ´å…³è”åˆ†æ</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">WordPressæ’ä»¶æ¼æ´æŸ¥è¯¢</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">Node.jsæ¼æ´å½±å“åˆ†æ</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">Pythonåº“æ¼æ´æƒ…æŠ¥</div>
                            </a>
                            <a href="#" class="recent-task-item">
                                <span class="task-status-icon completed">âœ…</span>
                                <div class="task-name">Dockeré•œåƒæ¼æ´æ‰«æ</div>
                            </a>
                        </div>

                        <!-- æŸ¥çœ‹å…¨éƒ¨å…¥å£ -->
                        <a href="#" class="view-all-tasks">
                            æŸ¥çœ‹å…¨éƒ¨ä»»åŠ¡è®°å½• â†’
                        </a>
                    </div>
                </nav>
            </aside>

            <!-- ä¸»å†…å®¹åŒºåŸŸ - ç©ºçŠ¶æ€ -->
            <div class="agent-main-content">
                <div class="empty-state-container">
                    <!-- æ™ºèƒ½ä½“åç§° - ä¼˜å…ˆçº§æœ€é«˜ -->
                    <div class="empty-agent-name">
                        <span class="agent-name-text">æ¼æ´æƒ…æŠ¥</span>
                    </div>

                    <!-- å¼•å¯¼æ–‡æ¡ˆ - æ¬¡è¦ä¼˜å…ˆçº§ -->
                    <div class="empty-state-guide">
                        <p class="empty-state-guide-text">å¼€å§‹ç»™æ™ºèƒ½ä½“åˆ†é…ä»»åŠ¡</p>
                    </div>

                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="chat-input-container" data-container-mode="empty">
                        <div class="chat-input-wrapper">
                            <!-- è¾“å…¥æ¡†åŒºåŸŸ -->
                            <textarea
                                class="chat-input"
                                id="chatInput"
                                placeholder="è¾“å…¥CVEç¼–å·ã€æ¼æ´å…³é”®è¯æˆ–æŸ¥è¯¢éœ€æ±‚..."
                                rows="3"
                            ></textarea>

                            <!-- å·¥å…·æ ï¼šå·¦ä¾§æ“ä½œæŒ‰é’® + å³ä¾§å‘é€æŒ‰é’® -->
                            <div class="chat-input-toolbar">
                                <div class="chat-input-actions">
                                    <button class="btn-icon" title="ä¸Šä¼ æ–‡ä»¶">
                                        ğŸ“
                                    </button>
                                    <button class="btn-icon" title="æ’å…¥å›¾ç‰‡">
                                        ğŸ–¼ï¸
                                    </button>
                                    <button class="btn-icon" title="æ’å…¥ä»£ç ">
                                        ğŸ’»
                                    </button>
                                    <button class="btn-icon" title="æ’å…¥è¡¨æ ¼">
                                        ğŸ“Š
                                    </button>
                                </div>
                                <button class="btn btn-primary chat-send" id="chatSend">
                                    <span>å‘é€</span>
                                    <span class="send-shortcut">Shift+Enter</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../../js/dashboard.js"></script>
    <script src="../../components/agent-sidebar.js"></script>
    <script src="../../components/chat-input.js"></script>
    <script src="../../templates/js/template-detail.js"></script>
    <script>
        // æ¨¡æ‹Ÿä»»åŠ¡æ•°æ®
        const mockTasks = [
            { id: '1', name: 'CVE-2024-1234æ¼æ´åˆ†æ', status: 'running', active: false },
            { id: '2', name: 'Log4jæ¼æ´å½±å“è¯„ä¼°', status: 'running', active: false },
            { id: '3', name: 'Springæ¡†æ¶æ¼æ´åˆ†æ', status: 'completed', active: false },
            { id: '4', name: 'Apacheæ¼æ´æƒ…æŠ¥æŸ¥è¯¢', status: 'completed', active: false },
            { id: '5', name: 'é›¶æ—¥æ¼æ´é£é™©è¯„ä¼°', status: 'completed', active: false },
            { id: '6', name: 'OpenSSLæ¼æ´å…³è”åˆ†æ', status: 'completed', active: false },
            { id: '7', name: 'WordPressæ’ä»¶æ¼æ´æŸ¥è¯¢', status: 'completed', active: false },
            { id: '8', name: 'Node.jsæ¼æ´å½±å“åˆ†æ', status: 'completed', active: false },
            { id: '9', name: 'Pythonåº“æ¼æ´æƒ…æŠ¥', status: 'completed', active: false },
            { id: '10', name: 'Dockeré•œåƒæ¼æ´æ‰«æ', status: 'completed', active: false }
        ];

        // ç”Ÿæˆæ¼æ´è¯¦æƒ…é¡µé¢ï¼ˆå·¦å³å¸ƒå±€ï¼‰
        function generateVulnerabilityDetailLayout(taskData) {
            var taskName = taskData ? taskData.name : 'æœªçŸ¥ä»»åŠ¡';
            var cveNumber = taskName.match(/CVE-\d{4}-\d+/)?.[0] || 'CVE-2024-1234';

            return '<div class="vulnerability-detail-layout">' +
                '<!-- å·¦ä¾§ï¼šæ¼æ´ä¿¡æ¯é¢æ¿ -->' +
                '<div class="vulnerability-info-panel">' +
                    '<div class="vulnerability-info-content">' +
                        '<!-- åŸºæœ¬ä¿¡æ¯ -->' +
                        '<div class="vulnerability-info-section">' +
                            '<div class="vulnerability-section-title">åŸºæœ¬ä¿¡æ¯</div>' +
                            '<table class="vulnerability-info-table">' +
                                '<tbody>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">æ¼æ´åç§°ï¼š</td>' +
                                        '<td class="vulnerability-table-value">OpenPAM æˆæƒé—®é¢˜æ¼æ´</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">æ¼æ´ç¼–å·ï¼š</td>' +
                                        '<td class="vulnerability-table-value">' +
                                            '<span class="vulnerability-cve-badge">' + cveNumber + '</span>' +
                                            '<span class="vulnerability-cve-badge">YQ-2014-0004548</span>' +
                                            '<span class="vulnerability-cve-badge">CNVD-2014-03512</span>' +
                                            '<span class="vulnerability-cve-badge">CNNVD-201406-627</span>' +
                                        '</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">å…³è” CWEï¼š</td>' +
                                        '<td class="vulnerability-table-value"><code>CWE-287</code></td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">æ¼æ´ç­‰çº§ï¼š</td>' +
                                        '<td class="vulnerability-table-value">' +
                                            '<span class="vulnerability-severity-badge severe">ä¸¥é‡</span>' +
                                        '</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">æ¼æ´è¯„åˆ†ï¼š</td>' +
                                        '<td class="vulnerability-table-value">' +
                                            '<span class="vulnerability-score">9.8</span>' +
                                        '</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">æ¼æ´ç±»å‹ï¼š</td>' +
                                        '<td class="vulnerability-table-value">æˆæƒé—®é¢˜æ¼æ´</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">æŠ«éœ²æ—¶é—´ï¼š</td>' +
                                        '<td class="vulnerability-table-value">2014-06-10T00:00:00</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">æ›´æ–°æ—¶é—´ï¼š</td>' +
                                        '<td class="vulnerability-table-value">2025-12-27T17:55:41.110329</td>' +
                                    '</tr>' +
                                '</tbody>' +
                            '</table>' +
                        '</div>' +
                        '<!-- æ¼æ´å½±å“ -->' +
                        '<div class="vulnerability-info-section">' +
                            '<div class="vulnerability-section-title">æ¼æ´å½±å“</div>' +
                            '<table class="vulnerability-info-table">' +
                                '<tbody>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">å½±å“å‚å•†ï¼š</td>' +
                                        '<td class="vulnerability-table-value">FreeBSD</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">å½±å“äº§å“ï¼š</td>' +
                                        '<td class="vulnerability-table-value">OpenPAM</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">å½±å“ç»„ä»¶ï¼š</td>' +
                                        '<td class="vulnerability-table-value">PAMæ¶æ„-9.2è‡³10.0ç‰ˆæœ¬</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">å½±å“é¡¹ç›®ï¼š</td>' +
                                        '<td class="vulnerability-table-value">æš‚æ— </td>' +
                                    '</tr>' +
                                '</tbody>' +
                            '</table>' +
                        '</div>' +
                        '<!-- æ¼æ´ä¿®å¤ -->' +
                        '<div class="vulnerability-info-section">' +
                            '<div class="vulnerability-section-title">æ¼æ´ä¿®å¤</div>' +
                            '<table class="vulnerability-info-table">' +
                                '<tbody>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">ä¿®å¤å»ºè®®ï¼š</td>' +
                                        '<td class="vulnerability-table-value">å°†freebsd freebsdå‡çº§åˆ°9.2ä¹‹ä¸Š</td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">ä¿®å¤ commitï¼š</td>' +
                                        '<td class="vulnerability-table-value">æš‚æ— </td>' +
                                    '</tr>' +
                                    '<tr>' +
                                        '<td class="vulnerability-table-label">ä¿®å¤ patchï¼š</td>' +
                                        '<td class="vulnerability-table-value">æš‚æ— </td>' +
                                    '</tr>' +
                                '</tbody>' +
                            '</table>' +
                        '</div>' +
                        '<!-- æ¥æºä¿¡æ¯ï¼ˆå¯æŠ˜å ï¼‰ -->' +
                        '<div class="vulnerability-info-section vulnerability-collapsible-section">' +
                            '<div class="vulnerability-collapsible-header">' +
                                '<div class="vulnerability-collapsible-title">æ¥æºä¿¡æ¯</div>' +
                                '<div class="vulnerability-collapsible-icon">â–¶</div>' +
                            '</div>' +
                            '<div class="vulnerability-collapsible-content">' +
                                '<div class="vulnerability-info-field">' +
                                    '<div class="vulnerability-field-label">æ¥æº</div>' +
                                    '<div class="vulnerability-field-value">å¾…è¡¥å……</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<!-- å³ä¾§ï¼šäº¤äº’é¢æ¿ -->' +
                '<div class="vulnerability-interaction-panel">' +
                    '<!-- æ ‡ç­¾é¡µå¯¼èˆª -->' +
                    '<div class="vulnerability-tabs">' +
                        '<button class="vulnerability-tab active" data-tab="conversation">' +
                            '<span>å¯¹è¯</span>' +
                        '</button>' +
                        '<button class="vulnerability-tab" data-tab="poc">' +
                            '<span>POC</span>' +
                        '</button>' +
                        '<button class="vulnerability-tab" data-tab="troubleshooting">' +
                            '<span>æ’æŸ¥</span>' +
                        '</button>' +
                    '</div>' +
                    '<!-- æ ‡ç­¾é¡µå†…å®¹ -->' +
                    '<div class="vulnerability-tab-content active" data-tab-content="conversation">' +
                        '<div class="chat-container vulnerability-chat-container">' +
                            '<div class="chat-messages" id="vulnerabilityChatMessages">' +
                                '<!-- AIæ¶ˆæ¯ç¤ºä¾‹ -->' +
                                '<div class="message message-ai">' +
                                    '<div class="message-avatar">ğŸ¤–</div>' +
                                    '<div class="message-content">' +
                                        '<div class="message-time">åˆšåˆš</div>' +
                                        '<div class="message-bubble">' +
                                            '<p>ä½ å¥½ï¼æˆ‘æ˜¯æ¼æ´æƒ…æŠ¥æ™ºèƒ½ä½“ï¼Œå¯ä»¥å¸®åŠ©ä½ åˆ†ææ¼æ´ä¿¡æ¯ã€è¯„ä¼°å½±å“èŒƒå›´ã€æä¾›ä¿®å¤å»ºè®®ç­‰ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</p>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="vulnerability-tab-content" data-tab-content="poc">' +
                        '<div class="vulnerability-tab-body">' +
                            '<div class="vulnerability-empty-state">æš‚æ— POCå†…å®¹</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="vulnerability-tab-content" data-tab-content="troubleshooting">' +
                        '<div class="vulnerability-tab-body">' +
                            '<div class="vulnerability-empty-state">æš‚æ— æ’æŸ¥å†…å®¹</div>' +
                        '</div>' +
                    '</div>' +
                    '<!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->' +
                    '<div class="chat-input-container" data-container-mode="fixed">' +
                        '<div class="chat-input-wrapper">' +
                            '<textarea class="chat-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="3"></textarea>' +
                            '<div class="chat-input-toolbar">' +
                                '<div class="chat-input-actions">' +
                                    '<button class="btn-icon" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>' +
                                    '<button class="btn-icon" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button>' +
                                    '<button class="btn-icon" title="æ’å…¥ä»£ç ">ğŸ’»</button>' +
                                    '<button class="btn-icon" title="æ’å…¥è¡¨æ ¼">ğŸ“Š</button>' +
                                '</div>' +
                                '<button class="btn btn-primary chat-send" id="vulnerabilityChatSend">' +
                                    '<span>å‘é€</span>' +
                                    '<span class="send-shortcut">Shift+Enter</span>' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // åˆå§‹åŒ–æ¼æ´è¯¦æƒ…é¡µé¢çš„äº¤äº’åŠŸèƒ½
        function initVulnerabilityDetailInteractions(container) {
            // æŠ˜å åŒºåŸŸåˆ‡æ¢
            var collapsibleHeaders = container.querySelectorAll('.vulnerability-collapsible-header');
            collapsibleHeaders.forEach(function(header) {
                header.addEventListener('click', function() {
                    var section = this.closest('.vulnerability-collapsible-section');
                    section.classList.toggle('expanded');
                });
            });

            // æ ‡ç­¾é¡µåˆ‡æ¢
            var tabs = container.querySelectorAll('.vulnerability-tab');
            tabs.forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var tabName = this.getAttribute('data-tab');
                    var panel = this.closest('.vulnerability-interaction-panel');
                    
                    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeçŠ¶æ€
                    var allTabs = panel.querySelectorAll('.vulnerability-tab');
                    allTabs.forEach(function(t) {
                        t.classList.remove('active');
                    });
                    // æ·»åŠ å½“å‰æ ‡ç­¾çš„activeçŠ¶æ€
                    this.classList.add('active');

                    // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
                    var contents = panel.querySelectorAll('.vulnerability-tab-content');
                    contents.forEach(function(content) {
                        content.classList.remove('active');
                    });
                    // æ˜¾ç¤ºå½“å‰æ ‡ç­¾é¡µå†…å®¹
                    var activeContent = panel.querySelector('[data-tab-content="' + tabName + '"]');
                    if (activeContent) {
                        activeContent.classList.add('active');
                    }
                });
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ä¾§å¯¼èˆªç»„ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (typeof initAgentSidebar === 'function') {
                window.agentSidebarInstance = initAgentSidebar({
                tasks: mockTasks,
                maxTasks: 10,
                onNewTask: function() {
                    console.log('åˆ›å»ºæ–°ä»»åŠ¡');
                    // ç‚¹å‡»æ–°ä»»åŠ¡æŒ‰é’®æ—¶ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€é¡µé¢
                    var chatArea = document.querySelector('.agent-main-content');
                    if (!chatArea) return;

                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç©ºçŠ¶æ€å®¹å™¨
                    var emptyStateContainer = document.querySelector('.empty-state-container');
                    var taskContent = document.querySelector('.task-detail-content');
                    var tasksList = document.querySelector('.tasks-list-container');

                    // å¦‚æœå·²æœ‰ç©ºçŠ¶æ€å®¹å™¨ï¼Œç›´æ¥æ˜¾ç¤º
                    if (emptyStateContainer) {
                        emptyStateContainer.style.display = 'flex';
                        if (taskContent) taskContent.style.display = 'none';
                        if (tasksList) tasksList.style.display = 'none';
                        return;
                    }

                    // å¦åˆ™é‡æ–°åˆ›å»ºç©ºçŠ¶æ€é¡µé¢
                    chatArea.innerHTML = '<div class="empty-state-container">' +
                        '<div class="empty-agent-name">' +
                            '<span class="agent-name-text">æ¼æ´æƒ…æŠ¥</span>' +
                        '</div>' +
                        '<div class="empty-state-guide">' +
                            '<p class="empty-state-guide-text">å¼€å§‹ç»™æ™ºèƒ½ä½“åˆ†é…ä»»åŠ¡</p>' +
                        '</div>' +
                        '<div class="chat-input-container" data-container-mode="empty">' +
                            '<div class="chat-input-wrapper">' +
                                '<textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥CVEç¼–å·ã€æ¼æ´å…³é”®è¯æˆ–æŸ¥è¯¢éœ€æ±‚..." rows="3"></textarea>' +
                                '<div class="chat-input-toolbar">' +
                                    '<div class="chat-input-actions">' +
                                        '<button class="btn-icon" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>' +
                                        '<button class="btn-icon" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button>' +
                                        '<button class="btn-icon" title="æ’å…¥ä»£ç ">ğŸ’»</button>' +
                                        '<button class="btn-icon" title="æ’å…¥è¡¨æ ¼">ğŸ“Š</button>' +
                                    '</div>' +
                                    '<button class="btn btn-primary chat-send" id="chatSend">' +
                                        '<span>å‘é€</span>' +
                                        '<span class="send-shortcut">Shift+Enter</span>' +
                                    '</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                },
                onTaskClick: function(taskId, taskData) {
                    console.log('[DEBUG] ç‚¹å‡»ä»»åŠ¡:', taskId, taskData);

                    try {
                        var chatArea = document.querySelector('.agent-main-content');
                        if (!chatArea) {
                            console.error('[DEBUG] æœªæ‰¾åˆ°chatArea');
                            return;
                        }

                        console.log('[DEBUG] æ‰¾åˆ°chatArea');

                        // æ¸…ç©ºchatAreaå†…å®¹ï¼Œé‡æ–°åˆ›å»ºä»»åŠ¡è¯¦æƒ…
                        var taskName = (taskData && taskData.name) ? taskData.name : 'æœªçŸ¥ä»»åŠ¡';

                        // æ£€æŸ¥æ˜¯å¦æ˜¯ CVE-2024-1234 æ¼æ´åˆ†æä»»åŠ¡ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºå·¦å³å¸ƒå±€
                        if (taskName.includes('CVE-2024-1234')) {
                            chatArea.innerHTML = generateVulnerabilityDetailLayout(taskData);
                            
                            // åˆå§‹åŒ–äº¤äº’åŠŸèƒ½
                            initVulnerabilityDetailInteractions(chatArea);
                            
                            // åˆå§‹åŒ–è¾“å…¥æ¡†åŠŸèƒ½ï¼ˆä½¿ç”¨chat-inputç»„ä»¶ï¼‰
                            initChatInput({
                                selector: '.vulnerability-interaction-panel .chat-input-container',
                                onSend: function(message) {
                                    console.log('å‘é€æ¶ˆæ¯:', message);
                                    // TODO: å®é™…å‘é€æ¶ˆæ¯åˆ°åç«¯
                                    // è¿™é‡Œå¯ä»¥æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åˆ—è¡¨çš„é€»è¾‘
                                }
                            });
                            
                            return;
                        }

                        // æ¸…ç©ºchatAreaå¹¶é‡æ–°åˆ›å»ºä»»åŠ¡è¯¦æƒ…ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
                        chatArea.innerHTML = '';

                        var taskContent = document.createElement('div');
                        taskContent.className = 'task-detail-content';

                        // è·å–ä»»åŠ¡åˆ›å»ºæ—¶é—´ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                        var createTime = '14:30';
                        if (taskData && taskData.createTime) {
                            var timeParts = taskData.createTime.split(' ');
                            if (timeParts.length > 1) {
                                createTime = timeParts[1].substring(0, 5); // æå– HH:mm
                            }
                        }

                        // æ ¹æ®ä»»åŠ¡åç§°ç”Ÿæˆä»»åŠ¡åˆ›å»ºæ¶ˆæ¯
                        var taskCreateMessage = 'ä»»åŠ¡å·²åˆ›å»ºï¼š' + taskName.replace('æ¼æ´åˆ†æ', 'æ¼æ´çš„è¯¦ç»†ä¿¡æ¯å’Œå½±å“èŒƒå›´');
                        if (!taskCreateMessage.includes('æ¼æ´')) {
                            taskCreateMessage = 'ä»»åŠ¡å·²åˆ›å»ºï¼š' + taskName;
                        }
                        
                        // ä»ä»»åŠ¡åç§°ä¸­æå– CVE ç¼–å·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        var cveNumber = taskName.match(/CVE-\d{4}-\d+/)?.[0] || 'CVE-2024-1234';
                        var analysisTarget = taskName.includes('CVE') ? cveNumber : taskName;

                        taskContent.innerHTML = '<div class="chat-header">' +
                            '<div class="chat-title">' + taskName + '</div>' +
                            '<div class="chat-time">' + (taskData && taskData.createTime ? taskData.createTime.split(' ')[0] : 'åˆšåˆš') + '</div>' +
                        '</div>' +
                        '<div class="chat-messages" id="chatMessages">' +
                            '<!-- ç³»ç»Ÿæ¶ˆæ¯ - ä»»åŠ¡åˆ›å»º -->' +
                            '<div class="message message-system">' +
                                '<div class="message-avatar">ğŸ¯</div>' +
                                '<div class="message-content">' +
                                    '<div class="message-time">' + createTime + '</div>' +
                                    '<div class="message-text">' + taskCreateMessage + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<!-- ä»»åŠ¡æ„å›¾è¯†åˆ« -->' +
                            '<div class="message message-ai">' +
                                '<div class="message-avatar">ğŸ¤–</div>' +
                                '<div class="message-content">' +
                                    '<div class="message-time">' + createTime + '</div>' +
                                    '<div class="intent-card">' +
                                        '<div class="intent-header">' +
                                            '<span class="intent-icon">ğŸ’¬</span>' +
                                            '<span class="intent-title">ä»»åŠ¡æ„å›¾è¯†åˆ«</span>' +
                                        '</div>' +
                                        '<div class="intent-content">' +
                                            '<p><strong>ä»»åŠ¡ç±»å‹ï¼š</strong>æ¼æ´æƒ…æŠ¥åˆ†æ</p>' +
                                            '<p><strong>åˆ†æå¯¹è±¡ï¼š</strong>' + analysisTarget + '</p>' +
                                            '<p><strong>é¢„æœŸç›®æ ‡ï¼š</strong>è¯†åˆ«æ¼æ´è¯¦æƒ…ã€è¯„ä¼°å½±å“èŒƒå›´ã€æä¾›ä¿®å¤å»ºè®®</p>' +
                                        '</div>' +
                                    '</div>' +
                                    '<!-- ä»»åŠ¡è§„åˆ’ -->' +
                                    '<div class="planning-card">' +
                                        '<div class="planning-header">' +
                                            '<span class="planning-icon">ğŸ“‹</span>' +
                                            '<span class="planning-title">ä»»åŠ¡æ‰§è¡Œè§„åˆ’</span>' +
                                        '</div>' +
                                        '<div class="planning-stages">' +
                                            '<div class="stage-item">' +
                                                '<span class="stage-number">1</span>' +
                                                '<span class="stage-name">æ¼æ´åŸºæœ¬ä¿¡æ¯æŸ¥è¯¢</span>' +
                                            '</div>' +
                                            '<div class="stage-item">' +
                                                '<span class="stage-number">2</span>' +
                                                '<span class="stage-name">å½±å“èŒƒå›´ä¸é£é™©è¯„ä¼°</span>' +
                                            '</div>' +
                                            '<div class="stage-item">' +
                                                '<span class="stage-number">3</span>' +
                                                '<span class="stage-name">ä¿®å¤æ–¹æ¡ˆä¸é˜²æŠ¤å»ºè®®</span>' +
                                            '</div>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="chat-input-container" data-container-mode="fixed">' +
                            '<div class="chat-input-wrapper">' +
                                '<textarea class="chat-input" placeholder="æ‚¨å¯ä»¥éšæ—¶å¹²é¢„ï¼Œæå‡ºå»ºè®®æˆ–è°ƒæ•´æ–¹å‘..." rows="3"></textarea>' +
                                '<div class="chat-input-toolbar">' +
                                    '<div class="chat-input-actions">' +
                                        '<button class="btn-icon" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>' +
                                        '<button class="btn-icon" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button>' +
                                        '<button class="btn-icon" title="æ’å…¥ä»£ç ">ğŸ’»</button>' +
                                        '<button class="btn-icon" title="æ’å…¥è¡¨æ ¼">ğŸ“Š</button>' +
                                    '</div>' +
                                    '<button class="btn btn-primary chat-send">' +
                                        '<span>å‘é€</span>' +
                                        '<span class="send-shortcut">Shift+Enter</span>' +
                                    '</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>';

                        chatArea.appendChild(taskContent);
                        taskContent.style.display = 'flex';

                        console.log('[DEBUG] ä»»åŠ¡è¯¦æƒ…å·²åˆ›å»ºå¹¶æ˜¾ç¤º');

                        // é‡æ–°åˆå§‹åŒ–èŠå¤©è¾“å…¥æ¡†ç»„ä»¶ï¼ˆå› ä¸ºHTMLè¢«æ›¿æ¢äº†ï¼‰
                        initChatInput({
                            selector: '.chat-input-container',
                            onSend: function(message) {
                                console.log('å‘é€æ¶ˆæ¯:', message);
                                // TODO: å®é™…å‘é€æ¶ˆæ¯åˆ°åç«¯
                            }
                        });

                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        setTimeout(function() {
                            var chatMessages = taskContent.querySelector('.chat-messages');
                            if (chatMessages) {
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        }, 100);
                    } catch (error) {
                        console.error('[DEBUG] é”™è¯¯:', error);
                    }
                },
                onViewAll: function() {
                    console.log('æŸ¥çœ‹å…¨éƒ¨ä»»åŠ¡');
                    showAllTasks();
                }
                });
            } else {
                console.warn('[DEBUG] initAgentSidebar å‡½æ•°ä¸å­˜åœ¨ï¼Œä»…ä½¿ç”¨æ‰‹åŠ¨ç»‘å®š');
            }

            // ç»‘å®šé™æ€ä»»åŠ¡é¡¹çš„ç‚¹å‡»äº‹ä»¶ï¼ˆåœ¨ initAgentSidebar ä¹‹åï¼Œç¡®ä¿èƒ½ç»‘å®šåˆ°æœ€ç»ˆçš„ä»»åŠ¡åˆ—è¡¨ï¼‰
            setTimeout(function() {
                bindTaskClickEvents();
            }, 100);

            // åˆå§‹åŒ–èŠå¤©è¾“å…¥æ¡†ç»„ä»¶
            initChatInput({
                onSend: function(message) {
                    console.log('å‘é€æ¶ˆæ¯:', message);
                    // æ¨¡æ‹Ÿå‘é€ï¼Œå®é™…åº”è¯¥è°ƒç”¨API
                    // window.location.href = 'agent-detail-chat.html';
                }
            });
        });

        // å¤„ç†ä»»åŠ¡ç‚¹å‡»çš„é€šç”¨å‡½æ•°ï¼ˆåœ¨ DOMContentLoaded å¤–éƒ¨å®šä¹‰ï¼‰
        function onTaskClickHandler(taskId, taskData) {
                console.log('[DEBUG] å¤„ç†ä»»åŠ¡ç‚¹å‡»:', taskId, taskData);

                try {
                    var chatArea = document.querySelector('.agent-main-content');
                    if (!chatArea) {
                        console.error('[DEBUG] æœªæ‰¾åˆ°chatArea');
                        return;
                    }

                    console.log('[DEBUG] æ‰¾åˆ°chatArea');

                    // æ¸…ç©ºchatAreaå†…å®¹ï¼Œé‡æ–°åˆ›å»ºä»»åŠ¡è¯¦æƒ…
                    var taskName = (taskData && taskData.name) ? taskData.name : 'æœªçŸ¥ä»»åŠ¡';

                    // æ£€æŸ¥æ˜¯å¦æ˜¯ CVE-2024-1234 æ¼æ´åˆ†æä»»åŠ¡ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºå·¦å³å¸ƒå±€
                    if (taskName.includes('CVE-2024-1234')) {
                        chatArea.innerHTML = generateVulnerabilityDetailLayout(taskData);
                        
                        // åˆå§‹åŒ–äº¤äº’åŠŸèƒ½
                        initVulnerabilityDetailInteractions(chatArea);
                        
                        // åˆå§‹åŒ–è¾“å…¥æ¡†åŠŸèƒ½ï¼ˆä½¿ç”¨chat-inputç»„ä»¶ï¼‰
                        initChatInput({
                            selector: '.vulnerability-interaction-panel .chat-input-container',
                            onSend: function(message) {
                                console.log('å‘é€æ¶ˆæ¯:', message);
                                // TODO: å®é™…å‘é€æ¶ˆæ¯åˆ°åç«¯
                                // è¿™é‡Œå¯ä»¥æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åˆ—è¡¨çš„é€»è¾‘
                            }
                        });
                        
                        return;
                    }

                    // æ¸…ç©ºchatAreaå¹¶é‡æ–°åˆ›å»ºä»»åŠ¡è¯¦æƒ…ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
                    chatArea.innerHTML = '';

                    var taskContent = document.createElement('div');
                    taskContent.className = 'task-detail-content';

                    // è·å–ä»»åŠ¡åˆ›å»ºæ—¶é—´ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                    var createTime = '14:30';
                    if (taskData && taskData.createTime) {
                        var timeParts = taskData.createTime.split(' ');
                        if (timeParts.length > 1) {
                            createTime = timeParts[1].substring(0, 5); // æå– HH:mm
                        }
                    }

                    // æ ¹æ®ä»»åŠ¡åç§°ç”Ÿæˆä»»åŠ¡åˆ›å»ºæ¶ˆæ¯
                    var taskCreateMessage = 'ä»»åŠ¡å·²åˆ›å»ºï¼š' + taskName.replace('æ¼æ´åˆ†æ', 'æ¼æ´çš„è¯¦ç»†ä¿¡æ¯å’Œå½±å“èŒƒå›´');
                    if (!taskCreateMessage.includes('æ¼æ´')) {
                        taskCreateMessage = 'ä»»åŠ¡å·²åˆ›å»ºï¼š' + taskName;
                    }
                    
                    // ä»ä»»åŠ¡åç§°ä¸­æå– CVE ç¼–å·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    var cveNumber = taskName.match(/CVE-\d{4}-\d+/)?.[0] || 'CVE-2024-1234';
                    var analysisTarget = taskName.includes('CVE') ? cveNumber : taskName;

                    taskContent.innerHTML = '<div class="chat-header">' +
                        '<div class="chat-title">' + taskName + '</div>' +
                        '<div class="chat-time">' + (taskData && taskData.createTime ? taskData.createTime.split(' ')[0] : 'åˆšåˆš') + '</div>' +
                    '</div>' +
                    '<div class="chat-messages" id="chatMessages">' +
                        '<!-- ç³»ç»Ÿæ¶ˆæ¯ - ä»»åŠ¡åˆ›å»º -->' +
                        '<div class="message message-system">' +
                            '<div class="message-avatar">ğŸ¯</div>' +
                            '<div class="message-content">' +
                                '<div class="message-time">' + createTime + '</div>' +
                                '<div class="message-text">' + taskCreateMessage + '</div>' +
                            '</div>' +
                        '</div>' +
                        '<!-- ä»»åŠ¡æ„å›¾è¯†åˆ« -->' +
                        '<div class="message message-ai">' +
                            '<div class="message-avatar">ğŸ¤–</div>' +
                            '<div class="message-content">' +
                                '<div class="message-time">' + createTime + '</div>' +
                                '<div class="intent-card">' +
                                    '<div class="intent-header">' +
                                        '<span class="intent-icon">ğŸ’¬</span>' +
                                        '<span class="intent-title">ä»»åŠ¡æ„å›¾è¯†åˆ«</span>' +
                                    '</div>' +
                                    '<div class="intent-content">' +
                                        '<p><strong>ä»»åŠ¡ç±»å‹ï¼š</strong>æ¼æ´æƒ…æŠ¥åˆ†æ</p>' +
                                        '<p><strong>åˆ†æå¯¹è±¡ï¼š</strong>' + analysisTarget + '</p>' +
                                        '<p><strong>é¢„æœŸç›®æ ‡ï¼š</strong>è¯†åˆ«æ¼æ´è¯¦æƒ…ã€è¯„ä¼°å½±å“èŒƒå›´ã€æä¾›ä¿®å¤å»ºè®®</p>' +
                                    '</div>' +
                                '</div>' +
                                '<!-- ä»»åŠ¡è§„åˆ’ -->' +
                                '<div class="planning-card">' +
                                    '<div class="planning-header">' +
                                        '<span class="planning-icon">ğŸ“‹</span>' +
                                        '<span class="planning-title">ä»»åŠ¡æ‰§è¡Œè§„åˆ’</span>' +
                                    '</div>' +
                                    '<div class="planning-stages">' +
                                        '<div class="stage-item">' +
                                            '<span class="stage-number">1</span>' +
                                            '<span class="stage-name">æ¼æ´åŸºæœ¬ä¿¡æ¯æŸ¥è¯¢</span>' +
                                        '</div>' +
                                        '<div class="stage-item">' +
                                            '<span class="stage-number">2</span>' +
                                            '<span class="stage-name">å½±å“èŒƒå›´ä¸é£é™©è¯„ä¼°</span>' +
                                        '</div>' +
                                        '<div class="stage-item">' +
                                            '<span class="stage-number">3</span>' +
                                            '<span class="stage-name">ä¿®å¤æ–¹æ¡ˆä¸é˜²æŠ¤å»ºè®®</span>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="chat-input-container" data-container-mode="fixed">' +
                        '<div class="chat-input-wrapper">' +
                            '<textarea class="chat-input" placeholder="æ‚¨å¯ä»¥éšæ—¶å¹²é¢„ï¼Œæå‡ºå»ºè®®æˆ–è°ƒæ•´æ–¹å‘..." rows="3"></textarea>' +
                            '<div class="chat-input-toolbar">' +
                                '<div class="chat-input-actions">' +
                                    '<button class="btn-icon" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>' +
                                    '<button class="btn-icon" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button>' +
                                    '<button class="btn-icon" title="æ’å…¥ä»£ç ">ğŸ’»</button>' +
                                    '<button class="btn-icon" title="æ’å…¥è¡¨æ ¼">ğŸ“Š</button>' +
                                '</div>' +
                                '<button class="btn btn-primary chat-send">' +
                                    '<span>å‘é€</span>' +
                                    '<span class="send-shortcut">Shift+Enter</span>' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>';

                    chatArea.appendChild(taskContent);
                    taskContent.style.display = 'flex';

                    console.log('[DEBUG] ä»»åŠ¡è¯¦æƒ…å·²åˆ›å»ºå¹¶æ˜¾ç¤º');

                    // é‡æ–°åˆå§‹åŒ–èŠå¤©è¾“å…¥æ¡†ç»„ä»¶ï¼ˆå› ä¸ºHTMLè¢«æ›¿æ¢äº†ï¼‰
                    initChatInput({
                        selector: '.chat-input-container',
                        onSend: function(message) {
                            console.log('å‘é€æ¶ˆæ¯:', message);
                            // TODO: å®é™…å‘é€æ¶ˆæ¯åˆ°åç«¯
                        }
                    });

                    // æ»šåŠ¨åˆ°åº•éƒ¨
                    setTimeout(function() {
                        var chatMessages = taskContent.querySelector('.chat-messages');
                        if (chatMessages) {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }
                    }, 100);
                } catch (error) {
                    console.error('[DEBUG] é”™è¯¯:', error);
                }
        }

        // æ‰‹åŠ¨ç»‘å®šé™æ€ä»»åŠ¡é¡¹çš„ç‚¹å‡»äº‹ä»¶å‡½æ•°ï¼ˆåœ¨ DOMContentLoaded å¤–éƒ¨å®šä¹‰ï¼‰
        function bindTaskClickEvents() {
            var taskItems = document.querySelectorAll('.recent-task-item');
            console.log('[DEBUG] æ‰¾åˆ°ä»»åŠ¡é¡¹æ•°é‡:', taskItems.length);
            
            taskItems.forEach(function(item, index) {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var taskName = item.querySelector('.task-name');
                    if (!taskName) {
                        console.error('[DEBUG] æœªæ‰¾åˆ°ä»»åŠ¡åç§°å…ƒç´ ');
                        return;
                    }
                    var taskNameText = taskName.textContent.trim();
                    console.log('[DEBUG] ç‚¹å‡»ä»»åŠ¡:', taskNameText);
                    
                    // ç§»é™¤æ‰€æœ‰ä»»åŠ¡é¡¹çš„activeçŠ¶æ€
                    var allItems = document.querySelectorAll('.recent-task-item');
                    allItems.forEach(function(taskItem) {
                        taskItem.classList.remove('active');
                    });
                    
                    // ä¸ºå½“å‰ç‚¹å‡»çš„ä»»åŠ¡é¡¹æ·»åŠ activeçŠ¶æ€
                    item.classList.add('active');
                    
                    // æŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡æ•°æ®
                    var taskData = mockTasks.find(function(task) {
                        return task.name === taskNameText;
                    });
                    
                    if (!taskData) {
                        // å¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„ä»»åŠ¡æ•°æ®
                        var statusIcon = item.querySelector('.task-status-icon');
                        var status = statusIcon && statusIcon.classList.contains('completed') ? 'completed' : 
                                     statusIcon && statusIcon.classList.contains('running') ? 'running' : 'pending';
                        taskData = { 
                            id: String(mockTasks.length + 1), 
                            name: taskNameText, 
                            status: status,
                            createTime: new Date().toISOString().split('T')[0] + ' 14:30'
                        };
                    }
                    
                    console.log('[DEBUG] ä»»åŠ¡æ•°æ®:', taskData);
                    
                    // ç›´æ¥è°ƒç”¨å¤„ç†å‡½æ•°
                    onTaskClickHandler(taskData.id, taskData);
                });
            });
        }

        // æ˜¾ç¤ºå…¨éƒ¨ä»»åŠ¡åˆ—è¡¨
        function showAllTasks() {
            var chatArea = document.querySelector('.agent-main-content');
            if (!chatArea) return;

            // ç”Ÿæˆä»»åŠ¡åˆ—è¡¨HTML
            var tasksHtml = '';
            for (var i = 0; i < mockTasks.length; i++) {
                var task = mockTasks[i];
                var statusIcon = task.status === 'running' ? 'â³' :
                                task.status === 'completed' ? 'âœ…' : 'âŒ';
                var statusClass = task.status;

                tasksHtml += '<div class="task-record-card" data-task-id="' + task.id + '">' +
                    '<div class="task-record-left">' +
                        '<div class="task-record-header">' +
                            '<div class="task-record-status">' +
                                '<span class="task-status-badge ' + statusClass + '">' + statusIcon + '</span>' +
                            '</div>' +
                            '<div class="task-record-name">' + task.name + '</div>' +
                        '</div>' +
                        '<div class="task-record-statistics">' +
                            '<span class="statistics-label">æ¶ˆæ¯æ•°</span>' +
                            '<span class="statistics-value">' + (4 + Math.floor(Math.random() * 6)) + ' æ¡</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="task-record-right">' +
                        '<div class="task-record-time">2025-12-19 14:30</div>' +
                        '<div class="task-record-actions">' +
                            '<button class="task-action-btn">æŸ¥çœ‹</button>' +
                            '<button class="task-action-btn">åˆ é™¤</button>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }

            if (mockTasks.length === 0) {
                tasksHtml = '<div class="tasks-empty">æš‚æ— ä»»åŠ¡è®°å½•</div>';
            }

            // æ›¿æ¢å†…å®¹
            chatArea.innerHTML = '<div class="tasks-list-container">' +
                '<div class="tasks-list-header">' +
                    '<h2 class="tasks-list-title">å…¨éƒ¨ä»»åŠ¡è®°å½•</h2>' +
                '</div>' +
                '<div class="tasks-list-content">' +
                    tasksHtml +
                '</div>' +
            '</div>';

            // ç»‘å®šä»»åŠ¡å¡ç‰‡ç‚¹å‡»äº‹ä»¶
            var taskCards = chatArea.querySelectorAll('.task-record-card');
            for (var i = 0; i < taskCards.length; i++) {
                taskCards[i].addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è§¦å‘å¡ç‰‡ç‚¹å‡»
                    if (e.target.classList.contains('task-action-btn')) {
                        e.stopPropagation();
                        var btnText = e.target.textContent;
                        var taskId = this.getAttribute('data-task-id');

                        if (btnText === 'æŸ¥çœ‹') {
                            // æŸ¥æ‰¾å¯¹åº”çš„ä»»åŠ¡å¹¶æ˜¾ç¤ºè¯¦æƒ…
                            var selectedTask = null;
                            for (var j = 0; j < mockTasks.length; j++) {
                                if (mockTasks[j].id === taskId) {
                                    selectedTask = mockTasks[j];
                                    break;
                                }
                            }

                            if (selectedTask) {
                                // è°ƒç”¨ç°æœ‰çš„ä»»åŠ¡ç‚¹å‡»å›è°ƒ
                                var sidebarInstance = window.agentSidebarInstance;
                                if (sidebarInstance && sidebarInstance.setActiveTask) {
                                    sidebarInstance.setActiveTask(taskId);
                                }

                                // æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…ï¼ˆå¤ç”¨ä¹‹å‰çš„ä»£ç ï¼‰
                                showTaskDetailById(taskId, selectedTask);
                            }
                        } else if (btnText === 'åˆ é™¤') {
                            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ')) {
                                console.log('åˆ é™¤ä»»åŠ¡:', taskId);
                            }
                        }
                        return;
                    }

                    // ç‚¹å‡»å¡ç‰‡å…¶ä»–åŒºåŸŸï¼Œæ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
                    var taskId = this.getAttribute('data-task-id');
                    var selectedTask = null;
                    for (var j = 0; j < mockTasks.length; j++) {
                        if (mockTasks[j].id === taskId) {
                            selectedTask = mockTasks[j];
                            break;
                        }
                    }

                    if (selectedTask) {
                        showTaskDetailById(taskId, selectedTask);
                    }
                });
            }
        }

        // æ ¹æ®ä»»åŠ¡IDæ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
        function showTaskDetailById(taskId, taskData) {
            var chatArea = document.querySelector('.agent-main-content');
            if (!chatArea) return;

            var taskName = taskData ? taskData.name : 'æœªçŸ¥ä»»åŠ¡';

            // æ£€æŸ¥æ˜¯å¦æ˜¯ CVE-2024-1234 æ¼æ´åˆ†æä»»åŠ¡ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºå·¦å³å¸ƒå±€
            if (taskName.includes('CVE-2024-1234')) {
                chatArea.innerHTML = generateVulnerabilityDetailLayout(taskData);
                
                // åˆå§‹åŒ–äº¤äº’åŠŸèƒ½
                initVulnerabilityDetailInteractions(chatArea);
                
                // åˆå§‹åŒ–è¾“å…¥æ¡†åŠŸèƒ½ï¼ˆä½¿ç”¨chat-inputç»„ä»¶ï¼‰
                initChatInput({
                    selector: '.vulnerability-interaction-panel .chat-input-container',
                    onSend: function(message) {
                        console.log('å‘é€æ¶ˆæ¯:', message);
                        // TODO: å®é™…å‘é€æ¶ˆæ¯åˆ°åç«¯
                        // è¿™é‡Œå¯ä»¥æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åˆ—è¡¨çš„é€»è¾‘
                    }
                });
                
                return;
            }

            var taskContent = document.createElement('div');
            taskContent.className = 'task-detail-content';

            // è·å–ä»»åŠ¡åˆ›å»ºæ—¶é—´ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
            var createTime = '14:30';
            if (taskData && taskData.createTime) {
                var timeParts = taskData.createTime.split(' ');
                if (timeParts.length > 1) {
                    createTime = timeParts[1].substring(0, 5); // æå– HH:mm
                }
            }

            // æ ¹æ®ä»»åŠ¡åç§°ç”Ÿæˆä»»åŠ¡åˆ›å»ºæ¶ˆæ¯
            var taskCreateMessage = 'ä»»åŠ¡å·²åˆ›å»ºï¼š' + taskName.replace('æ¼æ´åˆ†æ', 'æ¼æ´çš„è¯¦ç»†ä¿¡æ¯å’Œå½±å“èŒƒå›´');
            if (!taskCreateMessage.includes('æ¼æ´')) {
                taskCreateMessage = 'ä»»åŠ¡å·²åˆ›å»ºï¼š' + taskName;
            }
            
            // ä»ä»»åŠ¡åç§°ä¸­æå– CVE ç¼–å·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            var cveNumber = taskName.match(/CVE-\d{4}-\d+/)?.[0] || 'CVE-2024-1234';
            var analysisTarget = taskName.includes('CVE') ? cveNumber : taskName;

            taskContent.innerHTML = '<div class="chat-header">' +
                '<div class="chat-title">' + taskName + '</div>' +
                '<div class="chat-time">' + (taskData && taskData.createTime ? taskData.createTime.split(' ')[0] : 'åˆšåˆš') + '</div>' +
            '</div>' +
            '<div class="chat-messages" id="chatMessages">' +
                '<!-- ç³»ç»Ÿæ¶ˆæ¯ - ä»»åŠ¡åˆ›å»º -->' +
                '<div class="message message-system">' +
                    '<div class="message-avatar">ğŸ¯</div>' +
                    '<div class="message-content">' +
                        '<div class="message-time">' + createTime + '</div>' +
                        '<div class="message-text">' + taskCreateMessage + '</div>' +
                    '</div>' +
                '</div>' +
                '<!-- ä»»åŠ¡æ„å›¾è¯†åˆ« -->' +
                '<div class="message message-ai">' +
                    '<div class="message-avatar">ğŸ¤–</div>' +
                    '<div class="message-content">' +
                        '<div class="message-time">' + createTime + '</div>' +
                        '<div class="intent-card">' +
                            '<div class="intent-header">' +
                                '<span class="intent-icon">ğŸ’¬</span>' +
                                '<span class="intent-title">ä»»åŠ¡æ„å›¾è¯†åˆ«</span>' +
                            '</div>' +
                            '<div class="intent-content">' +
                                '<p><strong>ä»»åŠ¡ç±»å‹ï¼š</strong>æ¼æ´æƒ…æŠ¥åˆ†æ</p>' +
                                '<p><strong>åˆ†æå¯¹è±¡ï¼š</strong>' + analysisTarget + '</p>' +
                                '<p><strong>é¢„æœŸç›®æ ‡ï¼š</strong>è¯†åˆ«æ¼æ´è¯¦æƒ…ã€è¯„ä¼°å½±å“èŒƒå›´ã€æä¾›ä¿®å¤å»ºè®®</p>' +
                            '</div>' +
                        '</div>' +
                        '<!-- ä»»åŠ¡è§„åˆ’ -->' +
                        '<div class="planning-card">' +
                            '<div class="planning-header">' +
                                '<span class="planning-icon">ğŸ“‹</span>' +
                                '<span class="planning-title">ä»»åŠ¡æ‰§è¡Œè§„åˆ’</span>' +
                            '</div>' +
                            '<div class="planning-stages">' +
                                '<div class="stage-item">' +
                                    '<span class="stage-number">1</span>' +
                                    '<span class="stage-name">æ¼æ´åŸºæœ¬ä¿¡æ¯æŸ¥è¯¢</span>' +
                                '</div>' +
                                '<div class="stage-item">' +
                                    '<span class="stage-number">2</span>' +
                                    '<span class="stage-name">å½±å“èŒƒå›´ä¸é£é™©è¯„ä¼°</span>' +
                                '</div>' +
                                '<div class="stage-item">' +
                                    '<span class="stage-number">3</span>' +
                                    '<span class="stage-name">ä¿®å¤æ–¹æ¡ˆä¸é˜²æŠ¤å»ºè®®</span>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<div class="chat-input-container" data-container-mode="fixed">' +
                '<div class="chat-input-wrapper">' +
                    '<textarea class="chat-input" placeholder="æ‚¨å¯ä»¥éšæ—¶å¹²é¢„ï¼Œæå‡ºå»ºè®®æˆ–è°ƒæ•´æ–¹å‘..." rows="3"></textarea>' +
                    '<div class="chat-input-toolbar">' +
                        '<div class="chat-input-actions">' +
                            '<button class="btn-icon" title="ä¸Šä¼ æ–‡ä»¶">ğŸ“</button>' +
                            '<button class="btn-icon" title="æ’å…¥å›¾ç‰‡">ğŸ–¼ï¸</button>' +
                            '<button class="btn-icon" title="æ’å…¥ä»£ç ">ğŸ’»</button>' +
                            '<button class="btn-icon" title="æ’å…¥è¡¨æ ¼">ğŸ“Š</button>' +
                        '</div>' +
                        '<button class="btn btn-primary chat-send">' +
                            '<span>å‘é€</span>' +
                            '<span class="send-shortcut">Shift+Enter</span>' +
                        '</button>' +
                    '</div>' +
                '</div>' +
            '</div>';

            chatArea.innerHTML = '';
            chatArea.appendChild(taskContent);
            taskContent.style.display = 'flex';

            // é‡æ–°åˆå§‹åŒ–èŠå¤©è¾“å…¥æ¡†ç»„ä»¶ï¼ˆå› ä¸ºHTMLè¢«æ›¿æ¢äº†ï¼‰
            initChatInput({
                selector: '.chat-input-container',
                onSend: function(message) {
                    console.log('å‘é€æ¶ˆæ¯:', message);
                    // TODO: å®é™…å‘é€æ¶ˆæ¯åˆ°åç«¯
                }
            });

            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(function() {
                var chatMessages = taskContent.querySelector('.chat-messages');
                if (chatMessages) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }, 100);
        }

        // å¿«é€Ÿæç¤ºå¡«å……åŠŸèƒ½
        function fillPrompt(text) {
            const input = document.getElementById('chatInput');
            if (input) {
                input.value = text;
                input.focus();
            }
        }
    </script>
</body>
</html>

