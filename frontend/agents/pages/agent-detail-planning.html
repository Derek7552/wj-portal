<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="智能体详情 - 自规划模式">
    <title>智能体详情 - 自规划 | 云脑</title>
    <link rel="stylesheet" href="../../css/common.css">
    <link rel="stylesheet" href="../../css/dashboard.css">
    <link rel="stylesheet" href="../css/agent-detail.css">
    <link rel="stylesheet" href="../css/agent-detail-planning.css">
</head>
<body class="agent-detail-page agent-detail-planning-page">
    <!-- 左侧主导航栏 - 智能体详情页模式（收起） -->
    <aside class="sidebar collapsed" id="sidebar">
        <!-- Logo 区 -->
        <div class="sidebar-logo">
            <a href="../../dashboard.html" class="logo-link" title="云脑">
                <div class="logo-icon">
                    <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" rx="6" fill="#2563EB"/>
                        <path d="M16 8L20 14H12L16 8Z" fill="white"/>
                        <path d="M10 18L14 24H6L10 18Z" fill="white" opacity="0.8"/>
                        <path d="M22 18L26 24H18L22 18Z" fill="white" opacity="0.8"/>
                    </svg>
                </div>
                <h1 class="logo-text">云脑</h1>
            </a>
        </div>

        <!-- 主导航菜单 -->
        <div class="sidebar-content">
            <nav class="sidebar-nav">
                <!-- 首页 - 带收藏快捷入口 -->
                <div class="nav-item-home-wrapper">
                    <a href="../../dashboard.html" class="nav-item nav-item-home" title="首页">
                        <span class="nav-icon">🏠</span>
                        <span class="nav-text">首页</span>
                    </a>
                    <div class="home-menu" id="homeMenu">
                        <a href="../../dashboard.html" class="home-menu-favorite-item">
                            <span class="home-menu-favorite-icon">🏠</span>
                            <span class="home-menu-favorite-name">首页</span>
                        </a>
                        <div class="home-menu-favorites" id="homeMenuFavorites">
                            <div class="home-menu-favorites-empty" id="homeMenuFavoritesEmpty" style="display: none;">
                                <p class="home-menu-empty-text">暂无收藏</p>
                            </div>
                            <div class="home-menu-favorites-list" id="homeMenuFavoritesList"></div>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- 底部导航 -->
            <nav class="sidebar-nav-bottom">
                <a href="../../templates.html" class="nav-item" title="UI模板">
                    <span class="nav-icon">📐</span>
                    <span class="nav-text">UI模板</span>
                </a>

                <a href="#" class="nav-item" title="帮助中心">
                    <span class="nav-icon">❓</span>
                    <span class="nav-text">帮助中心</span>
                </a>

                <a href="#" class="nav-item" title="用户反馈">
                    <span class="nav-icon">💬</span>
                    <span class="nav-text">用户反馈</span>
                </a>

                <div class="nav-item-user-wrapper">
                    <a href="#" class="nav-item nav-item-user" id="userNavItem" title="个人中心">
                        <div class="user-avatar" id="userAvatar">T</div>
                        <span class="user-name" id="userName">测试用户</span>
                    </a>
                    <div class="user-menu" id="userMenu">
                        <a href="#" class="user-menu-item">
                            <span class="nav-icon">👤</span>
                            <span class="nav-text">个人中心</span>
                        </a>
                        <button class="user-menu-item nav-item-logout" id="logoutBtn">
                            <span class="nav-icon">🚪</span>
                            <span class="nav-text">退出登录</span>
                        </button>
                    </div>
                </div>
            </nav>
        </div>
    </aside>

    <!-- 主内容区 -->
    <main class="main-content-area">
        <!-- 智能体头部信息 -->
        <div class="agent-header">
            <div class="agent-header-main">
                <div class="agent-icon">🎯</div>
                <div class="agent-info">
                    <div class="agent-title-wrapper">
                        <h2 class="agent-title">自规划任务执行助手</h2>
                        <span class="agent-type">高级类</span>
                        <span class="agent-version">v2.0.0</span>
                    </div>
                    <p class="agent-description">智能分解复杂任务，自主规划执行步骤，实时反馈进度，支持人工干预和调整</p>
                </div>
            </div>
            <!-- 管理功能按钮组 -->
            <div class="agent-header-actions">
                <button class="btn-agent-action" title="知识库">
                    <span class="action-icon">📚</span>
                    <span class="action-text">知识库</span>
                    <span class="action-count">(156)</span>
                </button>
                <button class="btn-agent-action" title="工具插件">
                    <span class="action-icon">🔧</span>
                    <span class="action-text">工具插件</span>
                    <span class="action-count">(23)</span>
                </button>
                <button class="btn-agent-action" title="智能体设置">
                    <span class="action-icon">⚙️</span>
                    <span class="action-text">设置</span>
                </button>
                <button class="btn btn-primary btn-sm">
                    <span>🔗</span>
                    <span>分享</span>
                </button>
            </div>
        </div>

        <!-- 内容容器 -->
        <div class="content-container">
            <!-- 智能体详情侧导航 -->
            <aside class="agent-sidebar">
                <nav class="agent-nav">
                    <!-- 新任务按钮 -->
                    <button class="btn-new-chat" id="btnNewTask">
                        <span class="btn-icon">✨</span>
                        <span class="btn-text">新任务</span>
                    </button>

                    <!-- 近期任务 -->
                    <div class="nav-group">
                        <div class="nav-group-title">近期任务</div>

                        <!-- 近期任务列表 -->
                        <div class="recent-tasks-list">
                            <a href="#" class="recent-task-item active"
                               data-task-id="1"
                               data-task-name="开发用户认证系统"
                               data-task-status="running">
                                <span class="task-status-icon running">⏳</span>
                                <div class="task-name">开发用户认证系统</div>
                            </a>

                            <a href="#" class="recent-task-item"
                               data-task-id="2"
                               data-task-name="数据分析报告生成"
                               data-task-status="completed">
                                <span class="task-status-icon completed">✅</span>
                                <div class="task-name">数据分析报告生成</div>
                            </a>

                            <a href="#" class="recent-task-item"
                               data-task-id="3"
                               data-task-name="API接口文档编写"
                               data-task-status="completed">
                                <span class="task-status-icon completed">✅</span>
                                <div class="task-name">API接口文档编写</div>
                            </a>

                            <a href="#" class="recent-task-item"
                               data-task-id="4"
                               data-task-name="前端性能优化"
                               data-task-status="failed">
                                <span class="task-status-icon failed">❌</span>
                                <div class="task-name">前端性能优化</div>
                            </a>

                            <a href="#" class="recent-task-item"
                               data-task-id="5"
                               data-task-name="数据库优化方案"
                               data-task-status="completed">
                                <span class="task-status-icon completed">✅</span>
                                <div class="task-name">数据库优化方案</div>
                            </a>
                        </div>

                        <!-- 查看全部任务入口 -->
                        <a href="#" class="view-all-tasks" id="viewAllTasks">
                            查看全部任务记录 →
                        </a>
                    </div>
                </nav>
            </aside>

            <!-- 主要内容区域 -->
            <div class="agent-main-content">
                <!-- 空状态 - 新任务输入 -->
                <div class="empty-state-container" id="emptyStateContainer" style="display: none;">
                    <!-- 智能体名称 -->
                    <div class="empty-agent-name">
                        <span class="agent-name-text">自规划任务执行助手</span>
                    </div>

                    <!-- 引导文案 -->
                    <div class="empty-state-guide">
                        <p class="empty-state-guide-text">开始创建新任务</p>
                    </div>

                    <!-- 输入区域 -->
                    <div class="chat-input-container">
                        <div class="chat-input-wrapper">
                            <!-- 输入框区域 -->
                            <textarea
                                class="chat-input"
                                id="newTaskInput"
                                placeholder="描述您的任务需求，AI将自动分解并规划执行步骤..."
                                rows="5"
                            ></textarea>

                            <!-- 工具栏：左侧操作按钮 + 右侧发送按钮 -->
                            <div class="chat-input-toolbar">
                                <div class="chat-input-actions">
                                    <button class="btn-icon" title="上传文件">
                                        📎
                                    </button>
                                    <button class="btn-icon" title="插入图片">
                                        🖼️
                                    </button>
                                    <button class="btn-icon" title="插入代码">
                                        💻
                                    </button>
                                </div>
                                <button class="btn btn-primary chat-send" id="createTaskBtn">
                                    <span>创建任务</span>
                                    <span class="send-shortcut">Shift+Enter</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 任务详情容器 -->
                <div class="task-details-container" id="taskDetailsContainer" style="display: flex; flex-direction: column; height: 100%;">
                    <!-- 任务名称和时间（参考快速对话助手示例） -->
                    <div class="chat-task-name">
                        <span class="task-name-text">开发用户认证系统</span>
                        <span class="task-time">2024-12-09 14:30</span>
                    </div>

                <!-- 对话区和右侧面板的容器 - 左右布局 -->
                <div class="content-with-sidebar" style="display: flex !important; flex-direction: row !important; gap: 16px; flex: 1; min-height: 0; overflow: hidden;">
                    <!-- 对话记录区域 -->
                    <div class="task-content-area" id="dialogArea" style="flex: 1; display: flex; flex-direction: column; min-height: 0; min-width: 0;">
                        <div class="messages-container" id="messagesContainer" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
                        <!-- 系统消息 -->
                        <div class="message message-system">
                            <div class="message-avatar">🎯</div>
                            <div class="message-content">
                                <div class="message-time">2024-12-09 14:30</div>
                                <div class="message-bubble">
                                    <p>任务已创建：代码漏洞挖掘分析</p>
                                    <p>我已识别任务类型为漏洞挖掘，正在规划执行方案...</p>
                                </div>
                            </div>
                        </div>

                        <!-- AI消息 - 任务类型意图识别规划 -->
                        <div class="message message-ai">
                            <div class="message-avatar">🤖</div>
                            <div class="message-content">
                                <div class="message-time">2024-12-09 14:31</div>
                                <div class="message-bubble">
                                    <div class="task-phase">
                                        <div class="phase-header">
                                            <span class="phase-number">意图识别</span>
                                            <span class="phase-title">任务类型识别与规划</span>
                                            <span class="phase-status completed">已完成</span>
                                        </div>

                                        <!-- 思考推理 -->
                                        <div class="phase-section">
                                            <div class="section-header">
                                                <span class="section-icon">💭</span>
                                                <span class="section-title">思考推理</span>
                                            </div>
                                            <div class="section-content">
                                                <p>分析任务描述："请对项目进行安全漏洞挖掘分析"</p>
                                                <p>识别任务类型：</p>
                                                <ul>
                                                    <li>关键词匹配：漏洞挖掘、安全分析、代码审计</li>
                                                    <li>任务特征：需要深入分析代码、识别安全风险、生成报告</li>
                                                    <li>任务类型：<strong>漏洞挖掘任务</strong></li>
                                                </ul>
                                                <p>规划执行策略：采用三阶段分析法（工程分析 → 威胁建模 → 总结报告）</p>
                                            </div>
                                        </div>

                                        <!-- 任务执行 -->
                                        <div class="phase-section">
                                            <div class="section-header">
                                                <span class="section-icon">⚙️</span>
                                                <span class="section-title">任务执行</span>
                                            </div>
                                            <div class="section-content">
                                                <div class="execution-step">
                                                    <span class="step-icon completed">✓</span>
                                                    <span class="step-text">解析任务描述，提取关键信息</span>
                                                </div>
                                                <div class="execution-step">
                                                    <span class="step-icon completed">✓</span>
                                                    <span class="step-text">匹配任务类型为漏洞挖掘</span>
                                                </div>
                                                <div class="execution-step">
                                                    <span class="step-icon completed">✓</span>
                                                    <span class="step-text">规划三阶段执行方案</span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 结果发现 -->
                                        <div class="phase-section">
                                            <div class="section-header">
                                                <span class="section-icon">📊</span>
                                                <span class="section-title">结果发现</span>
                                            </div>
                                            <div class="section-content">
                                                <p><strong>任务类型：</strong>漏洞挖掘分析</p>
                                                <p><strong>执行方案：</strong>三阶段分析法</p>
                                                <ul>
                                                    <li>阶段1：工程功能模块分析</li>
                                                    <li>阶段2：威胁建模与漏洞分析</li>
                                                    <li>阶段3：分析总结报告生成</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI消息 - 阶段1：工程功能模块分析 -->
                        <div class="message message-ai">
                            <div class="message-avatar">🤖</div>
                            <div class="message-content">
                                <div class="message-time">2024-12-09 14:32</div>
                                <div class="message-bubble">
                                    <div class="task-phase completed">
                                        <div class="phase-header">
                                            <span class="phase-number">阶段 1</span>
                                            <span class="phase-title">工程功能模块分析</span>
                                            <span class="phase-status completed">已完成</span>
                                        </div>

                                        <!-- 交替输出的事件流 -->
                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">💭</span>
                                                <div class="event-content">
                                                    <p>分析工程结构：需要全面了解项目的功能模块、技术栈、依赖关系。</p>
                                                    <p>分析策略：</p>
                                                    <ul>
                                                        <li>扫描项目目录结构，识别主要功能模块</li>
                                                        <li>分析代码文件，理解业务逻辑</li>
                                                        <li>识别关键入口点和数据流</li>
                                                        <li>梳理功能模块间的交互关系</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="文件系统读取工具"
                                                         data-log-id="tool-001">
                                                        <span class="tool-name">文件系统读取工具</span>
                                                        <span class="tool-result">✓ 已读取项目根目录结构</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">💭</span>
                                                <div class="event-content">
                                                    <p>识别到项目采用Node.js技术栈，主要包含用户认证、数据管理、文件上传等核心模块。</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="文件系统读取工具"
                                                         data-log-id="tool-002">
                                                        <span class="tool-name">文件系统读取工具</span>
                                                        <span class="tool-result">✓ 已读取 src/ 目录下的所有文件</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">📋</span>
                                                <div class="event-content">
                                                    <p><strong>项目结构：</strong></p>
                                                    <ul>
                                                        <li>技术栈：Node.js + Express.js + MongoDB</li>
                                                        <li>主要模块：用户认证、数据管理、API接口、文件上传</li>
                                                        <li>关键文件：app.js（主入口）、routes/auth.js（认证路由）、controllers/userController.js（用户控制器）</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="代码分析工具"
                                                         data-log-id="tool-003">
                                                        <span class="tool-name">代码分析工具</span>
                                                        <span class="tool-result">✓ 已分析主要代码文件（app.js, routes/, controllers/）</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">📋</span>
                                                <div class="event-content">
                                                    <p><strong>功能模块：</strong></p>
                                                    <ul>
                                                        <li>用户认证模块：注册、登录、JWT令牌管理</li>
                                                        <li>数据管理模块：CRUD操作、数据验证</li>
                                                        <li>文件上传模块：文件存储、文件类型验证</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="依赖分析工具"
                                                         data-log-id="tool-004">
                                                        <span class="tool-name">依赖分析工具</span>
                                                        <span class="tool-result">✓ 已分析 package.json，识别依赖库</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">📄</span>
                                                <div class="event-content">
                                                    <div class="vulnerability-output">
                                                        <div class="output-item clickable-log-item" 
                                                             data-log-type="file" 
                                                             data-file-name="工程功能总结.md"
                                                             data-log-id="file-001">
                                                            <span class="output-icon">📝</span>
                                                            <span class="output-name">工程功能总结.md</span>
                                                            <span class="output-meta">2.3 KB</span>
                                                        </div>
                                                        <div class="output-item clickable-log-item" 
                                                             data-log-type="file" 
                                                             data-file-name="工程功能记忆文件.md"
                                                             data-log-id="file-002">
                                                            <span class="output-icon">🧠</span>
                                                            <span class="output-name">工程功能记忆文件.md</span>
                                                            <span class="output-meta">3.1 KB</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI消息 - 阶段2：威胁建模与漏洞分析 -->
                        <div class="message message-ai">
                            <div class="message-avatar">🤖</div>
                            <div class="message-content">
                                <div class="message-time">2024-12-09 14:45</div>
                                <div class="message-bubble">
                                    <div class="task-phase running">
                                        <div class="phase-header">
                                            <span class="phase-number">阶段 2</span>
                                            <span class="phase-title">威胁建模与漏洞分析</span>
                                            <span class="phase-status running">执行中</span>
                                        </div>

                                        <!-- 交替输出的事件流 -->
                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">💭</span>
                                                <div class="event-content">
                                                    <p>威胁建模：基于功能模块分析，识别潜在安全威胁点。</p>
                                                    <p>分析重点：</p>
                                                    <ul>
                                                        <li>用户输入验证：SQL注入、XSS、命令注入风险</li>
                                                        <li>认证授权：JWT令牌验证、会话管理、权限控制</li>
                                                        <li>文件上传：文件类型验证、路径遍历、文件包含</li>
                                                        <li>数据存储：敏感信息加密、数据泄露风险</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="工程记忆文件读取"
                                                         data-log-id="tool-005">
                                                        <span class="tool-name">工程记忆文件读取</span>
                                                        <span class="tool-result">✓ 已读取工程功能记忆文件.md</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="代码扫描工具"
                                                         data-log-id="tool-006">
                                                        <span class="tool-name">代码扫描工具</span>
                                                        <span class="tool-result running">▶ 正在扫描 routes/auth.js 中的认证逻辑...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">💭</span>
                                                <div class="event-content">
                                                    <p>发现认证逻辑中可能存在JWT签名验证不完整的问题，需要进一步检查。</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="漏洞检测工具"
                                                         data-log-id="tool-007">
                                                        <span class="tool-name">漏洞检测工具</span>
                                                        <span class="tool-result running">▶ 正在检测 SQL 注入风险...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">📋</span>
                                                <div class="event-content">
                                                    <p>初步分析发现：routes/user.js 第45行存在SQL注入风险，用户输入未进行验证。</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="工程记忆文件编辑"
                                                         data-log-id="tool-008">
                                                        <span class="tool-name">工程记忆文件编辑</span>
                                                        <span class="tool-result">✓ 已更新工程记忆文件，记录发现的潜在漏洞</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 并行分析任务队列 -->
                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔄</span>
                                                <div class="event-content">
                                            <div class="section-content">
                                                <!-- 队列统计摘要 -->
                                                <div class="queue-summary">
                                                    <div class="summary-item">
                                                        <span class="summary-label">总任务数</span>
                                                        <span class="summary-value">15</span>
                                                    </div>
                                                    <div class="summary-item running">
                                                        <span class="summary-label">运行中</span>
                                                        <span class="summary-value">5</span>
                                                    </div>
                                                    <div class="summary-item completed">
                                                        <span class="summary-label">已完成</span>
                                                        <span class="summary-value">8</span>
                                                    </div>
                                                    <div class="summary-item pending">
                                                        <span class="summary-label">等待中</span>
                                                        <span class="summary-value">2</span>
                                                    </div>
                                                </div>

                                                <!-- 运行中任务组 -->
                                                <div class="task-group">
                                                    <div class="task-group-header">
                                                        <h4 class="task-group-title">
                                                            <span class="group-icon running">▶</span>
                                                            运行中任务 (5)
                                                        </h4>
                                                    </div>
                                                    <div class="parallel-tasks-queue">
                                                        <div class="parallel-task-card running">
                                                            <div class="task-card-header">
                                                                <div class="task-card-title">
                                                                    <span class="task-status-icon">▶</span>
                                                                    <span class="task-name">任务 #1：SQL注入漏洞分析</span>
                                                                </div>
                                                                <span class="task-status-badge running">运行中</span>
                                                            </div>
                                                            <div class="task-card-info">
                                                                <span class="task-info-item">⏱️ 已执行 1m 20s</span>
                                                                <span class="task-info-item">📊 步骤 2/3</span>
                                                            </div>
                                                        </div>
                                                        <div class="parallel-task-card running">
                                                            <div class="task-card-header">
                                                                <div class="task-card-title">
                                                                    <span class="task-status-icon">▶</span>
                                                                    <span class="task-name">任务 #2：XSS漏洞分析</span>
                                                                </div>
                                                                <span class="task-status-badge running">运行中</span>
                                                            </div>
                                                            <div class="task-card-info">
                                                                <span class="task-info-item">⏱️ 已执行 45s</span>
                                                                <span class="task-info-item">📊 步骤 1/3</span>
                                                            </div>
                                                        </div>
                                                        <div class="parallel-task-card running">
                                                            <div class="task-card-header">
                                                                <div class="task-card-title">
                                                                    <span class="task-status-icon">▶</span>
                                                                    <span class="task-name">任务 #3：JWT令牌验证分析</span>
                                                                </div>
                                                                <span class="task-status-badge running">运行中</span>
                                                            </div>
                                                            <div class="task-card-info">
                                                                <span class="task-info-item">⏱️ 已执行 2m 10s</span>
                                                                <span class="task-info-item">📊 步骤 3/4</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="task-group-footer">
                                                        <span class="more-tasks-indicator">还有 2 个运行中任务...</span>
                                                    </div>
                                                </div>

                                                <!-- 已完成任务组 -->
                                                <div class="task-group">
                                                    <div class="task-group-header">
                                                        <h4 class="task-group-title">
                                                            <span class="group-icon completed">✓</span>
                                                            已完成任务 (8)
                                                        </h4>
                                                    </div>
                                                    <div class="parallel-tasks-queue">
                                                        <div class="parallel-task-card completed">
                                                            <div class="task-card-header">
                                                                <div class="task-card-title">
                                                                    <span class="task-status-icon">✓</span>
                                                                    <span class="task-name">任务 #9：文件上传漏洞分析</span>
                                                                </div>
                                                                <span class="task-status-badge completed">已完成</span>
                                                            </div>
                                                            <div class="task-card-info">
                                                                <span class="task-info-item">⏱️ 耗时 3m 15s</span>
                                                                <span class="task-info-item">📊 步骤 4/4</span>
                                                            </div>
                                                        </div>
                                                        <div class="parallel-task-card completed">
                                                            <div class="task-card-header">
                                                                <div class="task-card-title">
                                                                    <span class="task-status-icon">✓</span>
                                                                    <span class="task-name">任务 #10：权限控制分析</span>
                                                                </div>
                                                                <span class="task-status-badge completed">已完成</span>
                                                            </div>
                                                            <div class="task-card-info">
                                                                <span class="task-info-item">⏱️ 耗时 2m 30s</span>
                                                                <span class="task-info-item">📊 步骤 3/3</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="task-group-footer">
                                                        <span class="more-tasks-indicator">还有 6 个已完成任务...</span>
                                                    </div>
                                                </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">📄</span>
                                                <div class="event-content">
                                                    <div class="vulnerability-output">
                                                        <div class="output-item clickable-log-item" 
                                                             data-log-type="file" 
                                                             data-file-name="漏洞报告-001.md"
                                                             data-log-id="file-003">
                                                            <span class="output-icon">🔒</span>
                                                            <span class="output-name">漏洞报告-001.md</span>
                                                            <span class="output-meta">高危 · 1.2 KB</span>
                                                        </div>
                                                        <div class="output-item clickable-log-item" 
                                                             data-log-type="file" 
                                                             data-file-name="漏洞报告-002.md"
                                                             data-log-id="file-004">
                                                            <span class="output-icon">⚠️</span>
                                                            <span class="output-name">漏洞报告-002.md</span>
                                                            <span class="output-meta">中危 · 0.8 KB</span>
                                                        </div>
                                                        <div class="output-item clickable-log-item" 
                                                             data-log-type="file" 
                                                             data-file-name="工程记忆文件.md"
                                                             data-log-id="file-005">
                                                            <span class="output-icon">🧠</span>
                                                            <span class="output-name">工程记忆文件.md</span>
                                                            <span class="output-meta">已更新 · 4.5 KB</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">📊</span>
                                                <div class="event-content">
                                                    <p><strong>已发现漏洞统计：</strong></p>
                                                    <ul>
                                                        <li>高危漏洞：2 个（SQL注入、JWT令牌伪造）</li>
                                                        <li>中危漏洞：3 个（XSS、文件上传、权限绕过）</li>
                                                        <li>低危漏洞：3 个（信息泄露、弱加密、日志泄露）</li>
                                                    </ul>
                                                    <p><strong>风险分布：</strong></p>
                                                    <ul>
                                                        <li>认证授权模块：高风险（JWT验证不严格）</li>
                                                        <li>数据输入模块：高风险（SQL注入风险）</li>
                                                        <li>文件处理模块：中风险（文件类型验证不足）</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI消息 - 阶段3：分析总结报告生成 -->
                        <div class="message message-ai">
                            <div class="message-avatar">🤖</div>
                            <div class="message-content">
                                <div class="message-time">2024-12-09 15:20</div>
                                <div class="message-bubble">
                                    <div class="task-phase running">
                                        <div class="phase-header">
                                            <span class="phase-number">阶段 3</span>
                                            <span class="phase-title">分析总结报告生成</span>
                                            <span class="phase-status running">执行中</span>
                                        </div>

                                        <!-- 交替输出的事件流 -->
                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">💭</span>
                                                <div class="event-content">
                                                    <p>整合分析结果：需要汇总所有阶段的发现，生成综合报告。</p>
                                                    <p>报告结构：</p>
                                                    <ul>
                                                        <li>分析概览：项目概况、分析范围、分析方法</li>
                                                        <li>核心发现：关键漏洞、风险等级、影响范围</li>
                                                        <li>关键文件：漏洞位置、代码片段、修复建议</li>
                                                        <li>总结建议：整体风险评估、修复优先级</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="工程记忆文件读取"
                                                         data-log-id="tool-009">
                                                        <span class="tool-name">工程记忆文件读取</span>
                                                        <span class="tool-result">✓ 已读取工程功能记忆文件.md</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="漏洞报告读取"
                                                         data-log-id="tool-010">
                                                        <span class="tool-name">漏洞报告读取</span>
                                                        <span class="tool-result">✓ 已读取所有漏洞报告文件</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">📋</span>
                                                <div class="event-content">
                                                    <p>已汇总8个漏洞，包括2个高危、3个中危、3个低危漏洞。需要生成综合分析报告。</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">🔧</span>
                                                <div class="event-content">
                                                    <div class="tool-call clickable-log-item" 
                                                         data-log-type="tool" 
                                                         data-tool-name="报告生成工具"
                                                         data-log-id="tool-011">
                                                        <span class="tool-name">报告生成工具</span>
                                                        <span class="tool-result running">▶ 正在生成综合分析报告...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="phase-section">
                                            <div class="phase-event">
                                                <span class="event-icon">📄</span>
                                                <div class="event-content">
                                                    <div class="vulnerability-output">
                                                        <div class="output-item clickable-log-item" 
                                                             data-log-type="file" 
                                                             data-file-name="工程总结报告.md"
                                                             data-log-id="file-006">
                                                            <span class="output-icon">📊</span>
                                                            <span class="output-name">工程总结报告.md</span>
                                                            <span class="output-meta">生成中 · 预计 5.2 KB</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI消息 - 最终回复：分析概览与核心发现 -->
                        <div class="message message-ai">
                            <div class="message-avatar">🤖</div>
                            <div class="message-content">
                                <div class="message-time">2024-12-09 15:25</div>
                                <div class="message-bubble">
                                    <p><strong>漏洞挖掘分析完成</strong></p>
                                    
                                    <div class="final-summary">
                                        <h4>📊 分析概览</h4>
                                        <ul>
                                            <li><strong>项目类型：</strong>Node.js Web应用</li>
                                            <li><strong>分析范围：</strong>3个主要功能模块，15个潜在漏洞点</li>
                                            <li><strong>分析方法：</strong>静态代码分析 + 威胁建模</li>
                                            <li><strong>分析耗时：</strong>53分钟</li>
                                        </ul>

                                        <h4>🔍 漏洞统计表</h4>
                                        <div class="vulnerability-table-container">
                                            <table class="vulnerability-table">
                                                <thead>
                                                    <tr>
                                                        <th>漏洞类型</th>
                                                        <th>数量</th>
                                                        <th>风险等级</th>
                                                        <th>影响范围</th>
                                                        <th>修复优先级</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr class="severity-high">
                                                        <td>SQL注入</td>
                                                        <td>1</td>
                                                        <td><span class="severity-badge high">高危</span></td>
                                                        <td>数据库安全</td>
                                                        <td><span class="priority-badge p1">P1</span></td>
                                                    </tr>
                                                    <tr class="severity-high">
                                                        <td>JWT令牌伪造</td>
                                                        <td>1</td>
                                                        <td><span class="severity-badge high">高危</span></td>
                                                        <td>身份认证</td>
                                                        <td><span class="priority-badge p1">P1</span></td>
                                                    </tr>
                                                    <tr class="severity-medium">
                                                        <td>XSS跨站脚本</td>
                                                        <td>1</td>
                                                        <td><span class="severity-badge medium">中危</span></td>
                                                        <td>用户数据安全</td>
                                                        <td><span class="priority-badge p2">P2</span></td>
                                                    </tr>
                                                    <tr class="severity-medium">
                                                        <td>文件上传漏洞</td>
                                                        <td>1</td>
                                                        <td><span class="severity-badge medium">中危</span></td>
                                                        <td>服务器安全</td>
                                                        <td><span class="priority-badge p2">P2</span></td>
                                                    </tr>
                                                    <tr class="severity-medium">
                                                        <td>权限绕过</td>
                                                        <td>1</td>
                                                        <td><span class="severity-badge medium">中危</span></td>
                                                        <td>访问控制</td>
                                                        <td><span class="priority-badge p2">P2</span></td>
                                                    </tr>
                                                    <tr class="severity-low">
                                                        <td>信息泄露</td>
                                                        <td>2</td>
                                                        <td><span class="severity-badge low">低危</span></td>
                                                        <td>敏感信息</td>
                                                        <td><span class="priority-badge p3">P3</span></td>
                                                    </tr>
                                                    <tr class="severity-low">
                                                        <td>弱加密</td>
                                                        <td>1</td>
                                                        <td><span class="severity-badge low">低危</span></td>
                                                        <td>数据加密</td>
                                                        <td><span class="priority-badge p3">P3</span></td>
                                                    </tr>
                                                </tbody>
                                                <tfoot>
                                                    <tr>
                                                        <td><strong>总计</strong></td>
                                                        <td><strong>8</strong></td>
                                                        <td colspan="3">
                                                            <span class="summary-stats">
                                                                <span class="stat-item high">高危: 2</span>
                                                                <span class="stat-item medium">中危: 3</span>
                                                                <span class="stat-item low">低危: 3</span>
                                                            </span>
                                                        </td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>

                                        <h4>📝 分析总结</h4>
                                        <div class="summary-text">
                                            <p>本次代码漏洞挖掘分析已完成，通过静态代码分析和威胁建模方法，对项目进行了全面的安全评估。分析覆盖了3个主要功能模块（用户认证、数据管理、文件上传），共识别出<strong>8个潜在安全漏洞</strong>，其中<strong>高危漏洞2个</strong>、<strong>中危漏洞3个</strong>、<strong>低危漏洞3个</strong>。</p>
                                            
                                            <p>从漏洞分布来看，<strong>认证授权模块</strong>存在较高风险，特别是JWT令牌验证机制不完整，可能导致身份伪造攻击。<strong>数据交互模块</strong>存在SQL注入风险，需要立即修复。文件上传功能缺乏严格的类型验证，存在被利用上传恶意文件的风险。</p>
                                            
                                            <p><strong>建议优先修复P1级别的高危漏洞</strong>，包括SQL注入和JWT令牌伪造问题。同时加强输入验证机制，对所有用户输入进行严格校验和转义处理。建议建立完善的权限控制体系，确保敏感操作都有适当的权限检查。</p>
                                        </div>

                                        <h4>📁 关键文档</h4>
                                        <div class="document-cards">
                                            <div class="document-card clickable-log-item" 
                                                 data-log-type="file" 
                                                 data-file-name="漏洞报告-001.md"
                                                 data-log-id="file-003">
                                                <div class="document-card-header">
                                                    <span class="document-icon">🔒</span>
                                                    <span class="document-title">漏洞报告-001.md</span>
                                                </div>
                                                <div class="document-meta">
                                                    <span class="document-size">1.2 KB</span>
                                                    <span class="document-severity high">高危</span>
                                                </div>
                                                <div class="document-description">包含2个高危漏洞的详细分析报告</div>
                                            </div>

                                            <div class="document-card clickable-log-item" 
                                                 data-log-type="file" 
                                                 data-file-name="漏洞报告-002.md"
                                                 data-log-id="file-004">
                                                <div class="document-card-header">
                                                    <span class="document-icon">⚠️</span>
                                                    <span class="document-title">漏洞报告-002.md</span>
                                                </div>
                                                <div class="document-meta">
                                                    <span class="document-size">0.8 KB</span>
                                                    <span class="document-severity medium">中危</span>
                                                </div>
                                                <div class="document-description">包含3个中危漏洞的详细分析报告</div>
                                            </div>

                                            <div class="document-card clickable-log-item" 
                                                 data-log-type="file" 
                                                 data-file-name="工程总结报告.md"
                                                 data-log-id="file-006">
                                                <div class="document-card-header">
                                                    <span class="document-icon">📊</span>
                                                    <span class="document-title">工程总结报告.md</span>
                                                </div>
                                                <div class="document-meta">
                                                    <span class="document-size">5.2 KB</span>
                                                    <span class="document-status generating">生成中</span>
                                                </div>
                                                <div class="document-description">综合分析报告，包含所有漏洞和修复建议</div>
                                            </div>

                                            <div class="document-card clickable-log-item" 
                                                 data-log-type="file" 
                                                 data-file-name="工程功能记忆文件.md"
                                                 data-log-id="file-005">
                                                <div class="document-card-header">
                                                    <span class="document-icon">🧠</span>
                                                    <span class="document-title">工程功能记忆文件.md</span>
                                                </div>
                                                <div class="document-meta">
                                                    <span class="document-size">4.5 KB</span>
                                                    <span class="document-status updated">已更新</span>
                                                </div>
                                                <div class="document-description">项目功能分析和漏洞记录的记忆文件</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- messages-container结束 -->

                    <!-- 输入区域（固定在对话区底部） -->
                    <div class="chat-input-container" style="flex-shrink: 0;">
                        <div class="chat-input-wrapper">
                            <!-- 输入框区域 -->
                            <textarea
                                class="chat-input"
                                id="messageInput"
                                placeholder="您可以随时干预，提出建议或调整方向..."
                                rows="3"
                            ></textarea>

                            <!-- 工具栏：左侧操作按钮 + 右侧发送按钮 -->
                            <div class="chat-input-toolbar">
                                <div class="chat-input-actions">
                                    <button class="btn-icon" title="上传文件">📎</button>
                                    <button class="btn-icon" title="插入图片">🖼️</button>
                                    <button class="btn-icon" title="插入代码">💻</button>
                                    <button class="btn-icon" title="插入表格">📊</button>
                                </div>
                                <button class="btn btn-primary chat-send" id="sendMessage">
                                    <span>发送</span>
                                    <span class="send-shortcut">Shift+Enter</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- task-content-area对话记录区域结束 -->

                <!-- 右侧面板 -->
                <aside class="task-sidebar" style="flex-shrink: 0; display: flex; flex-direction: column; min-height: 0;">
                        <!-- Tab切换 -->
                        <div class="sidebar-tabs">
                            <button class="sidebar-tab active" data-sidebar-tab="files">
                                <span class="tab-icon">📁</span>
                                <span class="tab-text">文件</span>
                                <span class="tab-badge">3</span>
                            </button>
                            <button class="sidebar-tab" data-sidebar-tab="logs">
                                <span class="tab-icon">📋</span>
                                <span class="tab-text">日志</span>
                            </button>
                        </div>

                        <!-- 文件Tab内容 -->
                        <div class="sidebar-content" id="filesTab">
                            <!-- 文件目录树 -->
                            <div class="file-tree">
                                <!-- vulnex 目录 -->
                                <div class="file-tree-item file-tree-folder expanded">
                                    <div class="file-tree-header" data-folder="vulnex">
                                        <span class="file-tree-icon">📁</span>
                                        <span class="file-tree-name">vulnex</span>
                                    </div>
                                    <div class="file-tree-children">
                                        <!-- 项目记忆目录 -->
                                        <div class="file-tree-item file-tree-folder expanded">
                                            <div class="file-tree-header" data-folder="memory">
                                                <span class="file-tree-icon">📁</span>
                                                <span class="file-tree-name">项目记忆</span>
                                            </div>
                                            <div class="file-tree-children">
                                                <div class="file-tree-item file-tree-file">
                                                    <span class="file-tree-name">工程功能记忆文件.md</span>
                                                    <span class="file-tree-meta">3.1 KB</span>
                                                    <button class="btn-file-action" title="下载">⬇️</button>
                                                </div>
                                                <div class="file-tree-item file-tree-file">
                                                    <span class="file-tree-name">工程记忆文件.md</span>
                                                    <span class="file-tree-meta">4.5 KB</span>
                                                    <button class="btn-file-action" title="下载">⬇️</button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- 漏洞报告目录 -->
                                        <div class="file-tree-item file-tree-folder expanded">
                                            <div class="file-tree-header" data-folder="vulnerabilities">
                                                <span class="file-tree-icon">📁</span>
                                                <span class="file-tree-name">漏洞报告</span>
                                            </div>
                                            <div class="file-tree-children">
                                                <div class="file-tree-item file-tree-file">
                                                    <span class="file-tree-name">漏洞报告-001.md</span>
                                                    <span class="file-tree-meta">1.2 KB</span>
                                                    <button class="btn-file-action" title="下载">⬇️</button>
                                                </div>
                                                <div class="file-tree-item file-tree-file">
                                                    <span class="file-tree-name">漏洞报告-002.md</span>
                                                    <span class="file-tree-meta">0.8 KB</span>
                                                    <button class="btn-file-action" title="下载">⬇️</button>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- 总结报告目录 -->
                                        <div class="file-tree-item file-tree-folder expanded">
                                            <div class="file-tree-header" data-folder="summary">
                                                <span class="file-tree-icon">📁</span>
                                                <span class="file-tree-name">总结报告</span>
                                            </div>
                                            <div class="file-tree-children">
                                                <div class="file-tree-item file-tree-file">
                                                    <span class="file-tree-name">工程总结报告.md</span>
                                                    <span class="file-tree-meta">5.2 KB</span>
                                                    <button class="btn-file-action" title="下载">⬇️</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- user 目录 -->
                                <div class="file-tree-item file-tree-folder expanded">
                                    <div class="file-tree-header" data-folder="user">
                                        <span class="file-tree-icon">📁</span>
                                        <span class="file-tree-name">user</span>
                                    </div>
                                    <div class="file-tree-children">
                                        <div class="file-tree-item file-tree-file">
                                            <span class="file-tree-name">project.zip</span>
                                            <span class="file-tree-meta">2.5 MB</span>
                                            <button class="btn-file-action" title="下载">⬇️</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 上传文件区域 -->
                            <div class="sidebar-section" style="margin-top: 16px;">
                                <div class="sidebar-section-title">
                                    <span>上传文件</span>
                                </div>
                                <div class="upload-area">
                                    <input type="file" id="fileInput" multiple style="display: none;">
                                    <button class="btn-upload" id="btnUpload">
                                        <span class="upload-icon">📤</span>
                                        <span class="upload-text">点击上传</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 日志Tab内容(默认隐藏) -->
                        <div class="sidebar-content" id="logsTab" style="display: none;">
                            <div class="logs-container">
                                <div class="logs-empty-state" id="logsEmptyState">
                                    <div class="empty-state-icon">📋</div>
                                    <div class="empty-state-text">点击对话中的工具调用或文件查看详细日志</div>
                                </div>
                                <div class="logs-content" id="logsContent" style="display: none;">
                                    <div class="log-header">
                                        <div class="log-title" id="logTitle"></div>
                                        <button class="btn-close-log" id="btnCloseLog" title="关闭">✕</button>
                                    </div>
                                    <div class="log-body" id="logBody">
                                        <!-- 日志内容将动态插入 -->
                                    </div>
                                </div>
                            </div>
                        </div>

                    </aside>
                </div>
                <!-- 对话区和右侧面板的容器结束 -->

            </div>
            <!-- 任务详情容器结束 -->
            </div>
        </div>
    </main>

    <script src="../../js/dashboard.js"></script>
    <script src="../js/agent-detail-planning.js"></script>
</body>
</html>
