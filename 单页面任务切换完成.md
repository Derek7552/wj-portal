# ✅ 单页面任务切换完成

## 🎯 需求

用户希望所有任务详情都在 **template-planning.html** 页面内查看，不要跳转到其他页面。

---

## 📝 修改内容

### 1. 移除所有任务的跨页面链接

**文件**: `frontend/templates/js/template-planning.js`

**修改前**:
```javascript
// task-002 链接到异常页面，task-001 回到主页面
let href = '#';
if (task.id === 'task-002') {
    href = 'template-planning-error.html';
} else if (task.id === 'task-001') {
    href = 'template-planning.html';
}
```

**修改后**:
```javascript
// 所有任务都使用 # 作为href，通过JS加载详情
return `
    <a href="#" class="recent-task-item" data-task-id="${task.id}">
        <span class="task-status-icon ${task.status}">${icon}</span>
        <div class="task-name">${task.name}</div>
    </a>
`;
```

---

### 2. 简化点击事件逻辑

**修改前**:
```javascript
// 判断是否需要跨页面跳转
const needsNavigation = href && href !== '#' && !currentPage.includes(href);

if (needsNavigation) {
    return; // 允许跳转
}

e.preventDefault();
loadTaskDetail(taskId);
```

**修改后**:
```javascript
// 所有任务都在当前页面加载详情
e.preventDefault();

// 移除其他任务的active状态
taskItems.forEach(t => t.classList.remove('active'));

// 添加当前任务的active状态
this.classList.add('active');

// 加载任务详情
loadTaskDetail(taskId);
```

---

### 3. 移除 task-002 的跳转逻辑

**修改前**:
```javascript
function loadTaskDetail(taskId) {
    // 特殊处理：task-002 跳转到异常页面
    if (taskId === 'task-002') {
        window.location.href = 'template-planning-error.html';
        return;
    }

    // 查找任务数据...
}
```

**修改后**:
```javascript
function loadTaskDetail(taskId) {
    // 查找任务数据
    const task = mockTasks.find(t => t.id === taskId);

    // 根据不同任务ID加载不同内容
    if (taskId === 'task-001') {
        taskDetailHTML = getTask001FullContent();
    } else if (taskId === 'task-002') {
        taskDetailHTML = getTask002ErrorContent(); // 在当前页面加载异常详情
    } else {
        // 其他任务...
    }
}
```

---

### 4. 新增 task-002 异常详情函数

**新增函数**: `getTask002ErrorContent()`

**包含内容**:
- ✅ 任务头部（标题 + "系统异常" 徽章）
- ✅ 任务创建消息
- ✅ 任务意图识别卡片
- ✅ 任务执行规划（3个阶段）
- ✅ 阶段1：工程功能模块分析（已完成）
- ✅ 阶段2：威胁建模与漏洞分析（异常终止）
  - 发现的漏洞
  - 错误提示卡片
- ✅ 最终回复：任务异常终止说明
- ✅ 禁用的输入框（任务已终止）

---

### 5. 添加错误状态CSS引用

**文件**: `frontend/templates/pages/template-planning.html`

**新增**:
```html
<link rel="stylesheet" href="../css/template-planning-error-states.css">
```

---

## 🎯 现在的效果

### 主页面 (template-planning.html)

**侧导航**:
```
✨ 新任务

近期任务
  ✅ 代码安全漏洞挖掘任务
  ❌ 源代码漏洞挖掘任务

查看全部任务记录 →
```

**点击行为**:

| 点击任务 | 行为 |
|---------|------|
| 代码安全漏洞挖掘任务 | ✅ 在当前页面加载成功详情 |
| 源代码漏洞挖掘任务 | ✅ 在当前页面加载异常详情 |

**特点**:
- ✅ **不跳转页面**，所有任务在同一页面查看
- ✅ 点击任务时高亮显示（active状态）
- ✅ 异常任务显示完整的错误信息
- ✅ 输入框根据任务状态启用/禁用

---

## 📊 异常任务详情展示

点击"源代码漏洞挖掘任务"后，在当前页面显示：

```
┌─────────────────────────────────────────┐
│ 源代码漏洞挖掘任务  [系统异常]          │
├─────────────────────────────────────────┤
│ 🎯 任务已创建                           │
│                                         │
│ 🎯 任务意图识别                         │
│   - 任务类型: 源代码漏洞挖掘            │
│   - 分析对象: Web应用项目               │
│   - 预期目标: 识别安全漏洞              │
│                                         │
│ 📋 任务执行规划                         │
│   1. 工程功能模块分析                   │
│   2. 威胁建模与漏洞分析                 │
│   3. 分析总结报告生成                   │
│                                         │
│ ✓ 阶段 1: 工程功能模块分析（已完成）    │
│   💭 开始分析项目结构...                │
│   📄 生成工程功能模块分析总结           │
│                                         │
│ ❌ 阶段 2: 威胁建模与漏洞分析（异常终止）│
│   💭 开始进行威胁建模...                │
│   ⚠️ 发现 SQL注入漏洞 [高危]            │
│   ⚠️ 系统异常                           │
│      错误类型: 内存溢出异常             │
│      错误信息: 内存资源不足             │
│                                         │
│ ❌ 任务异常终止                         │
│   已完成的工作:                         │
│   - ✓ 完成工程功能模块分析              │
│   - ✓ 发现 1 个高危漏洞                 │
│   异常原因:                             │
│   - 内存溢出，系统资源不足              │
├─────────────────────────────────────────┤
│ [输入框已禁用]                          │
│ 任务已终止，您可以重新创建任务...       │
└─────────────────────────────────────────┘
```

---

## 🧪 测试步骤

### 1. 刷新页面
```
Ctrl + Shift + R (Windows/Linux)
Cmd + Shift + R (Mac)
```

### 2. 测试 task-001（代码安全漏洞挖掘任务）

1. 点击"代码安全漏洞挖掘任务"
2. ✅ 页面**不跳转**
3. ✅ 在当前页面右侧加载成功任务详情
4. ✅ 侧导航该任务高亮显示
5. ✅ 控制台输出: `📄 加载task-001详情`

### 3. 测试 task-002（源代码漏洞挖掘任务）

1. 点击"源代码漏洞挖掘任务"
2. ✅ 页面**不跳转**
3. ✅ 在当前页面右侧加载异常任务详情
4. ✅ 显示"系统异常"徽章
5. ✅ 显示完整的错误信息和已完成的工作
6. ✅ 输入框被禁用
7. ✅ 侧导航该任务高亮显示
8. ✅ 控制台输出: `📄 加载task-002详情`

### 4. 测试任务切换

1. 先点击"源代码漏洞挖掘任务"
2. 再点击"代码安全漏洞挖掘任务"
3. ✅ 侧导航高亮从task-002切换到task-001
4. ✅ 右侧内容从异常详情切换到成功详情
5. ✅ 输入框从禁用变为启用

---

## 📂 修改文件清单

### frontend/templates/js/template-planning.js
1. ✅ 简化 `renderTaskList()` - 所有任务href都为"#"
2. ✅ 简化点击事件 - 统一调用loadTaskDetail
3. ✅ 移除 task-002 的跳转逻辑
4. ✅ 新增 `getTask002ErrorContent()` 函数（约200行）
5. ✅ 修改 `loadTaskDetail()` - 根据taskId调用不同的内容函数

### frontend/templates/pages/template-planning.html
1. ✅ 新增错误状态CSS引用

---

## ✨ 优势

1. **统一体验**: 所有任务在同一页面查看，无页面跳转
2. **状态保持**: 切换任务时侧导航高亮跟随
3. **完整展示**: 异常任务显示完整的错误信息和已完成工作
4. **视觉反馈**: 错误状态使用红色主题，清晰易辨
5. **交互友好**: 异常任务自动禁用输入框，提示用户任务已终止

---

## 🚮 可删除的文件（可选）

**template-planning-error.html** 现在不再需要了，因为：
- 所有任务都在 template-planning.html 中查看
- task-002 的异常详情通过JS动态生成
- 如果想保留作为独立的错误页面展示，也可以保留

---

**修复时间**: 2025-12-24
**状态**: ✅ 已完成
**可以测试**: 立即可用

请刷新页面测试！🎉
